<!-- src/app/applications/components/new-application/opportunity-application.component.html - FIXED -->
<div class="max-w-6xl mx-auto">
  <!-- Enhanced Header -->
  <div class="mb-10 mt-10 border-b border-neutral-200 pb-6">
    <div class="flex items-center justify-between">
      <!-- Left side: Back + Title -->
      <div class="flex items-center space-x-4">
        <ui-button 
          variant="outline" 
          size="sm" 
          (click)="goBack()" 
          class="flex items-center hover:scale-105 transition-transform"
        >
          <lucide-icon [img]="ArrowLeftIcon" [size]="16" class="mr-2" />
          Back
        </ui-button>
      </div>

      <!-- Right side: Save Draft -->
      <div>
        <ui-button 
          variant="outline" 
          size="sm" 
          (click)="saveDraft()" 
          [disabled]="isSaving()"
          class="hover:scale-105 transition-transform"
        >
          @if (isSaving()) {
            <lucide-icon [img]="ClockIcon" [size]="16" class="mr-2 animate-spin" />
            Saving...
          } @else {
            Save Draft
          }
        </ui-button>
      </div>
    </div>
  </div>

  <!-- Enhanced Progress Steps -->
  <div class="mb-8">
    <div class="flex items-center justify-between w-full">
      @for (step of steps(); track step.id) {
        <div class="flex items-center flex-1 group">
          <!-- Step Circle and Content -->
          <div class="flex items-center">
            <div [class]="getStepClasses(step.id)" class="transition-all duration-300 group-hover:scale-110">
              {{ step.number }}
            </div>
            <div class="ml-3">
              <p [class]="getStepTextClasses(step.id)" class="font-medium transition-colors">{{ step.title }}</p>
              <p class="text-xs text-neutral-500">{{ step.description }}</p>
            </div>
          </div>
          
          <!-- Animated Connector Line (except for last step) -->
          @if (step.id !== 'review-submit') {
            <div class="flex-1 h-0.5 bg-neutral-200 mx-8 relative overflow-hidden">
              <div class="absolute inset-0 h-full bg-gradient-to-r from-primary-400 to-primary-600"></div>
            </div>
          }
        </div>
      }
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <!-- Enhanced Main Content -->
    <div class="lg:col-span-2">
      <ui-card class="hover:shadow-lg transition-shadow duration-300">
        @if (error()) {
          <div class="mb-6 bg-red-50 border border-red-200 rounded-lg p-4 animate-pulse">
            <div class="flex items-center">
              <lucide-icon [img]="AlertCircleIcon" [size]="20" class="text-red-600 mr-2" />
              <span class="text-red-800">{{ error() }}</span>
            </div>
          </div>
        }

        @switch (currentStep()) {
          @case ('select-opportunity') {
            <div class="space-y-6">
              <div class="flex items-center space-x-3 mb-6">
                <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg flex items-center justify-center shadow-lg">
                  <lucide-icon [img]="BuildingIcon" [size]="20" class="text-white" />
                </div>
                <div>
                  <h3 class="text-lg font-semibold text-neutral-900">Select Funding Opportunity</h3>
                  <p class="text-sm text-neutral-600">Choose the opportunity you want to apply for</p>
                </div>
              </div>

              @if (isLoading()) {
                <div class="text-center py-12">
                  <div class="animate-spin w-8 h-8 border-2 border-primary-500 border-t-transparent rounded-full mx-auto mb-4"></div>
                  <p class="text-neutral-500">Loading opportunities...</p>
                </div>
              } @else if (availableOpportunities().length === 0) {
                <div class="text-center py-12">
                  <div class="w-16 h-16 bg-neutral-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <lucide-icon [img]="AlertCircleIcon" [size]="24" class="text-neutral-400" />
                  </div>
                  <p class="text-neutral-500 mb-4">No active opportunities available at the moment.</p>
                  <ui-button variant="outline" (click)="goBack()" class="hover:scale-105 transition-transform">
                    Browse Opportunities
                  </ui-button>
                </div>
              } @else {
                <div class="space-y-4">
                  @for (opportunity of availableOpportunities(); track opportunity.id) {
                    <div 
                      class="border rounded-lg p-4 cursor-pointer transition-all duration-300 hover:border-primary-300 hover:shadow-md hover:scale-[1.02]"
                      [class.border-primary-500]="selectedOpportunity()?.id === opportunity.id"
                      [class.bg-gradient-to-r]="selectedOpportunity()?.id === opportunity.id"
                      [class.from-primary-50]="selectedOpportunity()?.id === opportunity.id"
                      [class.to-primary-100]="selectedOpportunity()?.id === opportunity.id"
                      [class.shadow-lg]="selectedOpportunity()?.id === opportunity.id"
                      (click)="selectOpportunity(opportunity)"
                    >
                      <div class="flex justify-between items-start">
                        <div class="flex-1">
                          <h4 class="font-medium text-neutral-900">{{ opportunity.title }}</h4>
                          <p class="text-sm text-neutral-600 mt-1">{{ opportunity.shortDescription }}</p>
                          <div class="flex items-center space-x-4 mt-2 text-sm text-neutral-500">
                            <span class="capitalize px-2 py-1 bg-neutral-100 rounded-full">{{ opportunity.fundingType }}</span>
                            <span>{{ formatCurrency(opportunity.minInvestment) }} - {{ formatCurrency(opportunity.maxInvestment) }}</span>
                            <span>{{ getOrganizationName(opportunity) }}</span>
                          </div>
                        </div>
                        @if (selectedOpportunity()?.id === opportunity.id) {
                          <lucide-icon [img]="CheckCircleIcon" [size]="20" class="text-primary-600 ml-4" />
                        }
                      </div>
                    </div>
                  }
                </div>
              }
            </div>
          }

          @case ('application-details') {
         <div class="space-y-8">
  <div class="flex items-center space-x-3 mb-6">
    <div class="w-10 h-10 bg-gradient-to-br from-slate-500 to-slate-600 rounded-lg flex items-center justify-center shadow-lg">
      <lucide-icon [img]="FileTextIcon" [size]="20" class="text-white" />
    </div>
    <div>
      <h3 class="text-lg font-semibold text-neutral-900">Application Details</h3>
      <p class="text-sm text-neutral-600">Provide information specific to this opportunity</p>
    </div>
  </div>

  <!-- Requested Amount - Full Width -->
  <div class="group">
    <label class="block text-sm font-medium text-neutral-700 mb-3 group-hover:text-primary-600 transition-colors">
      Requested Amount <span class="text-red-500">*</span>
    </label>
    <div class="relative">
      <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
        <span class="text-neutral-500 font-medium">{{ selectedOpportunity()?.currency || 'ZAR' }}</span>
      </div>
      <input
        type="number"
        placeholder="0"
        [value]="coverInformation().requestedAmount"
        (input)="onRequestedAmountChange($event)"
        [min]="selectedOpportunity()?.minInvestment"
        [max]="selectedOpportunity()?.maxInvestment"
        class="block w-full pl-16 pr-4 py-4 text-lg border-2 border-neutral-300 rounded-xl shadow-sm placeholder-neutral-400 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-all hover:border-neutral-400 font-medium"
      />
    </div>
    @if (getAmountValidationMessage()) {
      <p class="mt-2 text-sm text-red-600 animate-pulse flex items-center">
        <lucide-icon [img]="AlertCircleIcon" [size]="16" class="mr-1" />
        {{ getAmountValidationMessage() }}
      </p>
    } @else {
      <p class="mt-2 text-sm text-neutral-500 flex items-center">
        <lucide-icon [img]="DollarSignIcon" [size]="16" class="mr-1 text-green-600" />
        Range: {{ formatCurrency(selectedOpportunity()?.minInvestment || 0) }} - {{ formatCurrency(selectedOpportunity()?.maxInvestment || 0) }}
      </p>
    }
  </div>

  <!-- Two Column Layout for Main Text Areas -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
    
    <!-- Purpose Statement -->
    <div class="group">
      <label class="block text-sm font-medium text-neutral-700 mb-3 group-hover:text-primary-600 transition-colors">
        Purpose Statement <span class="text-red-500">*</span>
      </label>
      <div class="relative">
        <textarea
          placeholder="Explain why you need this funding and how it will benefit your business. Be specific about your goals and expected outcomes..."
          [value]="coverInformation().purposeStatement"
          (input)="onPurposeStatementChange($event)"
          rows="6"
          class="block w-full px-4 py-4 border-2 border-neutral-300 rounded-xl shadow-sm placeholder-neutral-400 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-all hover:border-neutral-400 resize-none text-sm leading-relaxed"
        ></textarea>
        <div class="absolute bottom-3 right-3 text-xs text-neutral-400">
          {{ coverInformation().purposeStatement.length || 0 }} characters
        </div>
      </div>
      <p class="mt-2 text-xs text-neutral-500">Describe your business objectives and how funding will help achieve them</p>
    </div>

    <!-- Use of Funds -->
    <div class="group">
      <label class="block text-sm font-medium text-neutral-700 mb-3 group-hover:text-primary-600 transition-colors">
        Use of Funds <span class="text-red-500">*</span>
      </label>
      <div class="relative">
        <textarea
          placeholder="Provide a detailed breakdown of how you will use the funding. Include specific amounts for equipment, inventory, marketing, expansion, etc..."
          [value]="coverInformation().useOfFunds"
          (input)="onUseOfFundsChange($event)"
          rows="6"
          class="block w-full px-4 py-4 border-2 border-neutral-300 rounded-xl shadow-sm placeholder-neutral-400 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-all hover:border-neutral-400 resize-none text-sm leading-relaxed"
        ></textarea>
        <div class="absolute bottom-3 right-3 text-xs text-neutral-400">
          {{ coverInformation().useOfFunds.length || 0 }} characters
        </div>
      </div>
      <p class="mt-2 text-xs text-neutral-500">Break down exactly how the funds will be allocated</p>
    </div>
  </div>

  <!-- Timeline - Full Width -->
  <div class="group">
    <label class="block text-sm font-medium text-neutral-700 mb-3 group-hover:text-primary-600 transition-colors">
      Timeline
    </label>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <button 
        type="button"
        (click)="setTimeline('ASAP')"
        [class]="coverInformation().timeline === 'ASAP' ? 'border-primary-500 bg-primary-50 text-primary-700' : 'border-neutral-300 text-neutral-700 hover:border-neutral-400'"
        class="px-4 py-3 border-2 rounded-xl transition-all text-sm font-medium text-center"
      >
        ASAP
      </button>
      <button 
        type="button"
        (click)="setTimeline('Within 3 months')"
        [class]="coverInformation().timeline === 'Within 3 months' ? 'border-primary-500 bg-primary-50 text-primary-700' : 'border-neutral-300 text-neutral-700 hover:border-neutral-400'"
        class="px-4 py-3 border-2 rounded-xl transition-all text-sm font-medium text-center"
      >
        Within 3 months
      </button>
      <button 
        type="button"
        (click)="setTimeline('Within 6 months')"
        [class]="coverInformation().timeline === 'Within 6 months' ? 'border-primary-500 bg-primary-50 text-primary-700' : 'border-neutral-300 text-neutral-700 hover:border-neutral-400'"
        class="px-4 py-3 border-2 rounded-xl transition-all text-sm font-medium text-center"
      >
        Within 6 months
      </button>
    </div>
    <div class="mt-4">
      <input
        type="text"
        placeholder="Or specify your own timeline..."
        [value]="coverInformation().timeline"
        (input)="onTimelineChange($event)"
        class="block w-full px-4 py-3 border-2 border-neutral-300 rounded-xl shadow-sm placeholder-neutral-400 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-all hover:border-neutral-400"
      />
    </div>
  </div>

  <!-- Why This Opportunity - Full Width Card -->
  <div class="bg-gradient-to-br from-blue-50 to-indigo-50 border-2 border-blue-200 rounded-xl p-6">
    <div class="group">
      <label class="block text-sm font-medium text-blue-800 mb-3 group-hover:text-blue-900 transition-colors flex items-center">
        <lucide-icon [img]="BuildingIcon" [size]="16" class="mr-2" />
        Why This Opportunity?
      </label>
      <textarea
        placeholder="Explain why this specific opportunity aligns with your business goals. What makes this funder or funding type the right fit for your company's current stage and objectives?"
        [value]="coverInformation().opportunityAlignment"
        (input)="onOpportunityAlignmentChange($event)"
        rows="4"
        class="block w-full px-4 py-4 border-2 border-blue-200 rounded-xl shadow-sm placeholder-blue-400 bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all hover:border-blue-300 resize-none text-sm leading-relaxed"
      ></textarea>
      <p class="mt-2 text-xs text-blue-600">Help us understand why you chose this particular funding opportunity</p>
    </div>
  </div>

  <!-- Progress Indicator -->
  <div class="bg-neutral-50 border border-neutral-200 rounded-xl p-4">
    <div class="flex items-center justify-between text-sm text-neutral-600 mb-2">
      <span class="font-medium">Application Completion</span>
      <span class="font-medium">{{ getApplicationCompletionPercentage() }}%</span>
    </div>
    <div class="w-full bg-neutral-200 rounded-full h-2">
      <div 
        class="bg-gradient-to-r from-green-400 to-green-600 h-2 rounded-full transition-all duration-500"
        [style.width.%]="getApplicationCompletionPercentage()"
      ></div>
    </div>
    <div class="mt-2 flex items-center text-xs text-neutral-500">
      <lucide-icon [img]="CheckCircleIcon" [size]="12" class="mr-1 text-green-600" />
      Complete all required fields to continue to AI analysis
    </div>
  </div>
</div>
          }

          @case ('ai-analysis') {
            <div class="space-y-6">
              <div class="flex items-center space-x-3 mb-6">
                <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-slate-600 rounded-lg flex items-center justify-center shadow-lg">
                  <lucide-icon [img]="DollarSignIcon" [size]="20" class="text-white" />
                </div>
                <div>
                  <h3 class="text-lg font-semibold text-neutral-900">AI Analysis</h3>
                  <p class="text-sm text-neutral-600">Get intelligent insights about your application</p>
                </div>
              </div>

              <!-- AI Analysis Component -->
           <app-enhanced-ai-analysis
            [opportunity]="selectedOpportunity()"
            [applicationData]="coverInformation()"
            [applicationId]="applicationId()"
          
            [isSubmitted]="false"
            [analysisMode]="'opportunity'"
            (analysisCompleted)="onAnalysisCompleted($event)"
            (improvementRequested)="onImprovementRequested()"
            (proceedRequested)="onProceedRequested()">
          </app-enhanced-ai-analysis>

            </div>
          }

          @case ('review-submit') {
            <div class="space-y-6">
              <div class="flex items-center space-x-3 mb-6">
                <div class="w-10 h-10 bg-gradient-to-br from-green-500 to-green-600 rounded-lg flex items-center justify-center shadow-lg">
                  <lucide-icon [img]="CheckCircleIcon" [size]="20" class="text-white" />
                </div>
                <div>
                  <h3 class="text-lg font-semibold text-neutral-900">Review & Submit</h3>
                  <p class="text-sm text-neutral-600">Review your application before submitting</p>
                </div>
              </div>

              <!-- Enhanced Application Summary -->
              <div class="bg-gradient-to-br from-neutral-50 to-neutral-100 rounded-xl p-6 border border-neutral-200 hover:shadow-md transition-shadow">
                <h4 class="font-medium text-neutral-900 mb-4 flex items-center">
                  <lucide-icon [img]="FileTextIcon" [size]="18" class="mr-2 text-primary-600" />
                  Application Summary
                </h4>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-sm mb-6">
                  <div class="space-y-3">
                    <div class="flex items-center space-x-2">
                      <span class="text-neutral-500 w-24">Opportunity:</span>
                      <div class="font-medium text-neutral-900">{{ selectedOpportunity()?.title }}</div>
                    </div>
                    <div class="flex items-center space-x-2">
                      <span class="text-neutral-500 w-24">Funder:</span>
                      <div class="font-medium text-neutral-900">{{ getOrganizationName(selectedOpportunity()!) }}</div>
                    </div>
                  </div>
                  <div class="space-y-3">
                    <div class="flex items-center space-x-2">
                      <span class="text-neutral-500 w-24">Amount:</span>
                      <div class="font-medium text-primary-600">{{ formatCurrency(requestedAmountAsNumber()) }}</div>
                    </div>
                    <div class="flex items-center space-x-2">
                      <span class="text-neutral-500 w-24">Type:</span>
                      <div class="font-medium capitalize bg-primary-100 text-primary-800 px-2 py-1 rounded-full text-xs">{{ selectedOpportunity()?.fundingType }}</div>
                    </div>
                  </div>
                </div>

                @if (coverInformation().purposeStatement) {
                  <div class="mb-4 p-4 bg-white rounded-lg border border-neutral-200">
                    <span class="text-neutral-500 text-sm font-medium flex items-center mb-2">
                      <lucide-icon [img]="FileTextIcon" [size]="14" class="mr-1" />
                      Purpose Statement:
                    </span>
                    <div class="mt-1 text-sm text-neutral-800 leading-relaxed">{{ coverInformation().purposeStatement }}</div>
                  </div>
                }

                @if (coverInformation().useOfFunds) {
                  <div class="p-4 bg-white rounded-lg border border-neutral-200">
                    <span class="text-neutral-500 text-sm font-medium flex items-center mb-2">
                      <lucide-icon [img]="DollarSignIcon" [size]="14" class="mr-1" />
                      Use of Funds:
                    </span>
                    <div class="mt-1 text-sm text-neutral-800 leading-relaxed">{{ coverInformation().useOfFunds }}</div>
                  </div>
                }
              </div>

              <!-- Enhanced AI Analysis Summary -->
              @if (aiAnalysisResult()) {
                <div class="bg-gradient-to-r from-blue-50 via-indigo-50 to-slate-50 border-2 border-blue-200 rounded-xl p-6 hover:shadow-lg transition-shadow">
                  <div class="flex items-center space-x-3 mb-4">
                    <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-slate-600 rounded-lg flex items-center justify-center">
                      <lucide-icon [img]="DollarSignIcon" [size]="16" class="text-white" />
                    </div>
                    <div>
                      <h4 class="font-medium text-neutral-900">AI Analysis Summary</h4>
                      <p class="text-sm text-neutral-600">Intelligent assessment completed</p>
                    </div>
                  </div>
                  
                  <div class="grid grid-cols-3 gap-4">
                    <div class="bg-white/80 backdrop-blur rounded-lg p-4 text-center hover:bg-white/90 transition-colors">
                      <div class="text-2xl font-bold text-blue-600">{{ aiAnalysisResult().matchScore }}%</div>
                      <div class="text-xs text-neutral-600 font-medium">Match Score</div>
                    </div>
                    <div class="bg-white/80 backdrop-blur rounded-lg p-4 text-center hover:bg-white/90 transition-colors">
                      <div class="text-2xl font-bold text-green-600">{{ aiAnalysisResult().successProbability }}%</div>
                      <div class="text-xs text-neutral-600 font-medium">Success Rate</div>
                    </div>
                    <div class="bg-white/80 backdrop-blur rounded-lg p-4 text-center hover:bg-white/90 transition-colors">
                      <div class="text-sm font-bold text-slate-600 capitalize">{{ aiAnalysisResult().competitivePositioning }}</div>
                      <div class="text-xs text-neutral-600 font-medium">Position</div>
                    </div>
                  </div>
                </div>
              }

              <!-- Enhanced Profile Attachment Confirmation -->
              <div class="bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-200 rounded-xl p-4 hover:shadow-md transition-shadow">
                <div class="flex items-start">
                  <lucide-icon [img]="CheckCircleIcon" [size]="20" class="text-green-600 mt-0.5 mr-3" />
                  <div>
                    <p class="text-sm font-medium text-green-800 flex items-center">
                      Business Profile Attached
                      <span class="ml-2 bg-green-600 text-white px-2 py-0.5 rounded-full text-xs">{{ profileCompletion() }}%</span>
                    </p>
                    <p class="text-sm text-green-700 mt-1">
                      Your complete business profile will be included with this application.
                    </p>
                  </div>
                </div>
              </div>

              <!-- Enhanced Terms and Conditions -->
              <div class="bg-gradient-to-r from-amber-50 to-yellow-50 border-2 border-amber-200 rounded-xl p-4 hover:shadow-md transition-shadow">
                <div class="flex items-start">
                  <lucide-icon [img]="AlertCircleIcon" [size]="20" class="text-amber-600 mt-0.5 mr-3" />
                  <div>
                    <h4 class="text-sm font-medium text-amber-800">Before You Submit</h4>
                    <ul class="mt-2 text-sm text-amber-700 space-y-1">
                      <li class="flex items-center"><span class="w-1 h-1 bg-amber-600 rounded-full mr-2"></span>This application will be reviewed by the funder</li>
                      <li class="flex items-center"><span class="w-1 h-1 bg-amber-600 rounded-full mr-2"></span>Review typically takes {{ selectedOpportunity()?.decisionTimeframe || 30 }} days</li>
                      <li class="flex items-center"><span class="w-1 h-1 bg-amber-600 rounded-full mr-2"></span>You may be contacted for additional information</li>
                      <li class="flex items-center"><span class="w-1 h-1 bg-amber-600 rounded-full mr-2"></span>All information provided must be accurate and up-to-date</li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>
          }
        }

        <!-- Enhanced Form Actions -->
        <div class="flex items-center justify-between pt-6 mt-8 border-t-2 border-neutral-200">
          <div class="flex items-center space-x-3">
            @if (currentStep() !== 'select-opportunity') {
              <ui-button variant="outline" (click)="previousStep()" class="hover:scale-105 transition-transform">
                <lucide-icon [img]="ArrowLeftIcon" [size]="16" class="mr-2" />
                Previous
              </ui-button>
            }
            
            <ui-button variant="outline" (click)="goBack()" class="hover:scale-105 transition-transform text-neutral-600 hover:text-neutral-800">
              Cancel
            </ui-button>
          </div>

          <div class="flex items-center space-x-3">
            <ui-button variant="outline" (click)="saveDraft()" [disabled]="isSaving()" class="hover:scale-105 transition-transform">
              @if (isSaving()) {
                <lucide-icon [img]="ClockIcon" [size]="16" class="mr-2 animate-spin" />
                Saving...
              } @else {
                Save Draft
              }
            </ui-button>

            @if (currentStep() === 'review-submit') {
              <ui-button 
                variant="primary" 
                (click)="submitApplication()" 
                [disabled]="!canContinue() || isSubmitting()"
                class="bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 hover:scale-105 transition-all shadow-lg hover:shadow-xl"
              >
                @if (isSubmitting()) {
                  <lucide-icon [img]="ClockIcon" [size]="16" class="mr-2 animate-spin" />
                  Submitting...
                } @else {
                  Submit Application
                }
              </ui-button>
            } @else {
              <ui-button variant="primary" (click)="nextStep()" [disabled]="!canContinue()" 
                        class="bg-gradient-to-r from-primary-500 rounded to-primary-600 hover:from-primary-600 hover:to-primary-700 hover:scale-105 transition-all shadow-lg hover:shadow-xl">
                @if (currentStep() === 'application-details') {
                  Continue to AI Analysis
                } @else if (currentStep() === 'ai-analysis') {
                  Continue to Review
                } @else {
                  Continue
                }
              </ui-button>
            }
          </div>
        </div>
      </ui-card>
    </div>

    <!-- Enhanced Sidebar -->
    <div class="lg:col-span-1">
      @if (selectedOpportunity(); as opportunity) {
        <ui-card class="sticky top-6 hover:shadow-lg transition-shadow duration-300">
          <div class="space-y-4">
            <div class="border-b border-neutral-200 pb-4">
              <h3 class="font-medium text-neutral-900">Selected Opportunity</h3>
              <p class="text-sm text-neutral-600">{{ getOrganizationName(opportunity) }}</p>
            </div>

            <div class="bg-gradient-to-br from-neutral-50 to-neutral-100 rounded-lg p-4 border border-neutral-200">
              <h4 class="font-medium text-neutral-900 mb-3">{{ opportunity.title }}</h4>
              
              <div class="space-y-3 text-sm">
                <div class="flex justify-between items-center p-2 bg-white rounded border">
                  <span class="text-neutral-600 flex items-center">
                    <lucide-icon [img]="BuildingIcon" [size]="12" class="mr-1" />
                    Type:
                  </span>
                  <span class="font-medium capitalize bg-primary-100 text-primary-800 px-2 py-1 rounded-full text-xs">{{ opportunity.fundingType }}</span>
                </div>
                
                <div class="flex justify-between items-center p-2 bg-white rounded border">
                  <span class="text-neutral-600 flex items-center">
                    <lucide-icon [img]="DollarSignIcon" [size]="12" class="mr-1" />
                    Range:
                  </span>
                  <span class="font-medium">{{ formatCurrency(opportunity.minInvestment) }} - {{ formatCurrency(opportunity.maxInvestment) }}</span>
                </div>
                
                @if (opportunity.interestRate) {
                  <div class="flex justify-between items-center p-2 bg-white rounded border">
                    <span class="text-neutral-600 flex items-center">
                      <lucide-icon [img]="DollarSignIcon" [size]="12" class="mr-1" />
                      Interest Rate:
                    </span>
                    <span class="font-medium">{{ opportunity.interestRate }}%</span>
                  </div>
                }
                
                @if (opportunity.equityOffered) {
                  <div class="flex justify-between items-center p-2 bg-white rounded border">
                    <span class="text-neutral-600 flex items-center">
                      <lucide-icon [img]="DollarSignIcon" [size]="12" class="mr-1" />
                      Equity:
                    </span>
                    <span class="font-medium">{{ opportunity.equityOffered }}%</span>
                  </div>
                }
                
                <div class="flex justify-between items-center p-2 bg-white rounded border">
                  <span class="text-neutral-600 flex items-center">
                    <lucide-icon [img]="ClockIcon" [size]="12" class="mr-1" />
                    Decision Time:
                  </span>
                  <span class="font-medium">{{ opportunity.decisionTimeframe }} days</span>
                </div>
              </div>
            </div>

            @if (opportunity.shortDescription) {
              <div class="bg-white border border-neutral-200 rounded-lg p-4 hover:shadow-sm transition-shadow">
                <h4 class="font-medium text-neutral-900 mb-2 flex items-center">
                  <lucide-icon [img]="FileTextIcon" [size]="14" class="mr-1 text-blue-600" />
                  Description
                </h4>
                <p class="text-sm text-neutral-600 leading-relaxed">{{ opportunity.shortDescription }}</p>
              </div>
            }

            @if (opportunity.applicationDeadline) {
              <div class="bg-gradient-to-r from-amber-50 to-yellow-50 border-2 border-amber-200 rounded-lg p-3">
                <div class="flex items-center">
                  <lucide-icon [img]="AlertCircleIcon" [size]="16" class="text-amber-600 mr-2" />
                  <div>
                    <p class="text-sm font-medium text-amber-800">Application Deadline</p>
                    <p class="text-xs text-amber-700">{{ opportunity.applicationDeadline | date:'mediumDate' }}</p>
                  </div>
                </div>
              </div>
            }

            <!-- Enhanced AI Analysis Sidebar Info -->
            @if (currentStep() === 'ai-analysis' || aiAnalysisResult()) {
              <div class="bg-gradient-to-br from-blue-50 via-indigo-50 to-slate-50 border-2 border-blue-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                <div class="flex items-center space-x-2 mb-3">
                  <div class="w-6 h-6 bg-gradient-to-r from-blue-500 to-slate-600 rounded flex items-center justify-center">
                    <lucide-icon [img]="DollarSignIcon" [size]="12" class="text-white" />
                  </div>
                  <h4 class="font-medium text-neutral-900">AI Insights</h4>
                </div>

                @if (aiAnalysisResult()) {
                  <div class="space-y-3">
                    <div class="bg-white/60 backdrop-blur rounded p-3">
                      <div class="flex justify-between items-center">
                        <span class="text-neutral-600 text-sm">Match Score:</span>
                        <div class="flex items-center space-x-2">
                          <div class="w-12 h-1.5 bg-neutral-200 rounded-full overflow-hidden">
                            <div class="h-full bg-gradient-to-r from-blue-400 to-blue-600 transition-all duration-1000"
                                 [style.width.%]="aiAnalysisResult().matchScore"></div>
                          </div>
                          <span class="font-medium text-blue-600 text-sm">{{ aiAnalysisResult().matchScore }}%</span>
                        </div>
                      </div>
                    </div>
                    
                    <div class="bg-white/60 backdrop-blur rounded p-3">
                      <div class="flex justify-between items-center">
                        <span class="text-neutral-600 text-sm">Success Rate:</span>
                        <div class="flex items-center space-x-2">
                          <div class="w-12 h-1.5 bg-neutral-200 rounded-full overflow-hidden">
                            <div class="h-full bg-gradient-to-r from-green-400 to-green-600 transition-all duration-1000"
                                 [style.width.%]="aiAnalysisResult().successProbability"></div>
                          </div>
                          <span class="font-medium text-green-600 text-sm">{{ aiAnalysisResult().successProbability }}%</span>
                        </div>
                      </div>
                    </div>
                    
                    <div class="bg-white/60 backdrop-blur rounded p-3">
                      <div class="flex justify-between items-center">
                        <span class="text-neutral-600 text-sm">Position:</span>
                        <span class="font-medium capitalize text-slate-600 text-sm bg-slate-100 px-2 py-1 rounded-full">{{ aiAnalysisResult().competitivePositioning }}</span>
                      </div>
                    </div>
                  </div>
                } @else {
                  <div class="text-center py-4">
                    <div class="w-8 h-8 border-2 border-blue-300 border-t-blue-600 rounded-full animate-spin mx-auto mb-2"></div>
                    <p class="text-sm text-neutral-600">Complete application details to get AI analysis</p>
                  </div>
                }
              </div>
            }

            <!-- Enhanced Statistics -->
            <div class="pt-4 border-t-2 border-neutral-200 space-y-3">
              <div class="bg-white border border-neutral-200 rounded-lg p-3 hover:shadow-sm transition-shadow">
                <div class="flex items-center justify-between text-sm">
                  <span class="text-neutral-600 flex items-center">
                    <lucide-icon [img]="UsersIcon" [size]="12" class="mr-1" />
                    Applications:
                  </span>
                  <div class="flex items-center space-x-2">
                    <span class="font-medium">{{ opportunity.currentApplications || 0 }}</span>
                    @if (opportunity.maxApplications) {
                      <span class="text-neutral-400">/</span>
                      <span class="text-neutral-500">{{ opportunity.maxApplications }}</span>
                    }
                    @if (opportunity.maxApplications) {
                      <div class="w-16 h-1 bg-neutral-200 rounded-full overflow-hidden ml-2">
                        <div class="h-full bg-gradient-to-r from-primary-400 to-primary-600 transition-all duration-500"
                             [style.width.%]="((opportunity.currentApplications || 0) / opportunity.maxApplications) * 100"></div>
                      </div>
                    }
                  </div>
                </div>
              </div>
              
              @if (opportunity.viewCount) {
                <div class="bg-white border border-neutral-200 rounded-lg p-3 hover:shadow-sm transition-shadow">
                  <div class="flex items-center justify-between text-sm">
                    <span class="text-neutral-600 flex items-center">
                      <lucide-icon [img]="EyeIcon" [size]="12" class="mr-1" />
                      Views:
                    </span>
                    <span class="font-medium">{{ opportunity.viewCount }}</span>
                  </div>
                </div>
              }
              
              <!-- Interest Level Indicator -->
              <div class="bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 rounded-lg p-3">
                <div class="flex items-center justify-between text-sm">
                  <span class="text-green-700 flex items-center font-medium">
                    <lucide-icon [img]="TrendingUpIcon" [size]="12" class="mr-1" />
                    Interest Level:
                  </span>
                  <div class="flex items-center space-x-1">
                    @for (star of [1,2,3,4,5]; track star) {
                      <div class="w-2 h-2 rounded-full" 
                           [class]="star <= 4 ? 'bg-yellow-400' : 'bg-neutral-300'"></div>
                    }
                  </div>
                </div>
              </div>
            </div>
          </div>
        </ui-card>
      } @else {
        <!-- Enhanced No Opportunity Selected State -->
        <ui-card class="sticky top-6 hover:shadow-lg transition-shadow duration-300">
          <div class="text-center py-12">
            <div class="w-16 h-16 bg-gradient-to-br from-neutral-100 to-neutral-200 rounded-xl mx-auto mb-4 flex items-center justify-center">
              <lucide-icon [img]="BuildingIcon" [size]="28" class="text-neutral-400" />
            </div>
            <h3 class="font-medium text-neutral-900 mb-2">No Opportunity Selected</h3>
            <p class="text-sm text-neutral-500">Select an opportunity to view details and start your application</p>
            <div class="mt-4 pt-4 border-t border-neutral-200">
              <div class="flex items-center justify-center space-x-4 text-xs text-neutral-400">
                <span class="flex items-center"><lucide-icon [img]="ClockIcon" [size]="12" class="mr-1" />Quick Process</span>
                <span class="flex items-center"><lucide-icon [img]="CheckCircleIcon" [size]="12" class="mr-1" />Secure</span>
              </div>
            </div>
          </div>
        </ui-card>
      }
    </div>
  </div>
</div>
