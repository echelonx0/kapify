<!-- opportunity-application.component.html -->
<div class="max-w-6xl mx-auto">
  <!-- Header -->
  <div class="mb-10 mt-10 border-b border-neutral-200 pb-6">
    <div class="flex items-center justify-between">
      <div class="flex items-center space-x-4">
        <ui-button 
          variant="outline" 
          size="sm" 
          (click)="goBack()" 
          class="flex items-center hover:scale-105 transition-transform"
        >
          <lucide-icon [img]="ArrowLeftIcon" [size]="16" class="mr-2" />
          Back
        </ui-button>
      </div>

      <div>
        <ui-button 
          variant="outline" 
          size="sm" 
          (click)="saveDraft()" 
          [disabled]="isSaving()"
          class="hover:scale-105 transition-transform"
        >
          @if (isSaving()) {
            <lucide-icon [img]="ClockIcon" [size]="16" class="mr-2 animate-spin" />
            Saving...
          } @else {
            Save Draft
          }
        </ui-button>
      </div>
    </div>
  </div>

  <!-- Progress Steps -->
  <div class="mb-8">
    <div class="flex items-center justify-between w-full">
      @for (step of steps(); track step.id) {
        <div class="flex items-center flex-1 group">
          <div class="flex items-center">
            <div [class]="getStepClasses(step.id)" class="group-hover:scale-110">
              {{ step.number }}
            </div>
            <div class="ml-3">
              <p [class]="getStepTextClasses(step.id)" class="font-medium transition-colors">
                {{ step.title }}
              </p>
              <p class="text-xs text-neutral-500">{{ step.description }}</p>
            </div>
          </div>
          
          @if (step.id !== 'review-submit') {
            <div class="flex-1 h-0.5 bg-neutral-200 mx-8 relative overflow-hidden">
              <div class="absolute inset-0 h-full bg-gradient-to-r from-primary-400 to-primary-600"></div>
            </div>
          }
        </div>
      }
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <!-- Main Content -->
    <div class="lg:col-span-2">
      <ui-card class="hover:shadow-lg transition-shadow duration-300">
        @if (error()) {
          <div class="mb-6 bg-red-50 border border-red-200 rounded-lg p-4">
            <span class="text-red-800">{{ error() }}</span>
          </div>
        }

        @switch (currentStep()) {
          @case ('select-opportunity') {
            <app-opportunity-selector
              [opportunities]="availableOpportunities()"
              [selectedOpportunityId]="selectedOpportunity()?.id"
              [isLoading]="isLoading()"
              (opportunitySelected)="onOpportunitySelected($event)"
              (backClicked)="goBack()">
            </app-opportunity-selector>
          }

          @case ('application-details') {
            <app-application-form
              [opportunity]="selectedOpportunity()!"
              (formChanged)="onFormChanged()">
            </app-application-form>
          }

          @case ('ai-analysis') {
            <div class="space-y-6">
              <div class="flex items-center space-x-3 mb-6">
                <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-slate-600 rounded-lg flex items-center justify-center shadow-lg">
                  <lucide-icon [img]="ClockIcon" [size]="20" class="text-white" />
                </div>
                <div>
                  <h3 class="text-lg font-semibold text-neutral-900">Pre Qualification Analysis</h3>
                  <p class="text-sm text-neutral-600">Get intelligent insights about your application</p>
                </div>
              </div>

              <app-enhanced-ai-analysis
                [opportunity]="selectedOpportunity()"
                [applicationData]="formData()"
                [applicationId]="applicationId()"
                [businessProfile]="businessProfile()"
                [isSubmitted]="false"
                [analysisMode]="'opportunity'"
                [analysisPerspective]="'sme'"
                (analysisCompleted)="onAnalysisCompleted($event)"
                (improvementRequested)="onImprovementRequested()"
                (proceedRequested)="onProceedRequested()">
              </app-enhanced-ai-analysis>
            </div>
          }

          @case ('review-submit') {
            <app-review-summary
              [opportunity]="selectedOpportunity()!"
              [formData]="formData()"
              [aiAnalysisResult]="aiAnalysisResult()"
              [profileCompletion]="profileCompletion()">
            </app-review-summary>
          }
        }

        <!-- Form Actions -->
        <div class="flex items-center justify-between pt-6 mt-8 border-t-2 border-neutral-200">
          <div class="flex items-center space-x-3">
            @if (currentStep() !== 'select-opportunity') {
              <ui-button variant="outline" (click)="previousStep()">
                <lucide-icon [img]="ArrowLeftIcon" [size]="16" class="mr-2" />
                Previous
              </ui-button>
            }
            
            <ui-button variant="outline" (click)="goBack()">
              Cancel
            </ui-button>
          </div>

          <div class="flex items-center space-x-3">
            <ui-button variant="outline" (click)="saveDraft()" [disabled]="isSaving()">
              @if (isSaving()) {
                <lucide-icon [img]="ClockIcon" [size]="16" class="mr-2 animate-spin" />
                Saving...
              } @else {
                Save Draft
              }
            </ui-button>

            @if (currentStep() === 'review-submit') {
              <ui-button 
                variant="primary" 
                (click)="submitApplication()" 
                [disabled]="!canContinue() || isSubmitting()"
                class="bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700"
              >
                @if (isSubmitting()) {
                  <lucide-icon [img]="ClockIcon" [size]="16" class="mr-2 animate-spin" />
                  Submitting...
                } @else {
                  Submit Application
                }
              </ui-button>
            } @else {
              <ui-button variant="primary" (click)="nextStep()" [disabled]="!canContinue()">
                @if (currentStep() === 'application-details') {
                  Continue to AI Analysis
                } @else if (currentStep() === 'ai-analysis') {
                  Continue to Review
                } @else {
                  Continue
                }
              </ui-button>
            }
          </div>
        </div>
      </ui-card>
    </div>

    <!-- Sidebar -->
    <div class="lg:col-span-1">
      <app-opportunity-sidebar
        [opportunity]="selectedOpportunity()"
        [currentStep]="currentStep()"
        [aiAnalysisResult]="aiAnalysisResult()">
      </app-opportunity-sidebar>
    </div>
  </div>
</div>