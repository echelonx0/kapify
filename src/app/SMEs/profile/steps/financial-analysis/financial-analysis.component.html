<!-- src/app/profile/steps/financial-analysis/financial-analysis.component.html -->
<div class="max-w-7xl mx-auto space-y-4">
  <!-- Header Section -->
  <div class="flex items-center justify-between mb-2 m-2">
    <div>
      <h1 class="text-2xl font-bold text-slate-700">Financial Analysis</h1>
    </div>
    
    <!-- Save Status -->
    <div class="flex items-center space-x-3">
      @if (lastSaved()) {
        <div class="flex items-center text-sm text-gray-500">
          <lucide-icon [name]="ClockIcon" [size]="16" class="mr-1 text-primary-500" />
          <span>Saved {{ getLastSavedText() }}</span>
        </div>
      }
      
      @if (isSaving()) {
        <div class="flex items-center text-sm text-primary-600">
          <lucide-icon [name]="ClockIcon" [size]="16" class="mr-1 animate-spin text-primary-500" />
          <span>Saving...</span>
        </div>
      }
      
      <ui-button 
        variant="primary" 
        size="sm"
        [disabled]="isSaving() || !hasFinancialData()" 
        (clicked)="saveManually()">
        <lucide-icon [name]="SaveIcon" [size]="16" class="mr-1" />
        Save Now
      </ui-button>
    </div>
  </div>

  @if (!hasFinancialData()) {
    <!-- Upload Component -->
    <app-financial-upload
      [hasData]="hasFinancialData()"
      [uploadedFile]="uploadedTemplate()"
      [isProcessing]="isParsingFile() || isUploading()"
      [error]="parseError()"
      [warnings]="parseWarnings()"
      [progress]="parseProgress()"
      [isValidTemplate]="hasValidTemplate()"
      [completionPercentage]="getCompletionPercentage()"
      (fileSelected)="onFileSelected($event)"
      (templateDownload)="downloadTemplate()"
      (dataDownload)="downloadCurrentData()"
      (fileRemove)="removeTemplate()"
      (errorClear)="clearErrors()"
    />
  }

  <!-- Financial Data Display -->
  @if (hasFinancialData()) {
    <!-- Tab Navigation -->
    <div class="border-b border-gray-200">
      <nav class="-mb-px flex space-x-8 overflow-x-auto">
        <button
          (click)="switchTab('income-statement')"
          [class]="activeTab() === 'income-statement' 
            ? 'border-primary-500 text-primary-600' 
            : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
          class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors duration-200">
          Income Statement
        </button>
        <button
          (click)="switchTab('financial-ratios')"
          [class]="activeTab() === 'financial-ratios' 
            ? 'border-primary-500 text-primary-600' 
            : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
          class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors duration-200">
          Financial Ratios
        </button>
        <button
          (click)="switchTab('notes')"
          [class]="activeTab() === 'notes' 
            ? 'border-primary-500 text-primary-600' 
            : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
          class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors duration-200">
          Notes
        </button>
        <button
          (click)="switchTab('health-score')"
          [class]="activeTab() === 'health-score' 
            ? 'border-primary-500 text-primary-600' 
            : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
          class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors duration-200">
          Health Score
        </button>
      </nav>
    </div>

    <!-- Tab Content -->
    <div class="space-y-6">
      <!-- Income Statement Tab -->
      @if (activeTab() === 'income-statement') {
 
            <div class="flex items-center justify-between mb-6">
              
              <ui-button 
                variant="outline" 
                size="sm"
                (clicked)="toggleEditMode()">
                <lucide-icon [name]="EditIcon" [size]="16" class="mr-1" />
                {{ editingMode() ? 'Done' : 'Edit' }}
              </ui-button>
            </div>

            <app-financial-data-table
              [sections]="incomeStatementSections()"
              [columnHeaders]="columnHeaders()"
              [editMode]="editingMode()"
              itemLabel="Item"
              (cellValueChanged)="onIncomeStatementCellChanged($event)"
            />
      
      }

      <!-- Financial Ratios Tab -->
      @if (activeTab() === 'financial-ratios') {
     
            <div class="flex items-center justify-between mb-6">
            
              <ui-button 
                variant="outline" 
                size="sm"
                (clicked)="toggleEditMode()">
                <lucide-icon [name]="EditIcon" [size]="16" class="mr-1" />
                {{ editingMode() ? 'Done' : 'Edit' }}
              </ui-button>
            </div>

            <app-financial-data-table
              [sections]="financialRatiosSections()"
              [columnHeaders]="columnHeaders()"
              [editMode]="editingMode()"
              itemLabel="Ratio"
              (cellValueChanged)="onFinancialRatiosCellChanged($event)"
            />
      
      }

      <!-- Notes Tab -->
      @if (activeTab() === 'notes') {
      
       
          <app-financial-notes
              [(notes)]="notesText"
              (notesSaved)="onNotesSaved($event)"
            />
       
        
      }

      <!-- Health Score Tab -->
      @if (activeTab() === 'health-score') {
      
         
            <app-financial-summary
              [completionPercentage]="getCompletionPercentage()"
              [incomeStatementCount]="incomeStatementData().length"
              [financialRatiosCount]="financialRatiosData().length"
              [isValidTemplate]="hasValidTemplate()"
            />
         
      }
    </div>
  }

  <!-- Empty State -->
  @if (!hasFinancialData() && !uploadedTemplate()) {
    <ui-card>
      <div class="p-6 text-center">
        <lucide-icon name="file-spreadsheet" [size]="48" class="mx-auto text-gray-400 mb-4" />
        <h3 class="text-lg font-medium text-gray-900 mb-2">No Financial Data</h3>
        <p class="text-gray-600 mb-6">
          Upload a financial template with your historical data and projections to begin your analysis. 
          The template includes predefined rows for income statement and financial ratios.
        </p>
        <div class="flex justify-center space-x-4">
          <ui-button variant="primary" (clicked)="downloadTemplate()">
            <lucide-icon name="download" [size]="16" class="mr-2" />
            Download Template
          </ui-button>
        </div>
      </div>
    </ui-card>
  }
</div>