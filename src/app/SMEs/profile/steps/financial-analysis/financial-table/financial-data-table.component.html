<!-- DARK MODE TABLE - Bloomberg Terminal Style -->

<div class="space-y-4" [class.dark-mode]="isDarkMode()">
  <!-- Year Navigation (Only show if not edit mode and more than 3 years) -->
  @if (!editMode && columnHeaders.length > 3) {
  <div
    class="rounded-xl border p-4 sticky top-0 z-10 transition-all duration-300"
    [class]="
      isDarkMode()
        ? 'bg-[var(--bg-secondary)] border-[var(--border-color)]'
        : 'bg-white border-slate-200'
    "
  >
    <!-- Year Tabs Navigation -->
    <div class="flex items-center justify-between gap-4">
      <!-- Previous Button -->
      <button
        (click)="goToPreviousYears()"
        [disabled]="!hasPreviousYear()"
        class="inline-flex items-center justify-center w-10 h-10 rounded-lg font-medium transition-all duration-200 disabled:opacity-30 disabled:cursor-not-allowed"
        [class]="
          isDarkMode()
            ? 'bg-[var(--button-bg)] text-[var(--text-primary)] hover:bg-[var(--button-hover)]'
            : 'bg-slate-100 text-slate-700 hover:bg-slate-200'
        "
        title="View previous years"
      >
        <span class="text-lg">←</span>
      </button>

      <!-- Year Tabs Container -->
      <div class="flex-1 overflow-x-auto scrollbar-hide">
        <div class="flex gap-2 min-w-max px-2">
          @for (year of visibleHeaders(); track trackByColumn($index, year)) {
          <button
            class="px-4 py-2 rounded-lg text-sm font-semibold whitespace-nowrap transition-all duration-200 border-2"
            [class]="getYearTabClass($index)"
            disabled
          >
            {{ year }}
          </button>
          }
        </div>
      </div>

      <!-- Next Button -->
      <button
        (click)="goToNextYears()"
        [disabled]="!hasNextYear()"
        class="inline-flex items-center justify-center w-10 h-10 rounded-lg font-medium transition-all duration-200 disabled:opacity-30 disabled:cursor-not-allowed"
        [class]="
          isDarkMode()
            ? 'bg-[var(--button-bg)] text-[var(--text-primary)] hover:bg-[var(--button-hover)]'
            : 'bg-slate-100 text-slate-700 hover:bg-slate-200'
        "
        title="View next years"
      >
        <span class="text-lg">→</span>
      </button>
    </div>

    <!-- Year Range Label -->
    <div
      class="mt-3 text-center text-xs transition-colors duration-300"
      [class]="isDarkMode() ? 'text-[var(--text-tertiary)]' : 'text-slate-500'"
    >
      Showing {{ yearRangeLabel() }}
    </div>
  </div>
  }

  <!-- Data Table -->
  <div
    class="rounded-xl border overflow-hidden transition-all duration-300"
    [class]="
      isDarkMode()
        ? 'border-[var(--border-color)] bg-[var(--bg-secondary)]'
        : 'border-slate-200 bg-white'
    "
  >
    <div class="overflow-x-auto">
      <table class="w-full border-collapse">
        <!-- Table Header -->
        <thead>
          <tr
            class="border-b transition-colors duration-300"
            [class]="
              isDarkMode()
                ? 'bg-[var(--bg-tertiary)] border-[var(--border-color)]'
                : 'bg-slate-50/50 border-slate-200'
            "
          >
            <!-- Item Column Header -->
            <th
              class="sticky left-0 z-20 px-4 py-3 text-left transition-colors duration-300"
              [class]="
                isDarkMode() ? 'bg-[var(--bg-tertiary)]' : 'bg-slate-50/50'
              "
            >
              <span
                class="text-sm font-semibold transition-colors duration-300"
                [class]="
                  isDarkMode() ? 'text-[var(--text-primary)]' : 'text-slate-900'
                "
              >
                {{ itemLabel }}
              </span>
            </th>

            <!-- Year Column Headers (Filtered) -->
            @for (header of visibleHeaders(); track trackByColumn($index,
            header)) {
            <th
              class="px-4 py-3 text-right min-w-[140px] transition-colors duration-300"
              [class]="
                isDarkMode() ? 'bg-[var(--bg-tertiary)]' : 'bg-slate-50/50'
              "
            >
              <span
                class="text-sm font-semibold transition-colors duration-300"
                [class]="
                  isDarkMode() ? 'text-[var(--accent-teal)]' : 'text-slate-900'
                "
              >
                {{ header }}
              </span>
            </th>
            }
          </tr>
        </thead>

        <!-- Table Body -->
        <tbody>
          @for (section of sections; track trackBySection($index, section)) {
          <!-- Section Header Row (Collapsible) -->
          @if (section.isCollapsible) {
          <tr
            class="border-b cursor-pointer transition-all duration-200"
            [class]="
              isDarkMode()
                ? 'bg-[var(--bg-secondary)] border-[var(--border-color)] hover:bg-[var(--bg-tertiary)]'
                : 'bg-teal-50/50 border-slate-200 hover:bg-teal-50'
            "
            (click)="toggleSection($index)"
          >
            <td
              class="sticky left-0 z-10 px-4 py-3 transition-colors duration-300"
              [attr.colspan]="visibleHeaders().length + 1"
              [class]="
                isDarkMode() ? 'bg-[var(--bg-secondary)]' : 'bg-teal-50/50'
              "
            >
              <div class="flex items-center gap-2">
                <lucide-icon
                  [name]="
                    isSectionCollapsed($index)
                      ? ChevronRightIcon
                      : ChevronDownIcon
                  "
                  [size]="16"
                  [class]="
                    isDarkMode() ? 'text-[var(--accent-teal)]' : 'text-teal-600'
                  "
                />
                <span
                  class="text-sm font-bold uppercase tracking-wide transition-colors duration-300"
                  [class]="
                    isDarkMode()
                      ? 'text-[var(--text-primary)]'
                      : 'text-slate-900'
                  "
                >
                  {{ section.title }}
                </span>
              </div>
            </td>
          </tr>
          } @else {
          <!-- Non-collapsible Section Header -->
          <tr
            class="border-b transition-colors duration-300"
            [class]="
              isDarkMode()
                ? 'bg-[var(--bg-secondary)] border-[var(--border-color)]'
                : 'bg-teal-50/50 border-slate-200'
            "
          >
            <td
              class="sticky left-0 z-10 px-4 py-3 transition-colors duration-300"
              [attr.colspan]="visibleHeaders().length + 1"
              [class]="
                isDarkMode() ? 'bg-[var(--bg-secondary)]' : 'bg-teal-50/50'
              "
            >
              <span
                class="text-sm font-bold uppercase tracking-wide transition-colors duration-300"
                [class]="
                  isDarkMode() ? 'text-[var(--text-primary)]' : 'text-slate-900'
                "
              >
                {{ section.title }}
              </span>
            </td>
          </tr>
          }

          <!-- Section Rows (Show if not collapsed) -->
          @if (!section.isCollapsible || !isSectionCollapsed($index)) { @for
          (row of section.rows; track trackByRow($index, row)) {
          <tr
            class="border-b transition-colors duration-200 hover:opacity-80"
            [class]="getRowClasses(row)"
          >
            <!-- Row Label Cell -->
            <td
              class="sticky left-0 z-10 px-4 py-3 text-sm transition-colors duration-300"
              [class]="
                isDarkMode()
                  ? 'bg-[var(--bg-secondary)] text-[var(--text-primary)]'
                  : 'bg-white text-slate-900'
              "
            >
              <div class="flex items-center gap-2">
                <span [class.font-semibold]="row.isBold || row.isTotal">
                  {{ row.label }}
                </span>

                @if (row.isCalculated) {
                <lucide-icon
                  [name]="LockIcon"
                  [size]="14"
                  [class]="
                    isDarkMode()
                      ? 'text-[var(--text-tertiary)]'
                      : 'text-slate-400'
                  "
                  title="Auto-calculated field"
                />
                }
              </div>
            </td>

            <!-- Data Cells (Filtered by Year Window) -->
            @for (value of getVisibleRowValues(row.values); track
            trackByColumn($index, visibleHeaders()[$index])) {
            <td class="px-4 py-3 min-w-[140px] transition-colors duration-300">
              @if (isRowEditable(row)) {
              <!-- Editable Cell (Edit Mode) -->
              <input
                type="text"
                [value]="formatNumber(value)"
                (blur)="onCellChange($index, $index, $index, $event)"
                (focus)="onInputFocus($event)"
                (keydown.enter)="onEnterKey($event)"
                [class]="isDarkMode() ? 'dark-mode-input' : 'light-mode-input'"
                class="w-full px-3 py-2 text-right rounded-lg font-mono transition-all duration-200 focus:ring-2 focus:outline-none"
                style="font-size: 14px !important"
              />
              } @else {
              <!-- Read-only Cell -->
              <div
                [class]="getCellClasses(row, value)"
                class="px-3 py-2 text-sm font-mono text-right transition-colors duration-300"
                style="font-size: 14px !important"
              >
                @if (value < 0) {
                <span
                  [class]="
                    isDarkMode()
                      ? 'text-[var(--accent-negative)]'
                      : 'text-red-700'
                  "
                >
                  ({{ formatNumber(Math.abs(value)) }})
                </span>
                } @else {
                <span
                  [class]="
                    isDarkMode()
                      ? 'text-[var(--text-primary)]'
                      : 'text-slate-700'
                  "
                >
                  {{ formatNumber(value) }}
                </span>
                }
              </div>
              }
            </td>
            }
          </tr>
          } } }
        </tbody>
      </table>

      <!-- Empty State -->
      @if (sections.length === 0) {
      <div
        class="text-center py-12 transition-colors duration-300"
        [class]="
          isDarkMode() ? 'text-[var(--text-tertiary)]' : 'text-slate-500'
        "
      >
        <p class="text-sm">No data available</p>
      </div>
      }
    </div>
  </div>
</div>

<!-- Dark Mode Styles -->
<style>
  :host-context(.dark-mode) {
    --text-color: var(--text-primary);
    --bg-color: var(--bg-primary);
  }

  .dark-mode-input {
    @apply bg-[var(--input-bg)] border border-[var(--input-border)] text-[var(--input-text)] placeholder-[var(--text-tertiary)];
    @apply focus:ring-[var(--accent-teal)] focus:border-transparent;
  }

  .light-mode-input {
    @apply bg-white border border-slate-200 text-slate-900 placeholder-slate-400;
    @apply focus:ring-teal-500 focus:border-transparent;
  }

  .scrollbar-hide {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }

  .scrollbar-hide::-webkit-scrollbar {
    display: none;
  }

  /* Advanced dark mode glow effects */
  :global(.dark-mode-active) {
    color-scheme: dark;
  }

  :global(.dark-mode-active) table th {
    text-shadow: 0 0 8px rgba(0, 217, 255, 0.2);
  }

  :global(.dark-mode-active) table td {
    border-bottom-color: var(--border-color);
  }

  /* Neon glow on positive/negative values in advanced mode */
  :global(.dark-mode-active) .text-\[var\(--accent-positive\)\] {
    text-shadow: 0 0 6px rgba(0, 255, 127, 0.4);
  }

  :global(.dark-mode-active) .text-\[var\(--accent-negative\)\] {
    text-shadow: 0 0 6px rgba(255, 51, 51, 0.4);
  }
</style>
