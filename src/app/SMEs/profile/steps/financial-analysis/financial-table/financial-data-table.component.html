<!-- src/app/SMEs/profile/steps/financial-analysis/financial-table/financial-data-table.component.html -->

<div class="space-y-4">
  <!-- Year Navigation Bar -->
  <div
    class="flex items-center justify-between bg-white rounded-xl border border-slate-200 px-6 py-4"
  >
    <div class="flex items-center gap-4">
      <button
        (click)="goToPreviousYears()"
        [disabled]="!canGoPrevious()"
        class="px-3 py-2 text-sm font-medium text-slate-600 hover:bg-slate-100 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
      >
        ← Previous
      </button>

      <span class="text-sm font-semibold text-slate-900 min-w-32 text-center">
        {{ yearRangeText() }}
      </span>

      <button
        (click)="goToNextYears()"
        [disabled]="!canGoNext()"
        class="px-3 py-2 text-sm font-medium text-slate-600 hover:bg-slate-100 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
      >
        Next →
      </button>
    </div>

    <div class="text-xs text-slate-500">
      Showing {{ visibleYearHeaders().length }} of
      {{ columnHeaders.length }} years
    </div>
  </div>

  <!-- Sections -->
  @for (section of sections; track trackBySection($index, section)) {

  <!-- Skip rendering sections with no rows (visual labels were removed) -->
  @if (section.rows.length > 0) {

  <!-- Spacing Before This Section -->
  @if (section.spacingBefore) {
  <div [class]="getSpacingBeforeClasses(section.spacingBefore)"></div>
  }

  <!-- Section Container -->
  <div class="bg-white rounded-2xl border border-slate-200 overflow-hidden">
    <!-- Section Header (clickable if collapsible) -->
    <div
      class="px-6 py-4 border-b border-slate-200 bg-slate-50 flex items-center justify-between"
      [class.cursor-pointer]="section.isCollapsible"
      [class.hover:bg-slate-100]="section.isCollapsible"
      (click)="section.isCollapsible && toggleSection($index)"
    >
      <div class="flex items-center gap-3">
        <!-- Collapse Icon (only if collapsible) -->
        @if (section.isCollapsible) {
        <button
          (click)="toggleSection($index); $event.stopPropagation()"
          class="p-1 hover:bg-slate-200 rounded transition-colors"
          [attr.aria-expanded]="!isSectionCollapsed($index)"
        >
          @if (isSectionCollapsed($index)) {
          <lucide-icon
            [name]="ChevronRightIcon"
            [size]="18"
            class="text-slate-600"
          />
          } @else {
          <lucide-icon
            [name]="ChevronDownIcon"
            [size]="18"
            class="text-slate-600"
          />
          }
        </button>
        }

        <!-- Section Title -->
        <h3 class="text-base font-semibold text-slate-900">
          {{ section.title }}
        </h3>

        <!-- Accent Color Indicator (for ratios) -->
        @if (section.accentColor === 'orange') {
        <div class="ml-2 w-2 h-2 rounded-full bg-amber-500"></div>
        }
      </div>
    </div>

    <!-- Section Rows (shown unless collapsed) -->
    @if (!isSectionCollapsed($index)) {
    <table class="w-full">
      <!-- Column Headers -->
      <thead class="bg-white">
        <tr class="border-b border-slate-200">
          <th
            class="text-left px-6 py-3 font-semibold text-slate-900 text-sm"
          ></th>

          @for (header of visibleYearHeaders(); track trackByHeader($index,
          header)) {
          <th
            class="text-right px-4 py-3 font-semibold text-slate-900 text-sm min-w-24"
          >
            {{ header }}
          </th>
          }
        </tr>
      </thead>

      <!-- Data Rows -->
      <tbody>
        @for (row of section.rows; track trackByRow($index, row)) {
        <tr [class]="getRowClasses(row, true)">
          <!-- Label Cell -->
          <td [class]="'px-6 py-3 text-left ' + getLabelClasses(row)">
            <div class="flex items-center gap-2">
              <span class="flex-1">{{ row.label }}</span>

              <!-- Lock Icon for Non-Editable Rows -->
              @if (!row.editable || row.isCalculated) {
              <lucide-icon
                [name]="LockIcon"
                [size]="16"
                class="text-slate-400 flex-shrink-0"
              />
              }
            </div>
          </td>

          <!-- Data Cells -->
          @for (value of getVisibleRowValues(row.values); track
          trackByHeader($index, $index.toString())) {
          <td [class]="getCellClasses(row, value)">
            @if (isRowEditable(row)) {
            <!-- Editable Input -->
            <input
              type="text"
              [value]="formatNumber(value, row)"
              (change)="onCellChange($index, $index, $index, $event)"
              (focus)="onInputFocus($event)"
              (keydown.enter)="onEnterKey($event)"
              class="w-full text-right px-2 py-1 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 bg-white hover:border-slate-300 transition-colors"
            />
            } @else {
            <!-- Read-Only Display -->
            <span>{{ formatNumber(value, row) }}</span>
            }
          </td>
          }
        </tr>
        }
      </tbody>
    </table>
    }
  </div>

  <!-- Spacing After This Section -->
  @if (section.spacingAfter) {
  <div [class]="getSpacingAfterClasses(section.spacingAfter)"></div>
  } } }
</div>
