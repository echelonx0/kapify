<!-- src/app/profile/steps/business-info.component.html -->
<div class="space-y-6 ml-8">
 

  <!-- Auto-save Status Header -->
  <div class="bg-white rounded-lg border border-neutral-200 p-4">
    <div class="flex items-center justify-between">
      <div class="text-sm text-neutral-600">
        Business assessment for funding evaluation
      </div>
      <div class="flex items-center space-x-4">
        <!-- Auto-save status -->
        <div class="flex items-center space-x-2 text-sm">
          @if (isSaving()) {
            <lucide-icon [img]="ClockIcon" [size]="16" class="text-orange-500 animate-spin" />
            <span class="text-orange-600">Saving...</span>
          } @else if (lastSaved()) {
            <lucide-icon [img]="SaveIcon" [size]="16" class="text-green-500" />
            <span class="text-green-600">Saved {{ getLastSavedText() }}</span>
          } @else {
            <span class="text-neutral-500">Not saved</span>
          }
        </div>
        <!-- Manual save button -->
        <ui-button 
          variant="primary" 
          size="sm" 
          (clicked)="saveManually()"
          [disabled]="isSaving()"
        >
          @if (isSaving()) {
            <lucide-icon [img]="ClockIcon" [size]="16" class="mr-2 animate-spin" />
            Saving...
          } @else {
            Save Changes
          }
        </ui-button>
      </div>
    </div>
  </div>

  <form [formGroup]="businessAssessmentForm" class="space-y-6">
    
    <!-- Back Office Section -->
    <div class="bg-white rounded-lg border border-neutral-200">
      <button
        type="button"
        (click)="toggleSection('backOffice')"
        class="w-full px-6 py-4 text-left flex items-center justify-between hover:bg-neutral-50 transition-colors"
      >
        <div>
          <h3 class="text-lg font-semibold text-neutral-900">Back Office</h3>
          <p class="text-sm text-neutral-600 mt-1">
            Please provide details about the back-office environment of the business.
          </p>
        </div>
        <lucide-icon 
          [img]="getSectionExpanded('backOffice') ? ChevronUpIcon : ChevronDownIcon" 
          [size]="20" 
          class="text-neutral-400"
        />
      </button>

      @if (getSectionExpanded('backOffice')) {
        <div class="px-6 pb-6 border-t border-neutral-200">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
            
            <!-- Accounting System -->
            <div>
              <label class="block text-sm font-medium text-neutral-700 mb-2">
                Provide the name of your current accounting system
              </label>
              <select 
                formControlName="accountingSystem"
                class="block w-full px-3 py-2 border border-neutral-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 sm:text-sm"
              >
                <option value="">Select accounting system</option>
                <option value="sage-business-cloud">Sage Business Cloud</option>
                <option value="sage-evolution">Sage Evolution</option>
                <option value="sage-pastel">Sage Pastel</option>
                <option value="quickbooks">QuickBooks</option>
                <option value="xero">Xero</option>
                <option value="pastel-partner">Pastel Partner</option>
                <option value="other">Other</option>
                <option value="manual">Manual/Spreadsheet</option>
              </select>
              @if (getFieldError('accountingSystem')) {
                <p class="text-sm text-red-600 mt-1">{{ getFieldError('accountingSystem') }}</p>
              }
            </div>

            <!-- Payroll System -->
            <div>
              <label class="block text-sm font-medium text-neutral-700 mb-2">
                Please provide the name of the payroll system in place
              </label>
              <select 
                formControlName="payrollSystem"
                class="block w-full px-3 py-2 border border-neutral-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 sm:text-sm"
              >
                <option value="">Select payroll system</option>
                <option value="sage-payroll">Sage Payroll</option>
                <option value="simplypay">SimplePay</option>
                <option value="payspace">PaySpace</option>
                <option value="smartpay">SmartPay</option>
                <option value="outsourced">Outsourced</option>
                <option value="manual">Manual</option>
                <option value="other">Other</option>
              </select>
              @if (getFieldError('payrollSystem')) {
                <p class="text-sm text-red-600 mt-1">{{ getFieldError('payrollSystem') }}</p>
              }
            </div>

            <!-- Finance Function -->
            <div>
              <label class="block text-sm font-medium text-neutral-700 mb-2">
                Are the accounting and finance functions performed internally or by external consultants?
              </label>
              <select 
                formControlName="financeFunction"
                class="block w-full px-3 py-2 border border-neutral-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 sm:text-sm"
              >
                <option value="">Select option</option>
                <option value="in-house">In house</option>
                <option value="external">External consultants</option>
                <option value="hybrid">Combination of both</option>
              </select>
              @if (getFieldError('financeFunction')) {
                <p class="text-sm text-red-600 mt-1">{{ getFieldError('financeFunction') }}</p>
              }
            </div>

            <!-- Finance Staff Count -->
            <div>
              <label class="block text-sm font-medium text-neutral-700 mb-2">
                If finance functions are performed internally how many people are working in the finance department?
              </label>
              <input
                type="number"
                formControlName="financeStaffCount"
                placeholder="3"
                min="0"
                class="block w-full px-3 py-2 border border-neutral-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 sm:text-sm"
              />
              @if (getFieldError('financeStaffCount')) {
                <p class="text-sm text-red-600 mt-1">{{ getFieldError('financeStaffCount') }}</p>
              }
            </div>

            <!-- Financial Manager -->
            <div>
              <label class="block text-sm font-medium text-neutral-700 mb-2">
                Do you have a financial manager and or financial director.
              </label>
              <select 
                formControlName="hasFinancialManager"
                class="block w-full px-3 py-2 border border-neutral-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 sm:text-sm"
              >
                <option value="">Select option</option>
                <option value="yes">Yes</option>
                <option value="no">No</option>
              </select>
              @if (getFieldError('hasFinancialManager')) {
                <p class="text-sm text-red-600 mt-1">{{ getFieldError('hasFinancialManager') }}</p>
              }
            </div>

            <!-- Total Staff -->
            <div>
              <label class="block text-sm font-medium text-neutral-700 mb-2">
                What is the total staff compliment of the company?
              </label>
              <input
                type="number"
                formControlName="totalStaffCount"
                placeholder="10"
                min="1"
                class="block w-full px-3 py-2 border border-neutral-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 sm:text-sm"
              />
              @if (getFieldError('totalStaffCount')) {
                <p class="text-sm text-red-600 mt-1">{{ getFieldError('totalStaffCount') }}</p>
              }
            </div>
          </div>

          <!-- HR Functions (full width) -->
          <div class="mt-6">
            <label class="block text-sm font-medium text-neutral-700 mb-2">
              Are the HR functions outsources or inhouse? (Such as Recruitment and Selection, Training and Development, 
              Performance Management, Employee Relations, Employment Law and Compliance, Compensation and Benefits 
              and Administration, Payroll & HR Systems)
            </label>
            <select 
              formControlName="hrFunctions"
              class="block w-full px-3 py-2 border border-neutral-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 sm:text-sm"
            >
              <option value="">Select option</option>
              <option value="outsourced">Outsourced</option>
              <option value="in-house">In-house</option>
              <option value="hybrid">Combination</option>
            </select>
            @if (getFieldError('hrFunctions')) {
              <p class="text-sm text-red-600 mt-1">{{ getFieldError('hrFunctions') }}</p>
            }
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
            <!-- Policies and Procedures -->
            <div>
              <label class="block text-sm font-medium text-neutral-700 mb-2">
                Do you have policies and procedures? (finance, HR, etc)
              </label>
              <select 
                formControlName="hasPoliciesAndProcedures"
                class="block w-full px-3 py-2 border border-neutral-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 sm:text-sm"
              >
                <option value="">Select option</option>
                <option value="yes">Yes</option>
                <option value="no">No</option>
              </select>
              @if (getFieldError('hasPoliciesAndProcedures')) {
                <p class="text-sm text-red-600 mt-1">{{ getFieldError('hasPoliciesAndProcedures') }}</p>
              }
            </div>

            <!-- Policy Review Frequency -->
            @if (businessAssessmentForm.get('hasPoliciesAndProcedures')?.value === 'yes') {
              <div>
                <label class="block text-sm font-medium text-neutral-700 mb-2">
                  If Yes how often are these policies and procedures reviewed?
                </label>
                <select 
                  formControlName="policyReviewFrequency"
                  class="block w-full px-3 py-2 border border-neutral-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 sm:text-sm"
                >
                  <option value="">Select frequency</option>
                  <option value="annually">Annually</option>
                  <option value="biannually">Biannually</option>
                  <option value="quarterly">Quarterly</option>
                  <option value="as-needed">As needed</option>
                  <option value="never">Never reviewed</option>
                </select>
                @if (getFieldError('policyReviewFrequency')) {
                  <p class="text-sm text-red-600 mt-1">{{ getFieldError('policyReviewFrequency') }}</p>
                }
              </div>
            }

            <!-- Asset Insurance -->
            <div>
              <label class="block text-sm font-medium text-neutral-700 mb-2">
                Are all company assets adequately insured?
              </label>
              <select 
                formControlName="assetsInsured"
                class="block w-full px-3 py-2 border border-neutral-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 sm:text-sm"
              >
                <option value="">Select option</option>
                <option value="yes">Yes</option>
                <option value="no">No</option>
                <option value="partially">Partially</option>
              </select>
              @if (getFieldError('assetsInsured')) {
                <p class="text-sm text-red-600 mt-1">{{ getFieldError('assetsInsured') }}</p>
              }
            </div>

            <!-- Critical Systems -->
            <div>
              <label class="block text-sm font-medium text-neutral-700 mb-2">
                What other critical system are in place to aid the back office functions?
              </label>
              <input
                type="text"
                formControlName="criticalSystems"
                placeholder="None"
                class="block w-full px-3 py-2 border border-neutral-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 sm:text-sm"
              />
              <p class="text-xs text-neutral-500 mt-1">Optional - describe any additional systems</p>
            </div>
          </div>
        </div>
      }
    </div>

    <!-- Financial Statements Section -->
    <div class="bg-white rounded-lg border border-neutral-200">
      <button
        type="button"
        (click)="toggleSection('financialStatements')"
        class="w-full px-6 py-4 text-left flex items-center justify-between hover:bg-neutral-50 transition-colors"
      >
        <div>
          <h3 class="text-lg font-semibold text-neutral-900">Financial Statements</h3>
          <p class="text-sm text-neutral-600 mt-1">
            Please provide information that will assist in understanding the recording keeping in the business.
          </p>
        </div>
        <lucide-icon 
          [img]="getSectionExpanded('financialStatements') ? ChevronUpIcon : ChevronDownIcon" 
          [size]="20" 
          class="text-neutral-400"
        />
      </button>

      @if (getSectionExpanded('financialStatements')) {
        <div class="px-6 pb-6 border-t border-neutral-200">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
            
            <!-- Financial Statements Audited -->
            <div>
              <label class="block text-sm font-medium text-neutral-700 mb-2">
                Have the financial statements been audited or reviewed?
              </label>
              <select 
                formControlName="financialStatementsAudited"
                class="block w-full px-3 py-2 border border-neutral-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 sm:text-sm"
              >
                <option value="">Select option</option>
                <option value="audited">Audited</option>
                <option value="reviewed">Reviewed</option>
                <option value="neither">Neither</option>
              </select>
              @if (getFieldError('financialStatementsAudited')) {
                <p class="text-sm text-red-600 mt-1">{{ getFieldError('financialStatementsAudited') }}</p>
              }
            </div>

            <!-- Budget Available -->
            <div>
              <label class="block text-sm font-medium text-neutral-700 mb-2">
                Is the latest budget or financial projection available?
              </label>
              <select 
                formControlName="budgetAvailable"
                class="block w-full px-3 py-2 border border-neutral-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 sm:text-sm"
              >
                <option value="">Select option</option>
                <option value="yes">Yes</option>
                <option value="no">No</option>
              </select>
              @if (getFieldError('budgetAvailable')) {
                <p class="text-sm text-red-600 mt-1">{{ getFieldError('budgetAvailable') }}</p>
              }
            </div>

            <!-- Long Term Contracts -->
            <div>
              <label class="block text-sm font-medium text-neutral-700 mb-2">
                Are there any long term contracts which could give rise to liabilities?
              </label>
              <select 
                formControlName="longTermContracts"
                class="block w-full px-3 py-2 border border-neutral-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 sm:text-sm"
              >
                <option value="">Select option</option>
                <option value="yes">Yes</option>
                <option value="no">No</option>
              </select>
              @if (getFieldError('longTermContracts')) {
                <p class="text-sm text-red-600 mt-1">{{ getFieldError('longTermContracts') }}</p>
              }
            </div>

            <!-- Off Balance Sheet Funding -->
            <div>
              <label class="block text-sm font-medium text-neutral-700 mb-2">
                Do you have any off balance sheet funding in any form or manner?
              </label>
              <select 
                formControlName="offBalanceSheetFunding"
                class="block w-full px-3 py-2 border border-neutral-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 sm:text-sm"
              >
                <option value="">Select option</option>
                <option value="yes">Yes</option>
                <option value="no">No</option>
              </select>
              @if (getFieldError('offBalanceSheetFunding')) {
                <p class="text-sm text-red-600 mt-1">{{ getFieldError('offBalanceSheetFunding') }}</p>
              }
            </div>
          </div>

          <!-- Asset Register (full width) -->
          <div class="mt-6">
            <label class="block text-sm font-medium text-neutral-700 mb-2">
              Is the latest asset register available (please ensure that the following info as a minimum is captured on the register 
              name of asset, date of purchase, date of first use, write off period, method of write off, book value, cost of the asset, 
              remaining useful life)?
            </label>
            <select 
              formControlName="assetRegisterAvailable"
              class="block w-full px-3 py-2 border border-neutral-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 sm:text-sm"
            >
              <option value="">Select option</option>
              <option value="yes">Yes</option>
              <option value="no">No</option>
              <option value="partial">Partially available</option>
            </select>
            @if (getFieldError('assetRegisterAvailable')) {
              <p class="text-sm text-red-600 mt-1">{{ getFieldError('assetRegisterAvailable') }}</p>
            }
          </div>

          <!-- Lender Permissions -->
          <div class="mt-6">
            <label class="block text-sm font-medium text-neutral-700 mb-2">
              Please confirm if any permissions are required from any lender prior to raising additional finance and registration/taking security.
            </label>
            <select 
              formControlName="lenderPermissionsRequired"
              class="block w-full px-3 py-2 border border-neutral-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 sm:text-sm"
            >
              <option value="">Select option</option>
              <option value="yes">Yes</option>
              <option value="no">No</option>
              <option value="not-applicable">Not applicable</option>
            </select>
            @if (getFieldError('lenderPermissionsRequired')) {
              <p class="text-sm text-red-600 mt-1">{{ getFieldError('lenderPermissionsRequired') }}</p>
            }
          </div>
        </div>
      }
    </div>
  </form>

  <!-- Progress Summary -->
  <div class="bg-white rounded-lg border border-neutral-200 p-4">
    <div class="flex items-center justify-between">
      <div>
        <h3 class="font-semibold text-neutral-900">Business Assessment Progress</h3>
        <p class="text-sm text-neutral-600">
          {{ getCompletionPercentage() }}% complete - Data auto-saves every 30 seconds
        </p>
      </div>
      
      <div class="flex items-center space-x-4">
        @if (isBackOfficeComplete() && isFinancialStatementsComplete()) {
          <div class="flex items-center space-x-2 text-green-600">
            <div class="w-2 h-2 bg-green-500 rounded-full"></div>
            <span class="font-medium text-sm">Complete</span>
          </div>
        } @else {
          <div class="bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full text-sm font-medium">
            {{ getCompletionPercentage() }}% Complete
          </div>
        }
      </div>
    </div>

    <!-- Section completion indicators -->
    <div class="mt-4 grid grid-cols-2 gap-4 text-sm">
      <div class="flex items-center space-x-2">
        @if (isBackOfficeComplete()) {
          <div class="w-2 h-2 bg-green-500 rounded-full"></div>
          <span class="text-green-600">Back Office Complete</span>
        } @else {
          <div class="w-2 h-2 bg-yellow-500 rounded-full"></div>
          <span class="text-yellow-600">Back Office Incomplete</span>
        }
      </div>
      <div class="flex items-center space-x-2">
        @if (isFinancialStatementsComplete()) {
          <div class="w-2 h-2 bg-green-500 rounded-full"></div>
          <span class="text-green-600">Financial Statements Complete</span>
        } @else {
          <div class="w-2 h-2 bg-yellow-500 rounded-full"></div>
          <span class="text-yellow-600">Financial Statements Incomplete</span>
        }
      </div>
    </div>
  </div>

  <!-- Final auto-save indicator -->
  @if (isSaving()) {
    <div class="text-sm text-neutral-500 flex items-center justify-center">
      <div class="w-2 h-2 bg-primary-500 rounded-full animate-pulse mr-2"></div>
      Saving changes...
    </div>
  } @else if (lastSaved()) {
    <div class="text-sm text-neutral-500 text-center">
      ✓ Changes saved automatically
    </div>
  }

  <!-- Navigation -->
  <div class="flex justify-between pt-6">
    <ui-button variant="outline" (clicked)="goBack()">
      ← Back
    </ui-button>
    <ui-button 
      variant="primary" 
      (clicked)="saveAndContinue()"
      [disabled]="isSaving()"
    >
      @if (isBackOfficeComplete() && isFinancialStatementsComplete()) {
        Save and Continue →
      } @else {
        Save Progress →
      }
    </ui-button>
  </div>
</div>