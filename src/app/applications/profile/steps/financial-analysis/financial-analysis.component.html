<!-- src/app/profile/steps/financial-analysis/financial-analysis.component.html -->
<div class="space-y-6">
  <!-- Header with Auto-save Status -->
  <div class="bg-white rounded-lg border border-neutral-200 p-4">
    <div class="flex items-center justify-between">
    
      <div class="flex items-center space-x-4">
        <!-- Auto-save status -->
        <div class="flex items-center space-x-2 text-sm">
          @if (isSaving()) {
            <lucide-icon [img]="ClockIcon" [size]="16" class="text-orange-500 animate-spin" />
            <span class="text-orange-600">Saving...</span>
          } @else if (lastSaved()) {
            <lucide-icon [img]="SaveIcon" [size]="16" class="text-green-500" />
            <span class="text-green-600">Saved {{ getLastSavedText() }}</span>
          } @else {
            <span class="text-neutral-500">Not saved</span>
          }
        </div>
        <!-- Manual save button -->
        <ui-button 
          variant="outline" 
          size="sm" 
          (clicked)="saveManually()"
          [disabled]="isSaving()"
        >
          @if (isSaving()) {
            <lucide-icon [img]="ClockIcon" [size]="16" class="mr-2 animate-spin" />
            Saving...
          } @else {
            Save Now
          }
        </ui-button>
      </div>
    </div>
  </div>

  <!-- Template Upload Section -->
  <div class="bg-primary-50 border border-primary-200 rounded-lg p-6">
    <div class="flex items-start space-x-3">
      <div class="flex-shrink-0">
        <div class="w-8 h-8 bg-primary-100 rounded-full flex items-center justify-center">
          <lucide-icon [img]="FileSpreadsheetIcon" [size]="16" class="text-primary-600" />
        </div>
      </div>
      <div class="flex-1">
        <h3 class="text-sm font-medium text-primary-800 mb-2">Import data with spreadsheet file</h3>
        <p class="text-sm text-primary-700 mb-4">
          Use <button class="underline hover:no-underline font-medium" (click)="downloadTemplate()">this template</button> 
          with predefined columns and rows to fill in the dataset for the financial ratios below.
        </p>
        
        @if (uploadedTemplate()) {
          <div class="bg-white rounded-lg p-4 border border-primary-200">
            <div class="flex items-center justify-between">
              <div class="flex items-center space-x-3">
                <lucide-icon [img]="FileSpreadsheetIcon" [size]="20" class="text-green-600" />
                <div>
                  <div class="text-sm font-medium text-neutral-900">{{ uploadedTemplate()?.name }}</div>
                  <div class="text-xs text-neutral-500">{{ formatFileSize(uploadedTemplate()?.size || 0) }}</div>
                </div>
              </div>
              <div class="flex items-center space-x-2">
                <button
                  (click)="downloadTemplate()"
                  class="text-primary-600 hover:text-primary-700 p-1"
                  title="Download Template"
                >
                  <lucide-icon [img]="DownloadIcon" [size]="16" />
                </button>
                <button
                  (click)="toggleEditMode()"
                  class="text-blue-600 hover:text-blue-700 p-1"
                  title="Edit Data"
                >
                  <lucide-icon [img]="EditIcon" [size]="16" />
                </button>
                <button
                  (click)="removeTemplate()"
                  class="text-red-600 hover:text-red-700 p-1"
                  title="Remove"
                >
                  Ã—
                </button>
              </div>
            </div>
          </div>
        } @else {
          <div class="relative">
            <div 
              class="border-2 border-dashed border-primary-300 rounded-lg p-6 text-center hover:border-primary-400 hover:bg-primary-50 transition-all cursor-pointer"
              (dragover)="onDragOver($event)"
              (dragleave)="onDragLeave($event)"
              (drop)="onDrop($event)"
            >
              <lucide-icon [img]="UploadIcon" [size]="32" class="text-primary-400 mx-auto mb-3" />
              <p class="text-sm text-primary-700 mb-1">Click to upload or drag and drop</p>
              <p class="text-xs text-primary-600">Excel files (.xlsx, .xls) or CSV files up to 10MB</p>
            </div>
            <input
              type="file"
              accept=".xlsx,.xls,.csv"
              (change)="onFileSelected($event)"
              class="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
            />
          </div>
        }
      </div>
    </div>
  </div>

  <!-- Financial Tables -->
  @if (hasFinancialData()) {
    <!-- Edit Mode Toggle -->
    @if (uploadedTemplate()) {
      <div class="flex items-center justify-between bg-blue-50 border border-blue-200 rounded-lg p-4">
        <div class="flex items-center space-x-2">
          <lucide-icon [img]="EditIcon" [size]="16" class="text-blue-600" />
          <span class="text-sm font-medium text-blue-800">
            @if (editingMode()) {
              Editing Mode: Click on editable cells to modify values
            } @else {
              View Mode: Data imported from spreadsheet
            }
          </span>
        </div>
        <ui-button
          variant="outline"
          size="sm"
          (clicked)="toggleEditMode()"
        >
          @if (editingMode()) {
            Exit Edit Mode
          } @else {
            Edit Data
          }
        </ui-button>
      </div>
    }

    <!-- Income Statement -->
    <ui-card [padding]="false">
      <div class="px-6 py-4 border-b border-neutral-200">
        <div class="flex items-center justify-between">
          <h3 class="text-lg font-semibold text-neutral-900">Income Statement</h3>
          <span class="text-sm text-neutral-500">Financial Analysis</span>
        </div>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-neutral-200">
          <thead class="bg-neutral-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-neutral-500 uppercase">Amounts in Rand</th>
              <th class="px-6 py-3 text-center text-xs font-medium text-neutral-500 uppercase" colspan="3">Actuals (History)</th>
              <th class="px-6 py-3 text-center text-xs font-medium text-neutral-500 uppercase">Current</th>
              <th class="px-6 py-3 text-center text-xs font-medium text-neutral-500 uppercase" colspan="4">Budget (Projections)</th>
            </tr>
            <tr class="bg-neutral-50 border-t border-neutral-200">
              <th class="px-6 py-2 text-left text-xs font-medium text-neutral-500">Financial Year</th>
              <th class="px-6 py-2 text-center text-xs font-medium text-neutral-500">2020/21</th>
              <th class="px-6 py-2 text-center text-xs font-medium text-neutral-500">2021/22</th>
              <th class="px-6 py-2 text-center text-xs font-medium text-neutral-500">2022/23</th>
              <th class="px-6 py-2 text-center text-xs font-medium text-neutral-500">2023/24</th>
              <th class="px-6 py-2 text-center text-xs font-medium text-neutral-500">2024/25</th>
              <th class="px-6 py-2 text-center text-xs font-medium text-neutral-500">2025/26</th>
              <th class="px-6 py-2 text-center text-xs font-medium text-neutral-500">2026/27</th>
              <th class="px-6 py-2 text-center text-xs font-medium text-neutral-500">2027/28</th>
              <th class="px-6 py-2 text-center text-xs font-medium text-neutral-500">2028/29</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-neutral-200">
            @for (row of incomeStatementData(); track row.label; let rowIndex = $index) {
              <tr class="hover:bg-neutral-50" [class.bg-blue-50]="!row.editable && editingMode()">
                <td class="px-6 py-3 text-sm font-medium text-neutral-900">
                  {{ row.label }}
                  @if (!row.editable) {
                    <span class="text-xs text-blue-600 ml-1">(calculated)</span>
                  }
                </td>
                @for (value of row.values; track $index; let colIndex = $index) {
                  <td class="px-6 py-3 text-sm text-neutral-900 text-right">
                    @if (editingMode() && row.editable) {
                      <input
                        type="number"
                        [value]="value"
                        (change)="updateCellValue(rowIndex, colIndex, +$any($event.target).value, false)"
                        class="w-full text-right border-0 bg-transparent focus:bg-white focus:border focus:border-blue-300 focus:rounded px-1 py-0.5"
                        step="0.01"
                      />
                    } @else {
                      <span [class.text-blue-600]="!row.editable && editingMode()">
                        {{ formatCurrency(value) }}
                      </span>
                    }
                  </td>
                }
              </tr>
            }
          </tbody>
        </table>
      </div>
    </ui-card>

    <!-- Financial Ratios -->
    <ui-card [padding]="false">
      <div class="px-6 py-4 border-b border-neutral-200">
        <div class="flex items-center justify-between">
          <h3 class="text-lg font-semibold text-neutral-900">Financial Ratios</h3>
          <span class="text-sm text-neutral-500">Financial Analysis</span>
        </div>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-neutral-200">
          <thead class="bg-neutral-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-neutral-500 uppercase">Financial Ratios</th>
              <th class="px-6 py-3 text-center text-xs font-medium text-neutral-500 uppercase" colspan="3">Actuals (History)</th>
              <th class="px-6 py-3 text-center text-xs font-medium text-neutral-500 uppercase">Current</th>
              <th class="px-6 py-3 text-center text-xs font-medium text-neutral-500 uppercase" colspan="4">Budget (Projections)</th>
            </tr>
            <tr class="bg-neutral-50 border-t border-neutral-200">
              <th class="px-6 py-2 text-left text-xs font-medium text-neutral-500"></th>
              <th class="px-6 py-2 text-center text-xs font-medium text-neutral-500">2020/21</th>
              <th class="px-6 py-2 text-center text-xs font-medium text-neutral-500">2021/22</th>
              <th class="px-6 py-2 text-center text-xs font-medium text-neutral-500">2022/23</th>
              <th class="px-6 py-2 text-center text-xs font-medium text-neutral-500">2023/24</th>
              <th class="px-6 py-2 text-center text-xs font-medium text-neutral-500">2024/25</th>
              <th class="px-6 py-2 text-center text-xs font-medium text-neutral-500">2025/26</th>
              <th class="px-6 py-2 text-center text-xs font-medium text-neutral-500">2026/27</th>
              <th class="px-6 py-2 text-center text-xs font-medium text-neutral-500">2027/28</th>
              <th class="px-6 py-2 text-center text-xs font-medium text-neutral-500">2028/29</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-neutral-200">
            @for (row of financialRatiosData(); track row.label; let rowIndex = $index) {
              <tr class="hover:bg-neutral-50" [class.bg-green-50]="row.editable && editingMode()">
                <td class="px-6 py-3 text-sm font-medium text-neutral-900">
                  {{ row.label }}
                  @if (row.editable) {
                    <span class="text-xs text-green-600 ml-1">(editable)</span>
                  } @else {
                    <span class="text-xs text-blue-600 ml-1">(calculated)</span>
                  }
                </td>
                @for (value of row.values; track $index; let colIndex = $index) {
                  <td class="px-6 py-3 text-sm text-neutral-900 text-right">
                    @if (editingMode() && row.editable) {
                      <input
                        type="number"
                        [value]="value"
                        (change)="updateCellValue(rowIndex, colIndex, +$any($event.target).value, true)"
                        class="w-full text-right border-0 bg-transparent focus:bg-white focus:border focus:border-green-300 focus:rounded px-1 py-0.5"
                        step="0.01"
                      />
                    } @else {
                      <span [class.text-green-600]="row.editable && editingMode()" [class.text-blue-600]="!row.editable && editingMode()">
                        {{ formatRatio(value, row.type) }}
                      </span>
                    }
                  </td>
                }
              </tr>
            }
          </tbody>
        </table>
      </div>
    </ui-card>

    <!-- Notes Section -->
    <ui-card>
      <h3 class="text-lg font-semibold text-neutral-900 mb-4">Notes/Comments</h3>
      <div>
        <textarea
          [(ngModel)]="notesText"
          (ngModelChange)="saveNotes()"
          placeholder="Add any notes or comments about the financial analysis, key assumptions, or important observations..."
          rows="4"
          class="block w-full px-3 py-2 border border-neutral-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 sm:text-sm"
        ></textarea>
        <p class="text-xs text-neutral-500 mt-2">
          Auto-saves as you type. Use this space to explain any adjustments, assumptions, or context about your financial data.
        </p>
      </div>
    </ui-card>
  } @else {
    <!-- Empty State -->
    <div class="text-center py-12">
      <lucide-icon [img]="FileSpreadsheetIcon" [size]="48" class="text-neutral-400 mx-auto mb-4" />
      <h3 class="text-lg font-medium text-neutral-900 mb-2">No Financial Data</h3>
      <p class="text-neutral-600 mb-6 max-w-md mx-auto">
        Upload a financial template with your historical data and projections to begin your analysis. 
        The template includes predefined rows for income statement and financial ratios.
      </p>
      <div class="flex items-center justify-center space-x-4">
        <ui-button variant="outline" (clicked)="downloadTemplate()">
          <lucide-icon [img]="DownloadIcon" [size]="16" class="mr-2" />
          Download Template
        </ui-button>
        <ui-button variant="primary" (clicked)="triggerFileUpload()">
          <lucide-icon [img]="UploadIcon" [size]="16" class="mr-2" />
          Upload Financial Data
        </ui-button>
      </div>
    </div>
  }

  <!-- Progress Summary -->
  <div class="bg-white rounded-lg border border-neutral-200 p-4">
    <div class="flex items-center justify-between">
      <div>
        <h3 class="font-semibold text-neutral-900">Financial Analysis Progress</h3>
        <p class="text-sm text-neutral-600">
          @if (hasFinancialData()) {
            Financial data loaded. Auto-saves every 30 seconds.
          } @else {
            Upload financial data to complete this section.
          }
        </p>
      </div>
      
      <div class="flex items-center space-x-4">
        @if (hasFinancialData()) {
          <div class="flex items-center space-x-2 text-green-600">
            <div class="w-2 h-2 bg-green-500 rounded-full"></div>
            <span class="font-medium text-sm">Complete</span>
          </div>
        } @else {
          <div class="bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full text-sm font-medium">
            Pending Upload
          </div>
        }
      </div>
    </div>
  </div>

  <!-- Final auto-save indicator -->
  @if (isSaving()) {
    <div class="text-sm text-neutral-500 flex items-center justify-center">
      <div class="w-2 h-2 bg-primary-500 rounded-full animate-pulse mr-2"></div>
      Saving financial data...
    </div>
  } @else if (lastSaved()) {
    <div class="text-sm text-neutral-500 text-center">
      âœ“ Financial analysis saved automatically
    </div>
  }
</div>