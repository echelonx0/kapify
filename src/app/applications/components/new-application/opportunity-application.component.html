<!-- src/app/applications/components/new-application/opportunity-application.component.html - CLEANED VERSION -->
<div class="max-w-6xl mx-auto">
  <!-- Header -->
  <div class="mb-10 mt-10 border-b border-neutral-200 pb-6">
    <div class="flex items-center justify-between">
      <!-- Left side: Back + Title -->
      <div class="flex items-center space-x-4">
        <ui-button 
          variant="outline" 
          size="sm" 
          (click)="goBack()" 
          class="flex items-center"
        >
          <lucide-icon [img]="ArrowLeftIcon" [size]="16" class="mr-2" />
          Back
        </ui-button>
     
      </div>

      <!-- Right side: Save Draft -->
      <div>
        <ui-button 
          variant="outline" 
          size="sm" 
          (click)="saveDraft()" 
          [disabled]="isSaving()"
        >
          @if (isSaving()) {
            <lucide-icon [img]="ClockIcon" [size]="16" class="mr-2" />
            Saving...
          } @else {
            Save Draft
          }
        </ui-button>
      </div>
    </div>
  </div>

  <!-- Progress Steps - SIMPLIFIED -->
<!-- Progress Steps - FIXED LAYOUT -->
<div class="mb-8">
  <div class="flex items-center justify-between w-full">
    @for (step of steps(); track step.id) {
      <div class="flex items-center flex-1">
        <!-- Step Circle and Content -->
        <div class="flex items-center">
          <div [class]="getStepClasses(step.id)">
            {{ step.number }}
          </div>
          <div class="ml-3">
            <p [class]="getStepTextClasses(step.id)" class="font-medium">{{ step.title }}</p>
            <p class="text-xs text-neutral-500">{{ step.description }}</p>
          </div>
        </div>
        
        <!-- Connector Line (except for last step) -->
        @if (step.id !== 'review-submit') {
          <div class="flex-1 h-0.5 bg-neutral-200 mx-8"></div>
        }
      </div>
    }
  </div>
</div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <!-- Main Content - NO PROFILE VALIDATION -->
    <div class="lg:col-span-2">
      <ui-card>
        @if (error()) {
          <div class="mb-6 bg-red-50 border border-red-200 rounded-lg p-4">
            <div class="flex items-center">
              <lucide-icon [img]="AlertCircleIcon" [size]="20" class="text-red-600 mr-2" />
              <span class="text-red-800">{{ error() }}</span>
            </div>
          </div>
        }

        @switch (currentStep()) {
          @case ('select-opportunity') {
            <div class="space-y-6">
              <div class="flex items-center space-x-3 mb-6">
                <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                  <lucide-icon [img]="BuildingIcon" [size]="20" class="text-blue-600" />
                </div>
                <div>
                  <h3 class="text-lg font-semibold text-neutral-900">Select Funding Opportunity</h3>
                  <p class="text-sm text-neutral-600">Choose the opportunity you want to apply for</p>
                </div>
              </div>

              @if (isLoading()) {
                <div class="text-center py-12">
                  <div class="animate-spin w-8 h-8 border-2 border-primary-500 border-t-transparent rounded-full mx-auto mb-4"></div>
                  <p class="text-neutral-500">Loading opportunities...</p>
                </div>
              } @else if (availableOpportunities().length === 0) {
                <div class="text-center py-12">
                  <p class="text-neutral-500 mb-4">No active opportunities available at the moment.</p>
                  <ui-button variant="outline" (click)="goBack()">
                    Browse Opportunities
                  </ui-button>
                </div>
              } @else {
                <div class="space-y-4">
                  @for (opportunity of availableOpportunities(); track opportunity.id) {
                    <div 
                      class="border rounded-lg p-4 cursor-pointer transition-all duration-200 hover:border-primary-300 hover:shadow-sm"
                      [class.border-primary-500]="selectedOpportunity()?.id === opportunity.id"
                      [class.bg-primary-50]="selectedOpportunity()?.id === opportunity.id"
                      (click)="selectOpportunity(opportunity)"
                    >
                      <div class="flex justify-between items-start">
                        <div class="flex-1">
                          <h4 class="font-medium text-neutral-900">{{ opportunity.title }}</h4>
                          <p class="text-sm text-neutral-600 mt-1">{{ opportunity.shortDescription }}</p>
                          <div class="flex items-center space-x-4 mt-2 text-sm text-neutral-500">
                            <span class="capitalize">{{ opportunity.fundingType }}</span>
                            <span>{{ formatCurrency(opportunity.minInvestment) }} - {{ formatCurrency(opportunity.maxInvestment) }}</span>
                            <span>{{ getOrganizationName(opportunity) }}</span>
                          </div>
                        </div>
                        @if (selectedOpportunity()?.id === opportunity.id) {
                          <lucide-icon [img]="CheckCircleIcon" [size]="20" class="text-primary-600 ml-4" />
                        }
                      </div>
                    </div>
                  }
                </div>
              }
            </div>
          }

          @case ('application-details') {
            <div class="space-y-6">
              <div class="flex items-center space-x-3 mb-6">
                <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
                  <lucide-icon [img]="FileTextIcon" [size]="20" class="text-purple-600" />
                </div>
                <div>
                  <h3 class="text-lg font-semibold text-neutral-900">Application Details</h3>
                  <p class="text-sm text-neutral-600">Provide information specific to this opportunity</p>
                </div>
              </div>

              <div class="space-y-6">
                <div>
                  <label class="block text-sm font-medium text-neutral-700 mb-2">
                    Requested Amount <span class="text-red-500">*</span>
                  </label>
                  <input
                    type="number"
                    placeholder="0"
                    [value]="coverInformation().requestedAmount"
                    (input)="onRequestedAmountChange($event)"
                    [min]="selectedOpportunity()?.minInvestment"
                    [max]="selectedOpportunity()?.maxInvestment"
                    class="block w-full px-3 py-2 border border-neutral-300 rounded-md shadow-sm placeholder-neutral-400 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 sm:text-sm"
                  />
                  @if (getAmountValidationMessage()) {
                    <p class="mt-1 text-sm text-red-600">{{ getAmountValidationMessage() }}</p>
                  } @else {
                    <p class="mt-1 text-sm text-neutral-500">
                      Range: {{ formatCurrency(selectedOpportunity()?.minInvestment || 0) }} - {{ formatCurrency(selectedOpportunity()?.maxInvestment || 0) }}
                    </p>
                  }
                </div>

                <div>
                  <label class="block text-sm font-medium text-neutral-700 mb-2">
                    Purpose Statement <span class="text-red-500">*</span>
                  </label>
                  <textarea
                    placeholder="Explain why you need this funding and how it will benefit your business..."
                    [value]="coverInformation().purposeStatement"
                    (input)="onPurposeStatementChange($event)"
                    rows="4"
                    class="block w-full px-3 py-2 border border-neutral-300 rounded-md shadow-sm placeholder-neutral-400 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 sm:text-sm"
                  ></textarea>
                </div>

                <div>
                  <label class="block text-sm font-medium text-neutral-700 mb-2">
                    Use of Funds <span class="text-red-500">*</span>
                  </label>
                  <textarea
                    placeholder="Describe how you will use the funding (e.g., equipment, inventory, marketing, expansion)..."
                    [value]="coverInformation().useOfFunds"
                    (input)="onUseOfFundsChange($event)"
                    rows="4"
                    class="block w-full px-3 py-2 border border-neutral-300 rounded-md shadow-sm placeholder-neutral-400 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 sm:text-sm"
                  ></textarea>
                </div>

                <div>
                  <label class="block text-sm font-medium text-neutral-700 mb-2">
                    Timeline
                  </label>
                  <input
                    type="text"
                    placeholder="When do you need the funding? (e.g., Within 3 months, ASAP)"
                    [value]="coverInformation().timeline"
                    (input)="onTimelineChange($event)"
                    class="block w-full px-3 py-2 border border-neutral-300 rounded-md shadow-sm placeholder-neutral-400 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 sm:text-sm"
                  />
                </div>

                <div>
                  <label class="block text-sm font-medium text-neutral-700 mb-2">
                    Why This Opportunity?
                  </label>
                  <textarea
                    placeholder="Explain why this specific opportunity aligns with your business goals..."
                    [value]="coverInformation().opportunityAlignment"
                    (input)="onOpportunityAlignmentChange($event)"
                    rows="3"
                    class="block w-full px-3 py-2 border border-neutral-300 rounded-md shadow-sm placeholder-neutral-400 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 sm:text-sm"
                  ></textarea>
                </div>
              </div>
            </div>
          }

          @case ('review-submit') {
            <div class="space-y-6">
              <div class="flex items-center space-x-3 mb-6">
                <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                  <lucide-icon [img]="CheckCircleIcon" [size]="20" class="text-green-600" />
                </div>
                <div>
                  <h3 class="text-lg font-semibold text-neutral-900">Review & Submit</h3>
                  <p class="text-sm text-neutral-600">Review your application before submitting</p>
                </div>
              </div>

              <!-- Application Summary -->
              <div class="bg-neutral-50 rounded-lg p-6">
                <h4 class="font-medium text-neutral-900 mb-4">Application Summary</h4>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm mb-6">
                  <div>
                    <span class="text-neutral-500">Opportunity:</span>
                    <div class="font-medium">{{ selectedOpportunity()?.title }}</div>
                  </div>
                  <div>
                    <span class="text-neutral-500">Funder:</span>
                    <div class="font-medium">{{ getOrganizationName(selectedOpportunity()!) }}</div>
                  </div>
                  <div>
                    <span class="text-neutral-500">Requested Amount:</span>
                    <div class="font-medium">{{ formatCurrency(requestedAmountAsNumber()) }}</div>
                  </div>
                  <div>
                    <span class="text-neutral-500">Funding Type:</span>
                    <div class="font-medium capitalize">{{ selectedOpportunity()?.fundingType }}</div>
                  </div>
                </div>

                @if (coverInformation().purposeStatement) {
                  <div class="mb-4">
                    <span class="text-neutral-500 text-sm">Purpose Statement:</span>
                    <div class="mt-1 text-sm">{{ coverInformation().purposeStatement }}</div>
                  </div>
                }

                @if (coverInformation().useOfFunds) {
                  <div class="mb-4">
                    <span class="text-neutral-500 text-sm">Use of Funds:</span>
                    <div class="mt-1 text-sm">{{ coverInformation().useOfFunds }}</div>
                  </div>
                }
              </div>

              <!-- Profile Attachment Confirmation - SIMPLE VERSION -->
              <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                <div class="flex items-start">
                  <lucide-icon [img]="CheckCircleIcon" [size]="20" class="text-green-600 mt-0.5 mr-3" />
                  <div>
                    <p class="text-sm font-medium text-green-800">Business Profile Attached</p>
                    <p class="text-sm text-green-700 mt-1">
                      Your complete business profile ({{ profileCompletion() }}% complete) will be included with this application.
                    </p>
                  </div>
                </div>
              </div>

              <!-- AI Assessment Preview -->
              <div class="border-2 border-dashed border-neutral-300 rounded-lg p-8">
                <div class="text-center">
                  <div class="w-16 h-16 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full mx-auto mb-4 flex items-center justify-center">
                    <lucide-icon [img]="DollarSignIcon" [size]="24" class="text-white" />
                  </div>
                  <h4 class="text-lg font-medium text-neutral-900 mb-2">AI Assessment Ready</h4>
                  <p class="text-neutral-600 mb-4">
                    Our AI will evaluate your application against this opportunity's criteria once submitted.
                  </p>
                  <div class="bg-neutral-100 rounded-lg p-4">
                    <div class="flex items-center justify-between text-sm mb-2">
                      <span class="text-neutral-600">Expected Analysis:</span>
                      <span class="text-neutral-800 font-medium">Available after submission</span>
                    </div>
                    <div class="text-xs text-neutral-500">
                      • Match score against opportunity criteria<br>
                      • Strengths and improvement areas<br>
                      • Success probability estimate<br>
                      • Competitive positioning insights
                    </div>
                  </div>
                </div>
              </div>

              <!-- Terms and Conditions -->
              <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                <div class="flex items-start">
                  <lucide-icon [img]="AlertCircleIcon" [size]="20" class="text-yellow-600 mt-0.5 mr-3" />
                  <div>
                    <h4 class="text-sm font-medium text-yellow-800">Before You Submit</h4>
                    <ul class="mt-1 text-sm text-yellow-700 space-y-1">
                      <li>• This application will be reviewed by the funder</li>
                      <li>• Review typically takes {{ selectedOpportunity()?.decisionTimeframe || 30 }} days</li>
                      <li>• You may be contacted for additional information</li>
                      <li>• All information provided must be accurate and up-to-date</li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>
          }
        }

        <!-- Form Actions -->
        <div class="flex items-center justify-between pt-6 mt-6 border-t border-neutral-200">
          <div class="flex items-center space-x-3">
            @if (currentStep() !== 'select-opportunity') {
              <ui-button variant="outline" (click)="previousStep()">
                Previous
              </ui-button>
            }
            
            <ui-button variant="outline" (click)="goBack()">
              Cancel
            </ui-button>
          </div>

          <div class="flex items-center space-x-3">
            <ui-button variant="outline" (click)="saveDraft()" [disabled]="isSaving()">
              @if (isSaving()) {
                <lucide-icon [img]="ClockIcon" [size]="16" class="mr-2" />
                Saving...
              } @else {
                Save Draft
              }
            </ui-button>

            @if (currentStep() === 'review-submit') {
              <ui-button 
                variant="primary" 
                (click)="submitApplication()" 
                [disabled]="!canContinue() || isSubmitting()"
              >
                @if (isSubmitting()) {
                  <lucide-icon [img]="ClockIcon" [size]="16" class="mr-2" />
                  Submitting...
                } @else {
                  Submit Application
                }
              </ui-button>
            } @else {
              <ui-button variant="primary" (click)="nextStep()" [disabled]="!canContinue()">
                Continue
              </ui-button>
            }
          </div>
        </div>
      </ui-card>
    </div>

    <!-- Sidebar - Opportunity Details -->
    <div class="lg:col-span-1">
      @if (selectedOpportunity(); as opportunity) {
        <ui-card class="sticky top-6">
          <div class="space-y-4">
            <div>
              <h3 class="font-medium text-neutral-900">Selected Opportunity</h3>
              <p class="text-sm text-neutral-600">{{ getOrganizationName(opportunity) }}</p>
            </div>

            <div class="bg-neutral-50 rounded-lg p-4">
              <h4 class="font-medium text-neutral-900 mb-3">{{ opportunity.title }}</h4>
              
              <div class="space-y-3 text-sm">
                <div class="flex justify-between">
                  <span class="text-neutral-600">Type:</span>
                  <span class="font-medium capitalize">{{ opportunity.fundingType }}</span>
                </div>
                
                <div class="flex justify-between">
                  <span class="text-neutral-600">Range:</span>
                  <span class="font-medium">{{ formatCurrency(opportunity.minInvestment) }} - {{ formatCurrency(opportunity.maxInvestment) }}</span>
                </div>
                
                @if (opportunity.interestRate) {
                  <div class="flex justify-between">
                    <span class="text-neutral-600">Interest Rate:</span>
                    <span class="font-medium">{{ opportunity.interestRate }}%</span>
                  </div>
                }
                
                @if (opportunity.equityOffered) {
                  <div class="flex justify-between">
                    <span class="text-neutral-600">Equity:</span>
                    <span class="font-medium">{{ opportunity.equityOffered }}%</span>
                  </div>
                }
                
                <div class="flex justify-between">
                  <span class="text-neutral-600">Decision Time:</span>
                  <span class="font-medium">{{ opportunity.decisionTimeframe }} days</span>
                </div>
              </div>
            </div>

            @if (opportunity.shortDescription) {
              <div>
                <h4 class="font-medium text-neutral-900 mb-2">Description</h4>
                <p class="text-sm text-neutral-600">{{ opportunity.shortDescription }}</p>
              </div>
            }

            @if (opportunity.applicationDeadline) {
              <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                <div class="flex items-center">
                  <lucide-icon [img]="AlertCircleIcon" [size]="16" class="text-yellow-600 mr-2" />
                  <div>
                    <p class="text-sm font-medium text-yellow-800">Application Deadline</p>
                    <p class="text-xs text-yellow-700">{{ opportunity.applicationDeadline | date:'mediumDate' }}</p>
                  </div>
                </div>
              </div>
            }

            <div class="pt-4 border-t border-neutral-200">
              <div class="flex items-center justify-between text-sm text-neutral-600">
                <span>Applications:</span>
                <span>{{ opportunity.currentApplications || 0 }}@if (opportunity.maxApplications) { / {{ opportunity.maxApplications }} }</span>
              </div>
              @if (opportunity.viewCount) {
                <div class="flex items-center justify-between text-sm text-neutral-600 mt-1">
                  <span>Views:</span>
                  <span>{{ opportunity.viewCount }}</span>
                </div>
              }
            </div>
          </div>
        </ui-card>
      } @else {
        <!-- No Opportunity Selected State -->
        <ui-card class="sticky top-6">
          <div class="text-center py-8">
            <div class="w-12 h-12 bg-gray-100 rounded-lg mx-auto mb-3 flex items-center justify-center">
              <lucide-icon [img]="BuildingIcon" [size]="24" class="text-gray-400" />
            </div>
            <p class="text-sm text-gray-500">Select an opportunity to view details</p>
          </div>
        </ui-card>
      }
    </div>
  </div>
</div>