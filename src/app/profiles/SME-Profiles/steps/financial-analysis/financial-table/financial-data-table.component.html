<!-- src/app/SMEs/profile/steps/financial-analysis/financial-table/financial-data-table.component.html -->

<div class="space-y-4">
  <!-- Year Navigation Bar -->
  <div
    class="flex items-center justify-between bg-white rounded-xl border border-slate-200 px-6 py-4"
  >
    <div class="flex items-center gap-4">
      <button
        (click)="goToPreviousYears()"
        [disabled]="!canGoPrevious()"
        class="px-3 py-2 text-sm font-medium text-slate-600 hover:bg-slate-100 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
      >
        ← Previous
      </button>

      <span class="text-sm font-semibold text-slate-900 min-w-32 text-center">
        {{ yearRangeText() }}
      </span>

      <button
        (click)="goToNextYears()"
        [disabled]="!canGoNext()"
        class="px-3 py-2 text-sm font-medium text-slate-600 hover:bg-slate-100 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
      >
        Next →
      </button>
    </div>

    <div class="text-xs text-slate-500">
      Showing {{ visibleYearHeaders().length }} of
      {{ columnHeaders.length }} years
    </div>
  </div>

  <!-- Main Sections -->
  @for (section of sections; track trackBySection($index, section); let
  sectionIndex = $index) {
  <!-- Spacing Before -->
  @if (section.spacingBefore) {
  <div [class]="getSpacingBeforeClasses(section.spacingBefore)"></div>
  }

  <!-- ============================================ -->
  <!-- GROUP CONTAINER (e.g., ASSETS, EQUITIES & LIABILITIES) -->
  <!-- ============================================ -->
  @if (isGroupContainer(section) && section.children && section.children.length
  > 0) {
  <div class="bg-white rounded-2xl border border-slate-200 overflow-hidden">
    <!-- Group Header (collapsible) -->
    <div
      class="px-6 py-4 border-b border-slate-200 bg-slate-50 flex items-center justify-between cursor-pointer hover:bg-slate-100 transition-colors"
      (click)="toggleSection(getSectionKey(section))"
    >
      <div class="flex items-center gap-3">
        <lucide-icon
          [name]="
            isSectionCollapsed(getSectionKey(section))
              ? ChevronRightIcon
              : ChevronDownIcon
          "
          [size]="18"
          class="text-slate-600"
        />
        <h3
          class="text-base font-semibold text-slate-900 uppercase tracking-wide"
        >
          {{ section.title }}
        </h3>
      </div>
    </div>

    <!-- SHARED TABLE FOR ALL CHILD SECTIONS (only render if not collapsed) -->
    @if (!isSectionCollapsed(getSectionKey(section))) {
    <table class="w-full">
      <!-- COLUMN HEADERS (render once at the top) -->
      <thead class="bg-white">
        <tr class="border-b border-slate-200">
          <th class="text-left px-6 py-3 font-semibold text-slate-900 text-sm">
            {{ itemLabel }}
          </th>

          @for (header of visibleYearHeaders(); track trackByHeader($index,
          header)) {
          <th
            class="text-right px-4 py-3 font-semibold text-slate-900 text-sm min-w-24"
          >
            {{ header }}
          </th>
          }
        </tr>
      </thead>

      <!-- CHILD SECTIONS AS TABLE ROWS -->
      <tbody>
        @for ( childSection of section.children; track trackBySection($index,
        childSection); let childIndex = $index ) {
        <!-- CHILD SECTION HEADER ROW (only if not headerless) -->
        @if (!childSection.isHeaderless && childSection.title) {
        <tr
          class="border-b border-slate-200 bg-slate-50/50 hover:bg-slate-100 transition-colors"
        >
          <td colspan="999" class="px-6 py-3">
            <h4 class="text-sm font-semibold text-slate-900">
              {{ childSection.title }}
            </h4>
          </td>
        </tr>
        }

        <!-- DATA ROWS FOR THIS CHILD SECTION -->
        @for (row of childSection.rows; track trackByRow($index, row)) {
        <tr [class]="getRowClasses(row, true)">
          <!-- Label Cell -->
          <td [class]="'px-6 py-3 text-left ' + getLabelClasses(row)">
            <div class="flex items-center gap-2">
              <span class="flex-1">{{ row.label }}</span>

              @if (!row.editable || row.isCalculated) {
              <lucide-icon
                [name]="LockIcon"
                [size]="16"
                class="text-slate-400 flex-shrink-0"
              />
              }
            </div>
          </td>

          <!-- Data Cells -->
          @for ( value of getVisibleRowValues(row.values); track
          trackByHeader($index, $index.toString()) ) {
          <td [class]="getCellClasses(row, value)">
            @if (isRowEditable(row)) {
            <!-- Editable Input -->
            <input
              type="text"
              [value]="formatNumber(value, row)"
              (change)="onCellChange(sectionIndex, $index, $index, $event)"
              (focus)="onInputFocus($event)"
              (keydown.enter)="onEnterKey($event)"
              class="w-full text-right px-2 py-1 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 bg-white hover:border-slate-300 transition-colors"
            />
            } @else {
            <!-- Read-Only Display -->
            <span>{{ formatNumber(value, row) }}</span>
            }
          </td>
          }
        </tr>
        } }
      </tbody>
    </table>
    }
  </div>
  }

  <!-- ============================================ -->
  <!-- REGULAR SECTION (not a group container) -->
  <!-- ============================================ -->
  @else if (section.rows && section.rows.length > 0) {
  <div class="bg-white rounded-2xl border border-slate-200 overflow-hidden">
    <!-- Section Header (collapsible if needed) -->
    <div
      [class]="
        'px-6 py-4 border-b border-slate-200 bg-slate-50 flex items-center justify-between ' +
        (section.isCollapsible ? 'cursor-pointer hover:bg-slate-100' : '')
      "
      [class.transition-colors]="section.isCollapsible"
      (click)="section.isCollapsible && toggleSection(getSectionKey(section))"
    >
      <div class="flex items-center gap-3">
        @if (section.isCollapsible) {
        <lucide-icon
          [name]="
            isSectionCollapsed(getSectionKey(section))
              ? ChevronRightIcon
              : ChevronDownIcon
          "
          [size]="18"
          class="text-slate-600"
        />
        }

        <h3 class="text-base font-semibold text-slate-900">
          {{ section.title }}
        </h3>

        @if (section.accentColor === 'orange') {
        <div class="ml-2 w-2 h-2 rounded-full bg-amber-500"></div>
        }
      </div>
    </div>

    <!-- Section Rows (if not collapsed) -->
    @if (!section.isCollapsible || !isSectionCollapsed(getSectionKey(section)))
    {
    <table class="w-full">
      <!-- Column Headers -->
      <thead class="bg-white">
        <tr class="border-b border-slate-200">
          <th class="text-left px-6 py-3 font-semibold text-slate-900 text-sm">
            <!-- {{ itemLabel }} -->
          </th>

          @for (header of visibleYearHeaders(); track trackByHeader($index,
          header)) {
          <th
            class="text-right px-4 py-3 font-semibold text-slate-900 text-sm min-w-24"
          >
            {{ header }}
          </th>
          }
        </tr>
      </thead>

      <!-- Data Rows -->
      <tbody>
        @for (row of section.rows; track trackByRow($index, row)) {
        <tr [class]="getRowClasses(row, true)">
          <!-- Label Cell -->
          <td [class]="'px-6 py-3 text-left ' + getLabelClasses(row)">
            <div class="flex items-center gap-2">
              <span class="flex-1">{{ row.label }}</span>

              @if (!row.editable || row.isCalculated) {
              <lucide-icon
                [name]="LockIcon"
                [size]="16"
                class="text-slate-400 flex-shrink-0"
              />
              }
            </div>
          </td>

          <!-- Data Cells -->
          @for ( value of getVisibleRowValues(row.values); track
          trackByHeader($index, $index.toString()) ) {
          <td [class]="getCellClasses(row, value)">
            @if (isRowEditable(row)) {
            <!-- Editable Input -->
            <input
              type="text"
              [value]="formatNumber(value, row)"
              (change)="onCellChange(sectionIndex, $index, $index, $event)"
              (focus)="onInputFocus($event)"
              (keydown.enter)="onEnterKey($event)"
              class="w-full text-right px-2 py-1 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 bg-white hover:border-slate-300 transition-colors"
            />
            } @else {
            <!-- Read-Only Display -->
            <span>{{ formatNumber(value, row) }}</span>
            }
          </td>
          }
        </tr>
        }
      </tbody>
    </table>
    }
  </div>
  }

  <!-- Spacing After -->
  @if (section.spacingAfter) {
  <div [class]="getSpacingAfterClasses(section.spacingAfter)"></div>
  } }
</div>
