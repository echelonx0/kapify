<div class="min-h-screen bg-slate-50">
  <!-- Cost Confirmation Modal -->
  @if (costConfirmation().isOpen) {
    <app-cost-confirmation-modal
      [wallet]="wallet()!"
      [costInCents]="5000"
      [costFormatted]="'R50.00'"
      (onConfirm)="confirmAnalysis($event)"
      (onCancel)="closeCostModal()"
    ></app-cost-confirmation-modal>
  }

  <!-- Main Container -->
  <div class="max-w-7xl mx-auto px-4 lg:px-8 py-8">
    <!-- Two-Column Grid Layout -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- LEFT COLUMN: Upload Section (2/3 width on desktop) -->
      <div class="lg:col-span-2">
        <!-- Error State -->
        @if (hasError()) {
          <div
            class="mb-6 p-6 bg-red-50 border-2 border-red-300 rounded-2xl flex items-start gap-4"
          >
            <div class="flex-shrink-0">
              <lucide-icon
                [img]="XCircleIcon"
                [size]="24"
                class="text-red-600"
              />
            </div>
            <div class="flex-1">
              <h4 class="text-base font-bold text-red-900 mb-1">
                Analysis Failed
              </h4>
              <p class="text-sm text-red-800">{{ errorMessage() }}</p>
            </div>
          </div>
        }
        <!-- Header -->
        <app-document-analysis-header></app-document-analysis-header>
        <!-- Upload Card -->
        <div
          class="bg-white rounded-lg border mt-2 border-slate-200 overflow-hidden"
        >
          <div
            class="px-6 lg:px-8 py-6 bg-orange-800 text-white border-b border-teal-300"
          >
            <p class="text-sm text-white-300">
              This is a pay-as-you-go service.
              <span class="text-white font-bold">
                {{ creditsFormatted() }}
              </span>
              available.
              <span class="text-teal-400">
                {{ formatCurrency(ANALYSIS_COST_ZAR) }} per analysis.
              </span>
            </p>
            <p class="mt-2 text-xs text-white-400">
              Additional credits can be purchased at any time.
            </p>
          </div>

          <!-- Upload Section -->
          @if (!analysisResult() && !isProcessing()) {
            <div class="p-6 lg:p-8">
              <!-- Drag & Drop Area -->
              <div
                class="relative border-3 border-dashed rounded-2xl p-8 text-center transition-all duration-200 cursor-pointer"
                [class.border-teal-400]="isDragOver()"
                [class.bg-teal-50]="isDragOver()"
                [class.border-slate-300]="!isDragOver()"
                [class.bg-slate-50]="!isDragOver()"
                (dragover)="onDragOver($event)"
                (dragleave)="onDragLeave($event)"
                (drop)="onDrop($event)"
                (click)="fileInput.click()"
              >
                <input
                  #fileInput
                  type="file"
                  accept=".pdf"
                  class="hidden"
                  (change)="onFileSelected($event)"
                />

                <div class="space-y-4">
                  <div>
                    <h4 class="text-lg font-bold text-slate-900 mb-2">
                      Analyze Investment Proposals
                    </h4>
                    <p class="text-slate-600 text-sm leading-relaxed">
                      Drop a PDF here or click to browse. Kapify's proprietary
                      business intelligence engine will assess the proposal
                      against real-time market benchmarks and provide detailed
                      investment insights.
                    </p>
                    <div class="text-xs text-slate-500 mt-3">
                      Supported format: PDF (max 15MB)
                    </div>
                  </div>
                </div>
              </div>
            </div>
          }

          <!-- Processing Status -->
          @if (isProcessing()) {
            <div class="p-6 lg:p-8">
              <div class="text-center mb-8">
                <div
                  class="w-16 h-16 bg-teal-100 rounded-2xl mx-auto mb-4 flex items-center justify-center"
                >
                  <lucide-icon
                    [img]="Loader2Icon"
                    [size]="32"
                    class="text-teal-600 animate-spin"
                  />
                </div>
                <h4 class="text-lg font-bold text-slate-900 mb-2">
                  Running Intelligence Analysis
                </h4>
                <p class="text-slate-600 text-sm">
                  Kapify is evaluating this proposal against market benchmarks
                  and generating strategic insights...
                </p>
              </div>
            </div>
          }

          <!-- Analysis Complete - CTAs -->
          @if (analysisResult() && !isProcessing()) {
            <div class="border-t-4 border-teal-600 bg-white px-6 lg:px-8 py-6">
              <div
                class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4"
              >
                <div class="flex items-start gap-4 flex-1">
                  <div
                    class="w-12 h-12 rounded-lg bg-teal-100 border-2 border-teal-600 flex items-center justify-center flex-shrink-0"
                  >
                    <lucide-icon
                      [img]="CheckCircleIcon"
                      [size]="24"
                      class="text-teal-700"
                    ></lucide-icon>
                  </div>
                  <div>
                    <h3 class="text-base font-bold text-slate-900 mb-1">
                      Analysis Complete
                    </h3>
                    <p class="text-sm text-slate-600">
                      @if (redirectCountdown() > 0) {
                        Redirecting in
                        <span class="font-bold text-teal-600">{{
                          redirectCountdown()
                        }}</span>
                        second{{ redirectCountdown() !== 1 ? "s" : "" }}...
                      } @else {
                        Your analysis is ready. Review the intelligence insights
                        and strategic recommendations.
                      }
                    </p>
                  </div>
                </div>
                @if (redirectCountdown() <= 0) {
                  <div class="flex flex-col sm:flex-row gap-3 w-full sm:w-auto">
                    <button
                      (click)="resetAnalysis()"
                      class="px-6 py-3 bg-slate-100 text-slate-900 font-bold rounded-lg border-2 border-slate-300 hover:bg-slate-200 active:bg-slate-300 transition-all duration-200 text-sm whitespace-nowrap"
                    >
                      Analyze Another
                    </button>
                    <button
                      (click)="viewAnalysisDetail()"
                      class="px-6 py-3 bg-teal-600 text-white font-bold rounded-lg border-2 border-teal-700 hover:bg-teal-700 active:bg-teal-800 transition-all duration-200 text-sm whitespace-nowrap"
                    >
                      View Full Analysis
                    </button>
                  </div>
                }
              </div>
            </div>
          }
        </div>
      </div>

      <!-- RIGHT COLUMN: How It Works / Timeline (1/3 width on desktop) -->
      <div class="lg:col-span-1">
        <!-- Processing Timeline (replaces how-it-works during processing) -->
        @if (isProcessing()) {
          <div class="sticky top-8">
            <app-processing-timeline
              [stages]="processingStatuses()"
            ></app-processing-timeline>
          </div>
        }

        <!-- How It Works (shown when not processing) -->
        @if (!isProcessing()) {
          <div class="sticky top-8">
            <app-condensed-how-it-works></app-condensed-how-it-works>
          </div>
        }
      </div>
    </div>
  </div>
</div>
