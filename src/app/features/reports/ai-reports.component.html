<!-- Updated ai-reports.component.html - Integrated with Report Builder -->

<div class="min-h-screen bg-gradient-to-b from-slate-50 to-white">
  <!-- Hero Section -->
  <div
    class="bg-gradient-to-r from-teal-50 via-white to-slate-50 border-b border-slate-200"
  >
    <div class="max-w-7xl mx-auto px-4 lg:px-8 py-8 lg:py-12">
      <div
        class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-6"
      >
        <div>
          <div class="flex items-center gap-3 mb-4">
            <div
              class="w-12 h-12 rounded-xl bg-gradient-to-br from-teal-100 to-teal-50 flex items-center justify-center"
            >
              <lucide-angular
                [img]="FileIcon"
                size="24"
                class="text-teal-600"
              ></lucide-angular>
            </div>
            <h1 class="text-3xl lg:text-4xl font-bold text-slate-900">
              Activity Reports
            </h1>
          </div>
          <p class="text-slate-600">
            @if (isFunder()) { Overview of your funding applications and
            activities } @else if (isSME()) { Track your application submissions
            and funding progress }
          </p>
        </div>

        <!-- Refresh Button (Only for Funders) -->
        @if (isFunder()) {
        <button
          (click)="refreshReports()"
          [disabled]="loading()"
          class="flex items-center gap-2 bg-teal-500 text-white px-6 py-3 rounded-xl hover:bg-teal-600 active:bg-teal-700 transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed font-medium"
        >
          <lucide-angular
            *ngIf="!loading()"
            [img]="RefreshIcon"
            size="18"
          ></lucide-angular>
          <lucide-angular
            *ngIf="loading()"
            [img]="LoaderIcon"
            size="18"
            class="animate-spin"
          ></lucide-angular>
          {{ loading() ? "Refreshing..." : "Refresh" }}
        </button>
        }
      </div>
    </div>
  </div>

  <!-- Tab Navigation -->
  @if (isFunder()) {
  <div class="max-w-7xl mx-auto px-4 lg:px-8 py-4 border-b border-slate-200">
    <div class="flex items-center gap-4">
      <!-- Generate Reports Button - Opens Report Builder -->
      <button
        (click)="generateReports()"
        class="px-6 py-3 rounded-xl border-2 border-teal-600 bg-teal-50 text-teal-700 font-bold hover:bg-teal-100 active:bg-teal-200 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-offset-2"
      >
        Generate Reports
      </button>
    </div>
  </div>
  } @else if (isSME()) {
  <div class="max-w-7xl mx-auto px-4 lg:px-8 py-4 border-b border-slate-200">
    <div class="flex items-center gap-4">
      <!-- SME sees: Analysis History only -->
      <button
        (click)="switchTab('analysis')"
        class="px-6 py-3 rounded-xl border bg-teal-50 text-teal-700 border-teal-300 font-medium"
      >
        Analysis History
      </button>
    </div>
  </div>
  }

  <div class="max-w-7xl mx-auto px-4 lg:px-8 py-8">
    <!-- ============================================ -->
    <!-- TAB: APPLICATIONS (FUNDERS ONLY) -->
    <!-- ============================================ -->
    @if (activeTab() === 'applications' && isFunder()) {
    <div class="space-y-8">
      <!-- Activity Summary Cards -->
      <app-applications-stats
        [summary]="activitySummary()"
      ></app-applications-stats>

      <!-- Error Alert -->
      @if (error()) {
      <div
        class="bg-red-50 border border-red-200/50 rounded-2xl p-4 flex items-start gap-3"
      >
        <lucide-angular
          [img]="AlertIcon"
          size="20"
          class="text-red-600 flex-shrink-0 mt-0.5"
        ></lucide-angular>
        <div class="flex-1">
          <p class="text-sm font-medium text-red-700">{{ error() }}</p>
        </div>
        <button
          (click)="error.set(null)"
          class="text-red-600 hover:text-red-700 flex-shrink-0"
        >
          <lucide-angular [img]="CloseIcon" size="18"></lucide-angular>
        </button>
      </div>
      }

      <!-- Loading State -->
      @if (loading()) {
      <div class="text-center py-16">
        <div
          class="inline-flex items-center justify-center w-12 h-12 rounded-full bg-slate-100 mb-4"
        >
          <lucide-angular
            [img]="LoaderIcon"
            size="24"
            class="text-teal-600 animate-spin"
          ></lucide-angular>
        </div>
        <p class="text-slate-600 font-medium">
          Loading your activity reports...
        </p>
      </div>
      }

      <!-- No Results -->
      @if (!loading() && filteredCount() === 0 && hasReports()) {
      <div
        class="text-center py-16 bg-white rounded-2xl border border-slate-200"
      >
        <lucide-angular
          [img]="SearchIcon"
          size="32"
          class="text-slate-400 mx-auto mb-4"
        ></lucide-angular>
        <h3 class="text-lg font-bold text-slate-900 mb-2">
          No activities found
        </h3>
        <p class="text-slate-600">Try adjusting your filters or search terms</p>
      </div>
      }

      <!-- No Reports -->
      @if (!loading() && !hasReports()) {
      <div
        class="text-center py-16 bg-white rounded-2xl border border-slate-200"
      >
        <lucide-angular
          [img]="InboxIcon"
          size="32"
          class="text-slate-400 mx-auto mb-4"
        ></lucide-angular>
        <h3 class="text-lg font-bold text-slate-900 mb-2">No activities yet</h3>
        <p class="text-slate-600">
          Activities will appear here as you receive applications
        </p>
      </div>
      }
    </div>
    }

    <!-- ============================================ -->
    <!-- TAB: ANALYSIS HISTORY (SMEs ONLY) -->
    <!-- ============================================ -->
    @if (activeTab() === 'analysis' && isSME()) {
    <app-analysis-history></app-analysis-history>
    }
  </div>

  <!-- ============================================ -->
  <!-- REPORT BUILDER MODAL -->
  <!-- ============================================ -->
  @if (reportBuilderOpen()) {
  <app-report-builder
    #reportBuilder
    [data]="reportBuilderData()"
    (onClose)="closeReportBuilder()"
  ></app-report-builder>
  }

  <!-- ============================================ -->
  <!-- APPLICATION DETAIL SHEET (FUNDERS ONLY) -->
  <!-- ============================================ -->
  @if (sheetOpen() && selectedReport() && isFunder()) {
  <div
    (click)="closeSheet()"
    class="fixed inset-0 bg-black/25 backdrop-blur-sm z-40 transition-opacity duration-300"
  ></div>

  <div
    class="fixed right-0 top-0 h-screen w-full md:w-96 bg-white shadow-xl z-50 overflow-y-auto transition-transform duration-300"
  >
    <!-- Sheet Header -->
    <div
      class="sticky top-0 z-10 bg-white border-b border-slate-200 px-6 py-4 flex items-center justify-between"
    >
      <div class="flex items-center gap-3">
        <div
          class="w-10 h-10 rounded-lg bg-teal-100 flex items-center justify-center"
        >
          <lucide-angular
            [img]="FileIcon"
            size="20"
            class="text-teal-600"
          ></lucide-angular>
        </div>
        <h3 class="text-lg font-bold text-slate-900">Application Details</h3>
      </div>
      <button
        (click)="closeSheet()"
        class="text-slate-600 hover:text-slate-900 transition-colors"
      >
        <lucide-angular [img]="CloseIcon" size="20"></lucide-angular>
      </button>
    </div>

    <!-- Sheet Content -->
    <div class="p-6 space-y-6">
      <!-- Header -->
      <div>
        <h4 class="text-2xl font-bold text-slate-900 mb-2">
          {{ selectedReport()!.nameOfBusiness }}
        </h4>
        <p class="text-slate-600">
          {{ selectedReport()!.industry }} â€¢ {{ selectedReport()!.province }}
        </p>
      </div>

      <!-- Quick Stats -->
      <div class="grid grid-cols-2 gap-4">
        <div class="bg-teal-50 rounded-xl border border-teal-200/50 p-4">
          <p
            class="text-xs font-semibold text-teal-600 uppercase tracking-wide"
          >
            Match Score
          </p>
          <p class="text-2xl font-bold text-teal-700 mt-2">
            {{ selectedReport()!.matchScore || 0 }}%
          </p>
        </div>
        <div class="bg-slate-100 rounded-xl border border-slate-200 p-4">
          <p
            class="text-xs font-semibold text-slate-600 uppercase tracking-wide"
          >
            Completion
          </p>
          <p class="text-2xl font-bold text-slate-700 mt-2">
            {{ selectedReport()!.completionScore || 0 }}%
          </p>
        </div>
      </div>

      <!-- Business Info -->
      <div class="space-y-3">
        <p class="text-sm font-semibold text-slate-900">Business Information</p>
        <div class="space-y-2 text-sm">
          <div
            class="flex justify-between items-center py-2 border-b border-slate-100"
          >
            <span class="text-slate-600">Stage</span>
            <span class="font-medium text-slate-900">{{
              selectedReport()!.businessStage
            }}</span>
          </div>
          <div
            class="flex justify-between items-center py-2 border-b border-slate-100"
          >
            <span class="text-slate-600">Years Operating</span>
            <span class="font-medium text-slate-900">{{
              selectedReport()!.yearsInOperation
            }}</span>
          </div>
          <div
            class="flex justify-between items-center py-2 border-b border-slate-100"
          >
            <span class="text-slate-600">Employees</span>
            <span class="font-medium text-slate-900">{{
              selectedReport()!.numberOfEmployees
            }}</span>
          </div>
          <div class="flex justify-between items-center py-2">
            <span class="text-slate-600">Annual Revenue</span>
            <span class="font-medium text-slate-900">{{
              formatCurrency(selectedReport()!.priorYearAnnualRevenue)
            }}</span>
          </div>
        </div>
      </div>

      <!-- Contact Info -->
      <div class="space-y-3">
        <p class="text-sm font-semibold text-slate-900">Contact Details</p>
        <div class="space-y-2 text-sm">
          <div
            class="flex justify-between items-center py-2 border-b border-slate-100"
          >
            <span class="text-slate-600">Name</span>
            <span class="font-medium text-slate-900"
              >{{ selectedReport()!.firstName }}
              {{ selectedReport()!.surname }}</span
            >
          </div>
          <div
            class="flex justify-between items-center py-2 border-b border-slate-100"
          >
            <span class="text-slate-600">Email</span>
            <span class="font-medium text-slate-900 truncate">{{
              selectedReport()!.email
            }}</span>
          </div>
          <div class="flex justify-between items-center py-2">
            <span class="text-slate-600">Phone</span>
            <span class="font-medium text-slate-900">{{
              selectedReport()!.phoneNumber
            }}</span>
          </div>
        </div>
      </div>

      <!-- Funding Details -->
      <div class="space-y-3">
        <p class="text-sm font-semibold text-slate-900">Funding Request</p>
        <div
          class="bg-gradient-to-br from-teal-50 to-slate-50 rounded-xl border border-teal-200/50 p-4 space-y-3"
        >
          <div>
            <p
              class="text-xs font-semibold text-teal-600 uppercase tracking-wide"
            >
              Amount
            </p>
            <p class="text-2xl font-bold text-teal-700 mt-1">
              {{ formatCurrency(selectedReport()!.amountRequested) }}
            </p>
          </div>
          <div class="flex gap-4 text-sm">
            <div>
              <p class="text-slate-600">Type</p>
              <p class="font-semibold text-slate-900">
                {{ selectedReport()!.fundingType }}
              </p>
            </div>
            <div>
              <p class="text-slate-600">Opportunity</p>
              <p class="font-semibold text-slate-900">
                {{ selectedReport()!.fundingOpportunity }}
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Close Button -->
      <button
        (click)="closeSheet()"
        class="w-full bg-slate-100 text-slate-700 font-medium py-2.5 rounded-xl hover:bg-slate-200 transition-colors duration-200 flex items-center justify-center gap-2"
      >
        Back to List
      </button>
    </div>
  </div>
  }
</div>
