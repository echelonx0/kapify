<div class="flex flex-col h-full bg-white">
  <!-- Header -->
  <div
    class="flex-shrink-0 px-6 py-4 border-b border-slate-200 flex items-center justify-between sticky top-0 bg-white/95 backdrop-blur-sm z-10"
  >
    <div class="flex-1">
      <h2 class="text-lg font-semibold text-slate-900">{{ thread.subject }}</h2>
      <p class="text-xs text-slate-500 mt-1">
        {{ thread.participants.length }} participant<span
          *ngIf="thread.participants.length !== 1"
          >s</span
        >
      </p>
    </div>

    <!-- Close button (mobile only) -->
    <button
      (click)="closeDetail()"
      class="lg:hidden flex-shrink-0 p-2 text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded-lg transition-all duration-200"
      aria-label="Close conversation"
    >
      <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
        <path
          fill-rule="evenodd"
          d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
          clip-rule="evenodd"
        />
      </svg>
    </button>
  </div>

  <!-- Messages Container -->
  <div #messagesContainer class="flex-1 overflow-y-auto px-6 py-4 space-y-4">
    <!-- Empty state -->
    @if (thread.messages.length === 0) {
    <div class="flex items-center justify-center h-full">
      <div class="text-center">
        <svg
          class="w-12 h-12 text-slate-300 mx-auto mb-3"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="1.5"
            d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"
          />
        </svg>
        <p class="text-sm font-medium text-slate-900">No messages yet</p>
        <p class="text-xs text-slate-500 mt-1">Start the conversation</p>
      </div>
    </div>
    } @else {
    <!-- Messages -->
    @for (message of thread.messages; let last = $last; track
    trackByMessageId($index, message)) {
    <!-- Date separator -->
    @if (shouldShowDateSeparator(message, thread.messages[$index - 1])) {
    <div class="flex items-center gap-3 py-2">
      <div class="flex-1 h-px bg-slate-200"></div>
      <span class="text-xs font-medium text-slate-500">
        {{ formatMessageDate(message.created_at) }}
      </span>
      <div class="flex-1 h-px bg-slate-200"></div>
    </div>
    }

    <!-- Message -->
    <div
      [@messageAppear]
      [class.justify-end]="isOwnMessage(message)"
      class="flex gap-3"
      [ngClass]="{
        'mb-1':
          !last && isConsecutiveMessage(message, thread.messages[$index + 1])
      }"
    >
      <!-- Avatar (other users only) -->
      @if (!isOwnMessage(message)) {
      <div
        [class.opacity-0]="
          thread.messages[$index + 1] &&
          isConsecutiveMessage(message, thread.messages[$index + 1])
        "
        class="flex-shrink-0 w-8 h-8 rounded-full bg-gradient-to-br {{
          getAvatarColor(message.user?.user_type)
        }} flex items-center justify-center text-white text-xs font-semibold transition-opacity duration-200"
      >
        {{ message.user?.initials || "M" }}
      </div>
      }

      <div [class.max-w-xs]="true" [class.lg:max-w-md]="true">
        <!-- Sender name (for other users, first message in sequence) -->
        @if (!isOwnMessage(message) && (!thread.messages[$index - 1] ||
        !isConsecutiveMessage(thread.messages[$index - 1], message))) {
        <p class="text-xs font-semibold text-slate-600 mb-1">
          {{ message.user?.name }}
        </p>
        }

        <!-- Message bubble -->
        <div
          [class.bg-teal-500]="isOwnMessage(message)"
          [class.text-white]="isOwnMessage(message)"
          [class.bg-slate-100]="!isOwnMessage(message)"
          [class.text-slate-900]="!isOwnMessage(message)"
          [class.rounded-2xl]="
            !thread.messages[$index + 1] ||
            !isConsecutiveMessage(message, thread.messages[$index + 1]) ||
            isOwnMessage(message) !== isOwnMessage(thread.messages[$index + 1])
          "
          [class.rounded-bl-none]="
            !isOwnMessage(message) &&
            thread.messages[$index + 1] &&
            isConsecutiveMessage(message, thread.messages[$index + 1])
          "
          [class.rounded-br-none]="
            isOwnMessage(message) &&
            thread.messages[$index + 1] &&
            isConsecutiveMessage(message, thread.messages[$index + 1])
          "
          class="px-4 py-3 break-words transition-colors duration-200"
        >
          <p class="text-sm leading-relaxed whitespace-pre-wrap">
            {{ message.content }}
          </p>
        </div>

        <!-- Timestamp (only for last message in sequence) -->
        @if (!thread.messages[$index + 1] || !isConsecutiveMessage(message,
        thread.messages[$index + 1]) || isOwnMessage(message) !==
        isOwnMessage(thread.messages[$index + 1])) {
        <p
          [class.text-right]="isOwnMessage(message)"
          class="text-xs text-slate-500 mt-1"
        >
          {{ formatTime(message.created_at) }}
        </p>
        }
      </div>

      <!-- Avatar spacer (own messages) -->
      @if (isOwnMessage(message)) {
      <div class="flex-shrink-0 w-8"></div>
      }
    </div>
    } }

    <!-- Scroll to bottom anchor -->
    <div class="h-1"></div>
  </div>

  <!-- Input area -->
  <div class="flex-shrink-0 border-t border-slate-200 bg-white">
    @if (thread.is_broadcast) {
    <div
      class="px-6 py-4 bg-amber-50 border-b border-amber-200/50 text-xs text-amber-700"
    >
      This is a broadcast message. Replies are not available.
    </div>
    } @else {
    <app-notifications-input
      [threadId]="thread.id"
      [isSending]="isSending()"
      (onSend)="onMessageSend($event)"
    />
    }
  </div>
</div>
