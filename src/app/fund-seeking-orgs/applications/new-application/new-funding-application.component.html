<!-- opportunity-application.component.html -->
<div class="max-w-6xl mx-auto px-4 lg:px-8">
  <!-- Header -->
  <div class="mb-10 mt-10 border-b border-slate-200 pb-6">
    <div class="flex items-center justify-between">
      <div class="flex items-center space-x-4">
        <button
          (click)="goBack()"
          class="flex items-center px-4 py-2.5 text-sm font-medium text-slate-700 hover:bg-slate-100 rounded-xl transition-colors duration-200"
        >
          <lucide-icon [img]="ArrowLeftIcon" [size]="16" class="mr-2" />
          Back
        </button>
      </div>

      <button
        (click)="saveDraft()"
        [disabled]="isSaving()"
        class="px-6 py-2.5 bg-slate-100 text-slate-700 font-medium rounded-xl hover:bg-slate-200 disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-200"
      >
        @if (isSaving()) {
        <lucide-icon
          [img]="ClockIcon"
          [size]="16"
          class="mr-2 inline animate-spin"
        />
        Saving... } @else { Save Draft }
      </button>
    </div>
  </div>

  <!-- Progress Steps -->
  <div class="mb-8">
    <div class="flex items-center justify-between w-full">
      @for (step of steps(); track step.id) {
      <!-- Hide selector step from progress if opportunity ID in route -->
      @if (!(step.id === 'select-opportunity' && shouldSkipSelector())) {
      <div class="flex items-center flex-1 group">
        <div [class]="getStepClasses(step.id)" class="group-hover:scale-110">
          {{ step.number }}
        </div>
        <div class="ml-3">
          <p
            [class]="getStepTextClasses(step.id)"
            class="font-medium transition-colors"
          >
            {{ step.title }}
          </p>
          <p class="text-xs text-slate-500">{{ step.description }}</p>
        </div>

        @if (step.id !== 'review-submit') {
        <div class="flex-1 h-0.5 bg-slate-200 mx-8 relative overflow-hidden">
          <div
            class="absolute inset-0 h-full bg-gradient-to-r from-teal-400 to-teal-500 transition-all duration-700"
          ></div>
        </div>
        }
      </div>
      } }
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <!-- Main Content -->
    <div class="lg:col-span-2">
      <div
        class="bg-white rounded-2xl border border-slate-200 p-6 shadow-sm hover:shadow-md transition-all duration-200"
      >
        @if (error()) {
        <div class="mb-6 bg-red-50 border border-red-200/50 rounded-xl p-4">
          <span class="text-red-700 text-sm">{{ error() }}</span>
        </div>
        } @switch (currentStep()) {
        <!-- STEP 1: Select Opportunity (Only show if NO opportunityId in route) -->
        @case ('select-opportunity') { @if (!shouldSkipSelector()) {
        <app-opportunity-selector
          [opportunities]="availableOpportunities()"
          [selectedOpportunityId]="selectedOpportunity()?.id"
          [isLoading]="isLoading()"
          (opportunitySelected)="onOpportunitySelected($event)"
          (backClicked)="goBack()"
        >
        </app-opportunity-selector>
        } }

        <!-- STEP 2: Application Details -->
        @case ('application-details') {
        <app-application-form
          [opportunity]="selectedOpportunity()!"
          (formChanged)="onFormChanged()"
        >
        </app-application-form>
        }

        <!-- STEP 3: AI Analysis -->
        @case ('ai-analysis') {
        <div class="space-y-6">
          <app-enhanced-ai-analysis
            [opportunity]="selectedOpportunity()"
            [applicationData]="formData()"
            [applicationId]="applicationId()"
            [businessProfile]="businessProfile()"
            [coverData]="defaultCover()"
            [isSubmitted]="false"
            [analysisMode]="'opportunity'"
            [analysisPerspective]="'sme'"
            (analysisCompleted)="onAnalysisCompleted($event)"
            (improvementRequested)="onImprovementRequested()"
            (proceedRequested)="onProceedRequested()"
          >
          </app-enhanced-ai-analysis>
        </div>
        }

        <!-- STEP 4: Review & Submit -->
        @case ('review-submit') {
        <app-review-summary
          [opportunity]="selectedOpportunity()!"
          [formData]="formData()"
          [coverData]="defaultCover()"
          [aiAnalysisResult]="aiAnalysisResult()"
          [profileCompletion]="profileCompletion()"
        >
        </app-review-summary>
        } }

        <!-- Form Actions -->
        <div
          class="flex items-center justify-between pt-6 mt-8 border-t border-slate-200"
        >
          <div class="flex items-center space-x-3">
            @if (currentStep() !== 'select-opportunity' && currentStep() !==
            'application-details') {
            <button
              (click)="previousStep()"
              class="px-6 py-2.5 bg-slate-100 text-slate-700 font-medium rounded-xl hover:bg-slate-200 active:bg-slate-300 transition-colors duration-200"
            >
              <lucide-icon
                [img]="ArrowLeftIcon"
                [size]="16"
                class="mr-2 inline"
              />
              Previous
            </button>
            }

            <button
              (click)="goBack()"
              class="px-6 py-2.5 bg-slate-100 text-slate-700 font-medium rounded-xl hover:bg-slate-200 active:bg-slate-300 transition-colors duration-200"
            >
              Cancel
            </button>
          </div>

          <div class="flex items-center space-x-3">
            <button
              (click)="saveDraft()"
              [disabled]="isSaving()"
              class="px-6 py-2.5 bg-slate-100 text-slate-700 font-medium rounded-xl hover:bg-slate-200 active:bg-slate-300 disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-200"
            >
              @if (isSaving()) {
              <lucide-icon
                [img]="ClockIcon"
                [size]="16"
                class="mr-2 inline animate-spin"
              />
              Saving... } @else { Save Draft }
            </button>

            @if (currentStep() === 'review-submit') {
            <button
              (click)="submitApplication()"
              [disabled]="!canContinue() || isSubmitting()"
              class="px-6 py-2.5 bg-teal-500 text-white font-medium rounded-xl hover:bg-teal-600 active:bg-teal-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-200"
            >
              @if (isSubmitting()) {
              <lucide-icon
                [img]="ClockIcon"
                [size]="16"
                class="mr-2 inline animate-spin"
              />
              Submitting... } @else { Submit Application }
            </button>
            } @else {
            <button
              (click)="nextStep()"
              [disabled]="!canContinue()"
              class="px-6 py-2.5 bg-teal-500 text-white font-medium rounded-xl hover:bg-teal-600 active:bg-teal-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-200"
            >
              @if (currentStep() === 'application-details') { Continue to
              Screening } @else if (currentStep() === 'ai-analysis') { Continue
              to Review } @else { Continue }
            </button>
            }
          </div>
        </div>
      </div>
    </div>

    <!-- Sidebar -->
    <div class="lg:col-span-1">
      <app-opportunity-sidebar
        [opportunity]="selectedOpportunity()"
        [currentStep]="currentStep()"
        [aiAnalysisResult]="aiAnalysisResult()"
      >
      </app-opportunity-sidebar>
    </div>
  </div>
</div>
