<div class="min-h-screen flex flex-col lg:flex-row relative bg-slate-50">
  <!-- Top Header (Mobile) / Sticky (Desktop) -->
  <div
    class="absolute top-4 lg:top-6 right-4 lg:right-8 flex items-center gap-3 lg:gap-6 z-40"
  >
    <div class="hidden sm:flex items-center gap-3">
      <div
        class="w-10 h-10 bg-teal-500 rounded-xl flex items-center justify-center shadow-md flex-shrink-0"
      >
        <span class="text-white font-bold text-lg">K</span>
      </div>
      <h1 class="text-lg lg:text-2xl font-bold text-slate-900">Join Kapify</h1>
    </div>
    <a
      routerLink="/login"
      class="text-sm text-slate-700 font-medium border border-slate-200 hover:border-slate-300 bg-white hover:bg-slate-50 transition-all duration-200 px-4 py-2 rounded-xl"
    >
      Sign in
    </a>
  </div>

  <!-- Left Panel - Form -->
  <div
    class="w-full lg:w-3/5 flex items-center justify-center px-4 py-8 lg:px-8 lg:py-12 bg-white"
  >
    <div class="w-full max-w-md">
      <!-- Progress Indicator -->
      <div class="mb-8">
        <div class="flex items-center gap-2 mb-4">
          <div class="text-sm font-medium text-slate-600">
            Step {{ currentStep() }} of 2
          </div>
          <div class="flex-1 h-1.5 bg-slate-100 rounded-full overflow-hidden">
            <div
              class="h-full bg-gradient-to-r from-teal-400 to-teal-500 rounded-full transition-all duration-500 ease-out"
              [style.width.%]="currentStep() === 1 ? 50 : 100"
            ></div>
          </div>
        </div>
      </div>

      <!-- Form -->
      <form
        [formGroup]="registerForm"
        (ngSubmit)="onSubmit()"
        class="space-y-5"
      >
        <!-- ============================================
             STEP 1: Account Type & Identity
             ============================================ -->
        @if (currentStep() === 1) {
        <div class="space-y-5 animate-fade-in">
          <!-- User Type Selection -->
          <div>
            <label class="block text-sm font-semibold text-slate-900 mb-3">
              Register as
            </label>
            <div class="grid grid-cols-2 gap-3">
              <button
                type="button"
                [class]="getUserTypeButtonClasses('sme')"
                (click)="selectUserType('sme')"
                class="transition-all duration-200"
              >
                <div class="font-medium text-sm text-slate-900">
                  Business Owner
                </div>
                <div class="text-xs text-slate-600 mt-1 text-center">
                  I need funding
                </div>
              </button>
              <button
                type="button"
                [class]="getUserTypeButtonClasses('funder')"
                (click)="selectUserType('funder')"
                class="transition-all duration-200"
              >
                <div class="font-medium text-sm text-slate-900">Investor</div>
                <div class="text-xs text-slate-600 mt-1 text-center">
                  I provide funding
                </div>
              </button>
            </div>
          </div>

          <!-- Name Fields -->
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-semibold text-slate-900 mb-2">
                First name
              </label>
              <input
                type="text"
                formControlName="firstName"
                placeholder="John"
                [class]="getInputClasses('firstName')"
              />
              @if (getFieldError('firstName')) {
              <p class="mt-1.5 text-sm text-red-700">
                {{ getFieldError("firstName") }}
              </p>
              }
            </div>
            <div>
              <label class="block text-sm font-semibold text-slate-900 mb-2">
                Last name
              </label>
              <input
                type="text"
                formControlName="lastName"
                placeholder="Doe"
                [class]="getInputClasses('lastName')"
              />
              @if (getFieldError('lastName')) {
              <p class="mt-1.5 text-sm text-red-700">
                {{ getFieldError("lastName") }}
              </p>
              }
            </div>
          </div>

          <!-- Email -->
          <div>
            <label class="block text-sm font-semibold text-slate-900 mb-2">
              Email address
            </label>
            <input
              type="email"
              formControlName="email"
              placeholder="you@company.co.za"
              [class]="getInputClasses('email')"
            />
            @if (getFieldError('email')) {
            <p class="mt-1.5 text-sm text-red-700">
              {{ getFieldError("email") }}
            </p>
            }
          </div>

          <!-- Error Message (Step 1) -->
          @if (error()) {
          <div
            class="bg-red-50 border border-red-200/50 text-red-700 px-4 py-3 rounded-xl text-sm flex items-start gap-3"
          >
            <lucide-icon
              name="alert-circle"
              [size]="18"
              class="flex-shrink-0 mt-0.5"
            />
            <span>{{ error() }}</span>
          </div>
          }

          <!-- Continue Button -->
          <button
            type="button"
            (click)="nextStep()"
            [disabled]="!isStep1Valid()"
            class="w-full bg-teal-500 hover:bg-teal-600 active:bg-teal-700 disabled:bg-slate-100 disabled:text-slate-400 disabled:cursor-not-allowed text-white font-medium py-2.5 px-6 rounded-xl transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-offset-2 flex items-center justify-center"
          >
            <span>Continue</span>
            <lucide-icon name="arrow-right" [size]="20" class="ml-2" />
          </button>
        </div>
        }

        <!-- ============================================
             STEP 2: Contact & Security
             ============================================ -->
        @if (currentStep() === 2) {
        <div class="space-y-5 animate-fade-in">
          <!-- Step 1 Summary (Read-only) -->
          <div class="bg-teal-50 border border-teal-300/50 rounded-xl p-4">
            <div class="grid grid-cols-3 gap-3 text-sm">
              <div>
                <p class="text-teal-900 font-semibold">
                  {{ registerForm.get("firstName")?.value }}
                  {{ registerForm.get("lastName")?.value }}
                </p>
                <p class="text-teal-700 text-xs">Name</p>
              </div>
              <div>
                <p class="text-teal-900 font-semibold">
                  {{ registerForm.get("email")?.value }}
                </p>
                <p class="text-teal-700 text-xs">Email</p>
              </div>
              <div>
                <p class="text-teal-900 font-semibold">
                  {{
                    selectedUserType() === "sme" ? "Business Owner" : "Investor"
                  }}
                </p>
                <p class="text-teal-700 text-xs">Type</p>
              </div>
            </div>
          </div>

          <!-- Phone -->
          <div>
            <label class="block text-sm font-semibold text-slate-900 mb-2">
              Phone number
            </label>
            <input
              type="tel"
              formControlName="phone"
              placeholder="+27 81 123 4567"
              [class]="getInputClasses('phone')"
            />
            @if (getFieldError('phone')) {
            <p class="mt-1.5 text-sm text-red-700">
              {{ getFieldError("phone") }}
            </p>
            }
          </div>

          <!-- Company Name (SME only) -->
          @if (selectedUserType() === 'sme') {
          <div>
            <label class="block text-sm font-semibold text-slate-900 mb-2">
              Company name
            </label>
            <input
              type="text"
              formControlName="companyName"
              placeholder="Your Company (Pty) Ltd"
              [class]="getInputClasses('companyName')"
            />
            @if (getFieldError('companyName')) {
            <p class="mt-1.5 text-sm text-red-700">
              {{ getFieldError("companyName") }}
            </p>
            }
          </div>
          }

          <!-- Password -->
          <div>
            <label class="block text-sm font-semibold text-slate-900 mb-2">
              Password
            </label>
            <div class="relative">
              <input
                [type]="showPassword() ? 'text' : 'password'"
                formControlName="password"
                placeholder="Create a strong password"
                [class]="getInputClasses('password')"
              />
              <button
                type="button"
                tabindex="-1"
                class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600 transition-colors duration-200 flex-shrink-0"
                (click)="togglePasswordVisibility()"
                [attr.aria-label]="
                  showPassword() ? 'Hide password' : 'Show password'
                "
              >
                <lucide-icon
                  [name]="showPassword() ? 'eye-off' : 'eye'"
                  [size]="20"
                />
              </button>
            </div>
            @if (getFieldError('password')) {
            <p class="mt-1.5 text-sm text-red-700">
              {{ getFieldError("password") }}
            </p>
            } @if (registerForm.get('password')?.value &&
            getPasswordStrengthIndicator().label) {
            <p
              class="mt-2 text-xs font-medium"
              [class]="'text-' + getPasswordStrengthIndicator().color"
            >
              Strength: {{ getPasswordStrengthIndicator().label }}
            </p>
            }
          </div>

          <!-- Confirm Password -->
          <div>
            <label class="block text-sm font-semibold text-slate-900 mb-2">
              Confirm password
            </label>
            <div class="relative">
              <input
                [type]="showConfirmPassword() ? 'text' : 'password'"
                formControlName="confirmPassword"
                placeholder="Confirm your password"
                [class]="getInputClasses('confirmPassword')"
              />
              <button
                type="button"
                tabindex="-1"
                class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600 transition-colors duration-200 flex-shrink-0"
                (click)="toggleConfirmPasswordVisibility()"
                [attr.aria-label]="
                  showConfirmPassword() ? 'Hide password' : 'Show password'
                "
              >
                <lucide-icon
                  [name]="showConfirmPassword() ? 'eye-off' : 'eye'"
                  [size]="20"
                />
              </button>
            </div>
            @if (getFieldError('confirmPassword')) {
            <p class="mt-1.5 text-sm text-red-700">
              {{ getFieldError("confirmPassword") }}
            </p>
            }
          </div>

          <!-- Terms & Privacy -->
          <div class="flex items-start gap-3 p-4 bg-slate-50 rounded-xl">
            <input
              type="checkbox"
              id="agreeToTerms"
              formControlName="agreeToTerms"
              [class]="getCheckboxClasses()"
              class="mt-1 flex-shrink-0 cursor-pointer"
            />
            <label
              for="agreeToTerms"
              class="text-xs text-slate-600 leading-relaxed cursor-pointer"
            >
              I agree to the
              <a
                href="/privacy"
                class="text-slate-900 font-semibold hover:underline"
                >Privacy Policy</a
              >,
              <a
                href="/terms"
                class="text-slate-900 font-semibold hover:underline"
                >Terms of Service</a
              >, and
              <a
                href="/data-protection"
                class="text-slate-900 font-semibold hover:underline"
                >Data Protection Policy</a
              >
            </label>
          </div>
          @if (getFieldError('agreeToTerms')) {
          <p class="text-sm text-red-700">
            {{ getFieldError("agreeToTerms") }}
          </p>
          }

          <!-- Error Message (Step 2) -->
          @if (error()) {
          <div
            class="bg-red-50 border border-red-200/50 text-red-700 px-4 py-3 rounded-xl text-sm flex items-start gap-3"
          >
            <lucide-icon
              name="alert-circle"
              [size]="18"
              class="flex-shrink-0 mt-0.5"
            />
            <span>{{ error() }}</span>
          </div>
          }

          <!-- Button Group -->
          <div class="flex gap-3">
            <button
              type="button"
              (click)="previousStep()"
              class="flex-1 bg-slate-100 hover:bg-slate-200 active:bg-slate-300 text-slate-700 font-medium py-2.5 px-6 rounded-xl transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-slate-400 focus:ring-offset-2"
            >
              <span>Back</span>
            </button>
            <button
              type="submit"
              [disabled]="registerForm.invalid || isLoading()"
              class="flex-1 bg-teal-500 hover:bg-teal-600 active:bg-teal-700 disabled:bg-slate-100 disabled:text-slate-400 disabled:cursor-not-allowed text-white font-medium py-2.5 px-6 rounded-xl transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-offset-2 flex items-center justify-center"
            >
              @if (isLoading()) {
              <div
                class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin mr-2"
              ></div>
              <span>Creating account...</span>
              } @else {
              <span>Yes. Create account</span>
              }
            </button>
          </div>
        </div>
        }
      </form>
    </div>
  </div>

  <!-- Right Panel - Slideshow (Desktop only) -->
  <div class="hidden lg:flex lg:w-2/5 relative overflow-hidden bg-white">
    <ng-container *ngFor="let slide of slides(); let i = index">
      <img
        [src]="slide.image"
        [alt]="slide.title || 'slide-' + i"
        class="absolute inset-0 w-full h-full object-cover transition-opacity duration-700"
        [ngClass]="{
          'opacity-100 z-20': activeSlideIndex() === i,
          'opacity-0 z-10': activeSlideIndex() !== i
        }"
        (mouseenter)="stopAutoplay()"
        (mouseleave)="startAutoplay()"
      />
    </ng-container>

    <div
      class="absolute inset-0 pointer-events-none bg-gradient-to-t from-black/55 via-black/30 to-transparent"
    ></div>

    <div class="absolute left-8 bottom-12 max-w-lg text-white z-30">
      <h2 class="text-3xl md:text-4xl font-bold leading-tight drop-shadow-md">
        {{ slides()[activeSlideIndex()].title }}
      </h2>
      <p class="mt-3 text-sm md:text-base text-white/90 max-w-md">
        {{ slides()[activeSlideIndex()].subtitle }}
      </p>

      <div class="mt-6 flex items-center gap-4">
        <div class="flex items-center gap-2">
          <button
            *ngFor="let s of slides(); let idx = index"
            (click)="selectSlide(idx); stopAutoplay()"
            [attr.aria-label]="'Go to slide ' + (idx + 1)"
            class="w-3 h-3 rounded-full transform transition-all duration-200"
            [ngClass]="{
              'scale-125 bg-white': activeSlideIndex() === idx,
              'bg-white/40 hover:bg-white/60': activeSlideIndex() !== idx
            }"
          ></button>
        </div>

        <div class="ml-4 flex items-center gap-2">
          <button
            (click)="prevSlide(); stopAutoplay()"
            class="px-3 py-2 rounded-lg bg-white/10 hover:bg-white/20 text-white text-sm transition-colors"
          >
            ‹
          </button>
          <button
            (click)="nextSlide(); stopAutoplay()"
            class="px-3 py-2 rounded-lg bg-white/10 hover:bg-white/20 text-white text-sm transition-colors"
          >
            ›
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(4px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .animate-fade-in {
    animation: fadeIn 300ms ease-out;
  }
</style>
