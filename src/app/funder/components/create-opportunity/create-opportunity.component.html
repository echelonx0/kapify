<div class="mx-auto p-6">
  <!-- Header -->
  <div class="mb-8">
    <div class="flex items-center justify-between mb-6">
      <div class="flex items-center space-x-3">
        <button 
          class="flex items-center text-gray-600 hover:text-gray-900 transition-colors group"
          (click)="goBack()"
        >
          <lucide-angular [img]="ArrowLeftIcon" [size]="16" class="mr-2 group-hover:-translate-x-1 transition-transform"></lucide-angular>
          @if (isEditMode()) {
            Back 
          } @else {
            Go back
          }
        </button>
      </div>
      <div class="flex items-center space-x-3">
        <!-- Save Status Indicators -->
        @if (showDatabaseSaveStatus()) {
          <div class="flex items-center text-sm text-green-600">
            <lucide-angular [img]="CheckIcon" [size]="14" class="mr-1"></lucide-angular>
            {{ getLastSavedText() }}
          </div>
        }
        
        @if (showLocalSaveStatus()) {
          <div class="flex items-center text-sm text-blue-600">
            <lucide-angular [img]="ClockIcon" [size]="14" class="mr-1"></lucide-angular>
            {{ getLocalSaveText() }}
          </div>
        }
        
        @if (showUnsavedIndicator()) {
          <div class="flex items-center text-sm text-orange-600">
            <lucide-angular [img]="AlertCircleIcon" [size]="14" class="mr-1"></lucide-angular>
            Unsaved changes
          </div>
        }

        <button class="px-4 py-2 text-sm text-gray-600 hover:text-gray-900 transition-colors">
          <lucide-angular [img]="EyeIcon" [size]="16" class="mr-2 inline"></lucide-angular>
          Preview
        </button>
        <button class="px-4 py-2 text-sm text-gray-600 hover:text-gray-900 transition-colors">
          <lucide-angular [img]="HelpCircleIcon" [size]="16" class="mr-2 inline"></lucide-angular>
          Help
        </button>
      </div>
    </div>
    
    <div>
      <div class="flex items-center gap-3 mb-2">
        <h1 class="text-3xl font-bold text-gray-900">{{ getPageTitle() }}</h1>
        @if (isEditMode()) {
          <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
            Editing
          </span>
        } @else {
          <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
            New Draft
          </span>
        }
      </div>
      <p class="text-gray-600">{{ getPageSubtitle() }}</p>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
    <!-- Left Sidebar - Steps Navigation -->
    <div class="lg:col-span-1">
      <div class="bg-white rounded-xl border border-gray-200 shadow-sm p-6 sticky top-6">
        <h3 class="font-semibold text-gray-900 mb-4">Progress</h3>
        <div class="space-y-1">
          @for (step of steps(); track step.id; let i = $index) {
            <div 
              class="flex items-center space-x-3 p-3 rounded-lg cursor-pointer transition-colors"
              [class]="getStepCardClasses(step.id)"
              (click)="goToStep(step.id)"
            >
              <div [class]="getStepIconClasses(step.id)">
                @if (isStepCompleted(step.id)) {
                  <lucide-angular [img]="CheckIcon" [size]="16" class="text-white"></lucide-angular>
                } @else {
                  <span class="text-xs font-semibold">{{ i + 1 }}</span>
                }
              </div>
              <div class="flex-1 min-w-0">
                <p [class]="getStepTitleClasses(step.id)">{{ step.title }}</p>
                <p [class]="getStepDescriptionClasses(step.id)">{{ step.description }}</p>
              </div>
            </div>
          }
        </div>

        <!-- Progress Bar -->
        <div class="mt-6">
          <div class="flex justify-between text-xs text-gray-600 mb-2">
            <span>Progress</span>
            <span>{{ getCurrentStepIndex() + 1 }} of {{ steps().length }}</span>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-2">
            <div 
              class="bg-primary-500 h-2 rounded-full transition-all duration-300" 
              [style.width.%]="getProgressPercentage()"
            ></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Content Area -->
    <div class="lg:col-span-3">
      <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
        <!-- Form Header -->
        <div class="p-6 border-b border-gray-200 bg-gradient-to-r from-primary-50 to-indigo-50">
          <div class="flex items-center space-x-4">
            <div class="w-12 h-12 bg-primary-100 rounded-xl flex items-center justify-center">
              <lucide-angular [img]="getCurrentStepIcon()" [size]="24" class="text-primary-600"></lucide-angular>
            </div>
            <div>
              <h2 class="text-xl font-semibold text-gray-900">{{ getCurrentStepTitle() }}</h2>
              <p class="text-sm text-gray-600 mt-1">{{ getCurrentStepSubtitle() }}</p>
            </div>
          </div>
        </div>

        <!-- Current Step Validation Errors -->
        @if (hasCurrentStepErrors()) {
          <div class="p-4 bg-red-50 border-b border-red-200">
            <div class="flex">
              <lucide-angular [img]="AlertCircleIcon" [size]="20" class="text-red-500 mt-0.5 mr-3"></lucide-angular>
              <div>
                <h4 class="text-sm font-medium text-red-800">Please fix the following issues:</h4>
                <ul class="mt-2 text-sm text-red-700 space-y-1">
                  @for (error of currentStepErrors(); track error.field) {
                    <li class="flex items-center">
                      <span class="w-1.5 h-1.5 bg-red-400 rounded-full mr-2"></span>
                      {{ error.message }}
                    </li>
                  }
                </ul>
              </div>
            </div>
          </div>
        }

        <!-- Form Content -->
        <div class="p-6 space-y-8" [@stepTransition]>

          <!-- Step: Basic Info -->
          @if (currentStep() === 'basic') {
            <div class="space-y-6">
              <!-- Title Field -->
              <div class="space-y-2">
                <label class="block text-sm font-semibold text-gray-700">
                  Opportunity Title <span class="text-red-500">*</span>
                </label>
                <input 
                  type="text" 
                  placeholder="e.g., Growth Capital for Tech Startups"
                  [value]="formData().title"
                  (input)="updateField('title', $event)"
                  [class]="getFieldClasses('title')"
                >
                @if (getFieldError('title'); as error) {
                  <p class="text-sm" [class.text-red-600]="error.type === 'error'" [class.text-yellow-600]="error.type === 'warning'">
                    {{ error.message }}
                  </p>
                }
              </div>

              <!-- Short Description Field -->
              <div class="space-y-2">
                <label class="block text-sm font-semibold text-gray-700">
                  Short Description <span class="text-red-500">*</span>
                </label>
                <input 
                  type="text" 
                  placeholder="Brief summary for listings (150 characters max)"
                  [value]="formData().shortDescription"
                  (input)="updateField('shortDescription', $event)"
                  maxlength="150"
                  [class]="getFieldClasses('shortDescription')"
                >
                <div class="flex justify-between">
                  @if (getFieldError('shortDescription'); as error) {
                    <p class="text-sm" [class.text-red-600]="error.type === 'error'" [class.text-yellow-600]="error.type === 'warning'">
                      {{ error.message }}
                    </p>
                  } @else {
                    <span></span>
                  }
                  <p class="text-xs text-gray-500">{{ formData().shortDescription.length }}/150 characters</p>
                </div>
              </div>

              <!-- Full Description Field -->
              <div class="space-y-2">
                <label class="block text-sm font-semibold text-gray-700">
                  Full Description <span class="text-red-500">*</span>
                </label>
                <textarea 
                  rows="6" 
                  placeholder="Detailed description of your funding opportunity, investment criteria, and what you're looking for in potential partners..."
                  [value]="formData().description"
                  (input)="updateField('description', $event)"
                  [class]="getFieldClasses('description')"
                  class="resize-none"
                ></textarea>
                @if (getFieldError('description'); as error) {
                  <p class="text-sm" [class.text-red-600]="error.type === 'error'" [class.text-yellow-600]="error.type === 'warning'">
                    {{ error.message }}
                  </p>
                }
              </div>
            </div>
          }

          <!-- Step: Investment Terms -->
          @if (currentStep() === 'terms') {
            <div class="space-y-8">
              <!-- Funding Type Selection -->
              <div class="space-y-3">
                <label class="block text-sm font-semibold text-gray-700">
                  Funding Type <span class="text-red-500">*</span>
                </label>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                  <label class="relative cursor-pointer">
                    <input 
                      type="radio" 
                      name="fundingType" 
                      value="debt"
                      [checked]="formData().fundingType === 'debt'"
                      (change)="updateField('fundingType', $event)"
                      class="sr-only peer"
                    >
                    <div class="flex items-center p-4 border border-gray-200 rounded-lg hover:border-primary-300 peer-checked:border-primary-500 peer-checked:bg-primary-50 transition-all"
                         [class.border-red-300]="hasFieldError('fundingType')"
                         [class.hover:border-red-400]="hasFieldError('fundingType')">
                      <div class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center mr-3">
                        <lucide-angular [img]="TrendingUpIcon" [size]="16" class="text-green-600"></lucide-angular>
                      </div>
                      <div>
                        <div class="font-medium text-gray-900">Debt</div>
                        <div class="text-xs text-gray-500">Traditional loan</div>
                      </div>
                    </div>
                  </label>

                  <label class="relative cursor-pointer">
                    <input 
                      type="radio" 
                      name="fundingType" 
                      value="equity"
                      [checked]="formData().fundingType === 'equity'"
                      (change)="updateField('fundingType', $event)"
                      class="sr-only peer"
                    >
                    <div class="flex items-center p-4 border border-gray-200 rounded-lg hover:border-primary-300 peer-checked:border-primary-500 peer-checked:bg-primary-50 transition-all"
                         [class.border-red-300]="hasFieldError('fundingType')"
                         [class.hover:border-red-400]="hasFieldError('fundingType')">
                      <div class="w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center mr-3">
                        <lucide-angular [img]="PieChartIcon" [size]="16" class="text-purple-600"></lucide-angular>
                      </div>
                      <div>
                        <div class="font-medium text-gray-900">Equity</div>
                        <div class="text-xs text-gray-500">Ownership stake</div>
                      </div>
                    </div>
                  </label>

                  <label class="relative cursor-pointer">
                    <input 
                      type="radio" 
                      name="fundingType" 
                      value="convertible"
                      [checked]="formData().fundingType === 'convertible'"
                      (change)="updateField('fundingType', $event)"
                      class="sr-only peer"
                    >
                    <div class="flex items-center p-4 border border-gray-200 rounded-lg hover:border-primary-300 peer-checked:border-primary-500 peer-checked:bg-primary-50 transition-all"
                         [class.border-red-300]="hasFieldError('fundingType')"
                         [class.hover:border-red-400]="hasFieldError('fundingType')">
                      <div class="w-8 h-8 bg-orange-100 rounded-lg flex items-center justify-center mr-3">
                        <lucide-angular [img]="RefreshCwIcon" [size]="16" class="text-orange-600"></lucide-angular>
                      </div>
                      <div>
                        <div class="font-medium text-gray-900">Convertible</div>
                        <div class="text-xs text-gray-500">Converts to equity</div>
                      </div>
                    </div>
                  </label>
                </div>
                @if (getFieldError('fundingType'); as error) {
                  <p class="text-sm text-red-600">{{ error.message }}</p>
                }
              </div>

              <!-- Investment Amounts -->
              <div class="space-y-6">
                <h3 class="text-lg font-semibold text-gray-900">Investment Structure</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <!-- Total Available -->
                  <div class="space-y-2">
                    <label class="block text-sm font-semibold text-gray-700">
                      Total Available <span class="text-red-500">*</span>
                    </label>
                    <div class="relative">
                      <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 text-sm font-medium">ZAR</span>
                      <input 
                        type="text" 
                        placeholder="5,000,000"
                        [value]="formatNumberWithCommas(formData().totalAvailable)"
                        (input)="onNumberInput('totalAvailable', $event)"
                        [class]="getFieldClasses('totalAvailable')"
                        class="pl-12"
                      >
                    </div>
                    @if (getFieldError('totalAvailable'); as error) {
                      <p class="text-sm" [class.text-red-600]="error.type === 'error'" [class.text-yellow-600]="error.type === 'warning'">
                        {{ error.message }}
                      </p>
                    } @else {
                      <p class="text-xs text-gray-500">Total funding pool available</p>
                    }
                  </div>

                  <!-- Typical Investment -->
                  <div class="space-y-2">
                    <label class="block text-sm font-semibold text-gray-700">
                      Typical Investment <span class="text-red-500">*</span>
                    </label>
                    <div class="relative">
                      <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 text-sm font-medium">ZAR</span>
                      <input 
                        type="text" 
                        placeholder="500,000"
                        [value]="formatNumberWithCommas(formData().offerAmount)"
                        (input)="onNumberInput('offerAmount', $event)"
                        [class]="getFieldClasses('offerAmount')"
                        class="pl-12"
                      >
                    </div>
                    @if (getFieldError('offerAmount'); as error) {
                      <p class="text-sm" [class.text-red-600]="error.type === 'error'" [class.text-yellow-600]="error.type === 'warning'">
                        {{ error.message }}
                      </p>
                    } @else {
                      <p class="text-xs text-gray-500">Expected per-business investment</p>
                    }
                  </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <!-- Minimum Investment -->
                  <div class="space-y-2">
                    <label class="block text-sm font-semibold text-gray-700">Minimum Investment</label>
                    <div class="relative">
                      <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 text-sm font-medium">ZAR</span>
                      <input 
                        type="text" 
                        placeholder="100,000"
                        [value]="formatNumberWithCommas(formData().minInvestment)"
                        (input)="onNumberInput('minInvestment', $event)"
                        [class]="getFieldClasses('minInvestment')"
                        class="pl-12"
                      >
                    </div>
                    @if (getFieldError('minInvestment'); as error) {
                      <p class="text-sm" [class.text-red-600]="error.type === 'error'" [class.text-yellow-600]="error.type === 'warning'">
                        {{ error.message }}
                      </p>
                    } @else {
                      <p class="text-xs text-gray-500">Minimum amount investors can contribute</p>
                    }
                  </div>

                  <!-- Maximum Investment -->
                  <div class="space-y-2">
                    <label class="block text-sm font-semibold text-gray-700">Maximum Investment</label>
                    <div class="relative">
                      <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 text-sm font-medium">ZAR</span>
                      <input 
                        type="text" 
                        placeholder="2,000,000"
                        [value]="formatNumberWithCommas(formData().maxInvestment)"
                        (input)="onNumberInput('maxInvestment', $event)"
                        [class]="getFieldClasses('maxInvestment')"
                        class="pl-12"
                      >
                    </div>
                    @if (getFieldError('maxInvestment'); as error) {
                      <p class="text-sm" [class.text-red-600]="error.type === 'error'" [class.text-yellow-600]="error.type === 'warning'">
                        {{ error.message }}
                      </p>
                    } @else {
                      <p class="text-xs text-gray-500">Maximum amount investors can contribute</p>
                    }
                  </div>
                </div>

                <!-- Investment Validation Summary -->
                @if (currentStepErrors().length > 0) {
                  <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                    <div class="flex">
                      <lucide-angular [img]="AlertCircleIcon" [size]="20" class="text-red-500 mr-3 mt-0.5"></lucide-angular>
                      <div>
                        <h4 class="text-sm font-medium text-red-800 mb-2">Investment Amount Issues</h4>
                        <ul class="text-sm text-red-700 space-y-1">
                          @for (error of currentStepErrors(); track error.field) {
                            @if (error.field.includes('Investment') || error.field.includes('Amount') || error.field.includes('Available')) {
                              <li>â€¢ {{ error.message }}</li>
                            }
                          }
                        </ul>
                      </div>
                    </div>
                  </div>
                }
              </div>

              <!-- Terms Section based on funding type -->
              @if (formData().fundingType === 'debt') {
                <div class="bg-gray-50 rounded-xl p-6 space-y-4">
                  <div class="flex items-center space-x-2">
                    <lucide-angular [img]="FileTextIcon" [size]="20" class="text-gray-600"></lucide-angular>
                    <h4 class="text-lg font-semibold text-gray-900">Debt Terms</h4>
                  </div>
                  
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-2">
                      <label class="block text-sm font-semibold text-gray-700">Interest Rate (%)</label>
                      <div class="relative">
                        <input 
                          type="text" 
                          placeholder="12.5"
                          [value]="formData().interestRate"
                          (input)="updateField('interestRate', $event)"
                          [class]="getFieldClasses('interestRate')"
                        >
                        <span class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 text-sm">%</span>
                      </div>
                    </div>

                    <div class="space-y-2">
                      <label class="block text-sm font-semibold text-gray-700">Repayment Terms</label>
                      <select 
                        [value]="formData().repaymentTerms"
                        (change)="updateField('repaymentTerms', $event)"
                        [class]="getFieldClasses('repaymentTerms')"
                      >
                        <option value="">Select terms</option>
                        <option value="monthly">Monthly payments</option>
                        <option value="quarterly">Quarterly payments</option>
                        <option value="annually">Annual payments</option>
                        <option value="bullet">Bullet payment at maturity</option>
                      </select>
                    </div>
                  </div>

                  <div class="space-y-2">
                    <label class="block text-sm font-semibold text-gray-700">Security Requirements</label>
                    <textarea 
                      rows="3" 
                      placeholder="Describe any collateral, guarantees, or security requirements..."
                      [value]="formData().securityRequired"
                      (input)="updateField('securityRequired', $event)"
                      [class]="getFieldClasses('securityRequired')"
                      class="resize-none"
                    ></textarea>
                  </div>
                </div>
              }

              @if (formData().fundingType === 'equity') {
                <div class="bg-purple-50 rounded-xl p-6 space-y-4">
                  <div class="flex items-center space-x-2">
                    <lucide-angular [img]="PieChartIcon" [size]="20" class="text-purple-600"></lucide-angular>
                    <h4 class="text-lg font-semibold text-gray-900">Equity Terms</h4>
                  </div>
                  
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-2">
                      <label class="block text-sm font-semibold text-gray-700">Equity Offered (%)</label>
                      <div class="relative">
                        <input 
                          type="text" 
                          placeholder="15"
                          [value]="formData().equityOffered"
                          (input)="updateField('equityOffered', $event)"
                          [class]="getFieldClasses('equityOffered')"
                        >
                        <span class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 text-sm">%</span>
                      </div>
                    </div>

                    <div class="space-y-2">
                      <label class="block text-sm font-semibold text-gray-700">Expected Returns (%)</label>
                      <div class="relative">
                        <input 
                          type="text" 
                          placeholder="25"
                          [value]="formData().expectedReturns"
                          (input)="updateField('expectedReturns', $event)"
                          [class]="getFieldClasses('expectedReturns')"
                        >
                        <span class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 text-sm">% IRR</span>
                      </div>
                    </div>
                  </div>

                  <div class="space-y-2">
                    <label class="block text-sm font-semibold text-gray-700">Exit Strategy</label>
                    <textarea 
                      rows="3" 
                      placeholder="Describe your preferred exit strategy and timeline..."
                      [value]="formData().exitStrategy"
                      (input)="updateField('exitStrategy', $event)"
                      [class]="getFieldClasses('exitStrategy')"
                      class="resize-none"
                    ></textarea>
                  </div>
                </div>
              }

              <!-- Decision Timeline -->
              <div class="space-y-3">
                <label class="block text-sm font-semibold text-gray-700">
                  Decision Timeframe <span class="text-red-500">*</span>
                </label>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                  @for (timeframe of timeframes; track timeframe.value) {
                    <label class="relative cursor-pointer">
                      <input 
                        type="radio" 
                        name="decisionTimeframe" 
                        [value]="timeframe.value"
                        [checked]="formData().decisionTimeframe === timeframe.value"
                        (change)="updateField('decisionTimeframe', $event)"
                        class="sr-only peer"
                      >
                      <div class="p-3 border border-gray-200 rounded-lg hover:border-primary-300 peer-checked:border-primary-500 peer-checked:bg-primary-50 text-center transition-all">
                        <div class="font-semibold text-gray-900">{{ timeframe.label }}</div>
                        <div class="text-xs text-gray-500">{{ timeframe.description }}</div>
                      </div>
                    </label>
                  }
                </div>
              </div>
            </div>
          }

          <!-- Step: Eligibility Criteria -->
          @if (currentStep() === 'eligibility') {
            <div class="space-y-6">
              <div class="space-y-3">
                <label class="block text-sm font-semibold text-gray-700">Target Industries</label>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                  @for (industry of targetIndustries; track industry.value) {
                    <label class="relative cursor-pointer">
                      <input 
                        type="checkbox" 
                        [value]="industry.value"
                        [checked]="formData().targetIndustries.includes(industry.value)"
                        (change)="updateMultiSelectField('targetIndustries', $event)"
                        class="sr-only peer"
                      >
                      <div class="p-3 border border-gray-200 rounded-lg hover:border-primary-300 peer-checked:border-primary-500 peer-checked:bg-primary-50 text-center transition-all">
                        <div class="text-sm font-medium text-gray-900">{{ industry.label }}</div>
                      </div>
                    </label>
                  }
                </div>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Minimum Revenue -->
                <div class="space-y-2">
                  <label class="block text-sm font-semibold text-gray-700">Minimum Annual Revenue</label>
                  <div class="relative">
                    <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 text-sm font-medium">ZAR</span>
                    <input 
                      type="text" 
                      placeholder="1,000,000"
                      [value]="formatNumberWithCommas(formData().minRevenue)"
                      (input)="onNumberInput('minRevenue', $event)"
                      [class]="getFieldClasses('minRevenue')"
                      class="pl-12"
                    >
                  </div>
                  @if (getFieldError('minRevenue'); as error) {
                    <p class="text-sm" [class.text-red-600]="error.type === 'error'" [class.text-yellow-600]="error.type === 'warning'">
                      {{ error.message }}
                    </p>
                  }
                </div>

                <!-- Maximum Revenue -->
                <div class="space-y-2">
                  <label class="block text-sm font-semibold text-gray-700">Maximum Annual Revenue</label>
                  <div class="relative">
                    <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 text-sm font-medium">ZAR</span>
                    <input 
                      type="text" 
                      placeholder="50,000,000"
                      [value]="formatNumberWithCommas(formData().maxRevenue)"
                      (input)="onNumberInput('maxRevenue', $event)"
                      [class]="getFieldClasses('maxRevenue')"
                      class="pl-12"
                    >
                  </div>
                  @if (getFieldError('maxRevenue'); as error) {
                    <p class="text-sm" [class.text-red-600]="error.type === 'error'" [class.text-yellow-600]="error.type === 'warning'">
                      {{ error.message }}
                    </p>
                  }
                </div>
              </div>

              <div class="space-y-2">
                <label class="block text-sm font-semibold text-gray-700">Minimum Years in Operation</label>
                <select 
                  [value]="formData().minYearsOperation"
                  (change)="updateField('minYearsOperation', $event)"
                  [class]="getFieldClasses('minYearsOperation')"
                >
                  <option value="">No minimum</option>
                  <option value="1">1 year</option>
                  <option value="2">2 years</option>
                  <option value="3">3 years</option>
                  <option value="5">5 years</option>
                </select>
              </div>

              <div class="space-y-3">
                <label class="block text-sm font-semibold text-gray-700">Business Stages</label>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                  @for (stage of businessStages; track stage.value) {
                    <label class="relative cursor-pointer">
                      <input 
                        type="checkbox" 
                        [value]="stage.value"
                        [checked]="formData().businessStages.includes(stage.value)"
                        (change)="updateMultiSelectField('businessStages', $event)"
                        class="sr-only peer"
                      >
                      <div class="p-3 border border-gray-200 rounded-lg hover:border-primary-300 peer-checked:border-primary-500 peer-checked:bg-primary-50 text-center transition-all">
                        <div class="text-sm font-medium text-gray-900">{{ stage.label }}</div>
                      </div>
                    </label>
                  }
                </div>
              </div>
            </div>
          }

          <!-- Step: Settings -->
          @if (currentStep() === 'settings') {
            <div class="space-y-6">
              <div class="space-y-4">
                <h3 class="text-lg font-semibold text-gray-900">Visibility Settings</h3>
                
                <div class="space-y-4">
                  <label class="flex items-start space-x-3 cursor-pointer">
                    <input 
                      type="checkbox" 
                      [checked]="formData().isPublic"
                      (change)="updateCheckboxField('isPublic', $event)"
                      class="mt-1 h-4 w-4 text-primary-600 border-gray-300 rounded focus:ring-primary-500"
                    >
                    <div>
                      <div class="font-medium text-gray-900">Public Opportunity</div>
                      <p class="text-sm text-gray-600">Make this opportunity visible to all qualified SMEs on the platform</p>
                    </div>
                  </label>

                  <label class="flex items-start space-x-3 cursor-pointer">
                    <input 
                      type="checkbox" 
                      [checked]="formData().autoMatch"
                      (change)="updateCheckboxField('autoMatch', $event)"
                      class="mt-1 h-4 w-4 text-primary-600 border-gray-300 rounded focus:ring-primary-500"
                    >
                    <div>
                      <div class="font-medium text-gray-900">Auto-match Applications</div>
                      <p class="text-sm text-gray-600">Automatically suggest this opportunity to qualified businesses</p>
                    </div>
                  </label>
                </div>
              </div>

              <div class="space-y-4">
                <h3 class="text-lg font-semibold text-gray-900">Application Settings</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div class="space-y-2">
                    <label class="block text-sm font-semibold text-gray-700">Application Deadline</label>
                    <input 
                      type="date" 
                      [value]="formData().applicationDeadline"
                      (input)="updateField('applicationDeadline', $event)"
                      [class]="getFieldClasses('applicationDeadline')"
                    >
                    @if (getFieldError('applicationDeadline'); as error) {
                      <p class="text-sm" [class.text-red-600]="error.type === 'error'" [class.text-yellow-600]="error.type === 'warning'">
                        {{ error.message }}
                      </p>
                    }
                  </div>

                  <div class="space-y-2">
                    <label class="block text-sm font-semibold text-gray-700">Maximum Applications</label>
                    <input 
                      type="text" 
                      placeholder="No limit"
                      [value]="formatNumberWithCommas(formData().maxApplications)"
                      (input)="onNumberInput('maxApplications', $event)"
                      [class]="getFieldClasses('maxApplications')"
                    >
                    @if (getFieldError('maxApplications'); as error) {
                      <p class="text-sm" [class.text-red-600]="error.type === 'error'" [class.text-yellow-600]="error.type === 'warning'">
                        {{ error.message }}
                      </p>
                    }
                  </div>
                </div>
              </div>
            </div>
          }

          <!-- Step: Review -->
          @if (currentStep() === 'review') {
            <div class="space-y-6">
              <!-- Validation Summary -->
              @if (validationErrors().length > 0) {
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                  <div class="flex">
                    <lucide-angular [img]="AlertCircleIcon" [size]="20" class="text-yellow-500 mr-3 mt-0.5"></lucide-angular>
                    <div>
                      <h4 class="text-sm font-medium text-yellow-800 mb-2">Review Required</h4>
                      <p class="text-sm text-yellow-700 mb-3">Please review the following items before publishing:</p>
                      <ul class="text-sm text-yellow-700 space-y-1">
                        @for (error of validationErrors(); track error.field) {
                          <li class="flex items-center">
                            <span class="w-1.5 h-1.5 bg-yellow-400 rounded-full mr-2"></span>
                            {{ error.message }}
                          </li>
                        }
                      </ul>
                    </div>
                  </div>
                </div>
              }

              <div class="bg-gray-50 rounded-xl p-6">
                <h4 class="font-medium text-gray-900 mb-4">Opportunity Summary</h4>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                  <div>
                    <span class="text-gray-500">Title:</span>
                    <div class="font-medium">{{ formData().title || 'Not specified' }}</div>
                  </div>
                  <div>
                    <span class="text-gray-500">Funding Type:</span>
                    <div class="font-medium capitalize">{{ formData().fundingType || 'Not specified' }}</div>
                  </div>
                  <div>
                    <span class="text-gray-500">Total Available:</span>
                    <div class="font-medium">{{ formData().currency }} {{ getFormattedAmount('totalAvailable') }}</div>
                  </div>
                  <div>
                    <span class="text-gray-500">Typical Investment:</span>
                    <div class="font-medium">{{ formData().currency }} {{ getFormattedAmount('offerAmount') }}</div>
                  </div>
                  <div>
                    <span class="text-gray-500">Decision Timeframe:</span>
                    <div class="font-medium">{{ formData().decisionTimeframe || 'Not specified' }} days</div>
                  </div>
                  <div>
                    <span class="text-gray-500">Visibility:</span>
                    <div class="font-medium">{{ formData().isPublic ? 'Public' : 'Private' }}</div>
                  </div>
                </div>

                @if (formData().description) {
                  <div class="mt-4">
                    <span class="text-gray-500 text-sm">Description:</span>
                    <div class="mt-1 text-sm">{{ formData().description }}</div>
                  </div>
                }

                @if (formData().targetIndustries.length > 0) {
                  <div class="mt-4">
                    <span class="text-gray-500 text-sm">Target Industries:</span>
                    <div class="mt-1 text-sm">{{ formData().targetIndustries.join(', ') }}</div>
                  </div>
                }

                @if (formData().businessStages.length > 0) {
                  <div class="mt-4">
                    <span class="text-gray-500 text-sm">Business Stages:</span>
                    <div class="mt-1 text-sm">{{ formData().businessStages.join(', ') }}</div>
                  </div>
                }
              </div>

              <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                <div class="flex">
                  <lucide-angular [img]="CheckIcon" [size]="20" class="text-green-500 mr-3 mt-0.5"></lucide-angular>
                  <div>
                    <h4 class="text-sm font-medium text-green-800">Ready to Publish</h4>
                    <p class="mt-1 text-sm text-green-700">
                      Once published, qualified SMEs will be able to view and apply for this opportunity.
                      You can edit or pause the opportunity at any time.
                    </p>
                  </div>
                </div>
              </div>
            </div>
          }
        </div>

        <!-- Form Actions -->
        <div class="px-6 py-4 bg-gray-50 border-t border-gray-200 flex items-center justify-between">
          <div class="flex items-center space-x-3">
            <button 
              class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-all"
              [disabled]="currentStep() === 'basic'"
              (click)="previousStep()"
            >
              <lucide-angular [img]="ArrowLeftIcon" [size]="16" class="mr-2 inline"></lucide-angular>
              Previous
            </button>
            
            <button 
              class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-all"
              (click)="goBack()"
            >
              Cancel
            </button>

            @if (isCreateMode()) {
              <button 
                class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-all"
                (click)="clearDraft()"
                title="Clear form and start over"
              >
                Clear Form
              </button>
            }
          </div>

          <div class="flex items-center space-x-3">
            <button 
              class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-all"
              (click)="saveDraft()"
              [disabled]="isSaving()"
            >
              <lucide-angular [img]="SaveIcon" [size]="16" class="mr-2 inline"></lucide-angular>
              @if (isSaving()) {
                Saving...
              } @else {
                {{ getSaveButtonText() }}
              }
            </button>

            @if (currentStep() === 'review') {
              <button 
                class="px-6 py-2 bg-primary-600 border border-transparent rounded-lg text-sm font-medium text-white hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 flex items-center transition-all"
                (click)="publishOpportunity()"
                [disabled]="!canPublish() || isPublishing()"
              >
                @if (isPublishing()) {
                  <lucide-angular [img]="RefreshCwIcon" [size]="16" class="mr-2 animate-spin"></lucide-angular>
                  @if (isEditMode()) {
                    Saving Changes...
                  } @else {
                    Publishing...
                  }
                } @else {
                  @if (isEditMode()) {
                    <lucide-angular [img]="SaveIcon" [size]="16" class="mr-2"></lucide-angular>
                    Save Changes
                  } @else {
                    <lucide-angular [img]="CheckIcon" [size]="16" class="mr-2"></lucide-angular>
                    Publish Opportunity
                  }
                }
              </button>
            } @else {
              <button 
                class="px-6 py-2 bg-primary-600 border border-transparent rounded-lg text-sm font-medium text-white hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 flex items-center transition-all"
                (click)="nextStep()"
                [disabled]="!canContinue()"
              >
                Continue
                <lucide-angular [img]="ArrowRightIcon" [size]="16" class="ml-2"></lucide-angular>
              </button>
            }
          </div>
        </div>
      </div>
    </div>

    <!-- Right Sidebar - AI Assistant -->
    <div class="lg:col-span-1">
      <app-ai-assistant 
        [currentStep]="currentStep()"
        [formData]="formData()"
        [completionPercentage]="getCompletionPercentage()"
      ></app-ai-assistant>
    </div>
  </div>
</div>