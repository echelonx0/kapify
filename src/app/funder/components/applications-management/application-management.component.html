<!-- src/app/funder/components/applications-management/application-management.component.html -->
<div class="min-h-screen bg-neutral-50">
  <sidebar-nav />
  <div class="ml-16">
    <main class="p-6 max-w-7xl mx-auto">
      
      <!-- Header using design system -->
      <div class="page-header">
        <div class="header-actions">
          <ui-button variant="outline" (clicked)="goBack()">
            <lucide-icon [img]="ArrowLeftIcon" [size]="16" class="mr-2" />
            Back
          </ui-button>
          
          @if (opportunity()) {
            <div>
              <h1 class="header-title">Applications to {{ opportunity()?.title }}</h1>
            </div>
          }
        </div>

        <!-- Stats Cards - keep original responsive layout -->
        @if (stats() && !isLoading()) {
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="card p-4">
              <div class="flex items-center space-x-3">
                <div class="icon-container blue w-10 h-10">
                  <lucide-icon [img]="FileTextIcon" [size]="20" />
                </div>
                <div>
                  <p class="text-2xl font-bold text-neutral-900">{{ stats()!.total }}</p>
                  <p class="text-sm text-neutral-600">Total Applications</p>
                </div>
              </div>
            </div>

            <div class="card p-4">
              <div class="flex items-center space-x-3">
                <div class="icon-container orange w-10 h-10">
                  <lucide-icon [img]="ClockIcon" [size]="20" />
                </div>
                <div>
                  <p class="text-2xl font-bold text-neutral-900">{{ stats()!.byStatus['under_review'] || 0 }}</p>
                  <p class="text-sm text-neutral-600">Under Review</p>
                </div>
              </div>
            </div>

            <div class="card p-4">
              <div class="flex items-center space-x-3">
                <div class="icon-container green w-10 h-10">
                  <lucide-icon [img]="CheckCircleIcon" [size]="20" />
                </div>
                <div>
                  <p class="text-2xl font-bold text-neutral-900">{{ stats()!.byStatus['approved'] || 0 }}</p>
                  <p class="text-sm text-neutral-600">Approved</p>
                </div>
              </div>
            </div>

            <div class="card p-4">
              <div class="flex items-center space-x-3">
                <div class="icon-container neutral w-10 h-10">
                  <lucide-icon [img]="TrendingUpIcon" [size]="20" />
                </div>
                <div>
                  <p class="text-2xl font-bold text-neutral-900">{{ stats()!.averageProcessingTime }}</p>
                  <p class="text-sm text-neutral-600">Avg. Processing Days</p>
                </div>
              </div>
            </div>
          </div>
        }
      </div>

      <!-- Tab Navigation using design system -->
      <div class="tab-navigation">
        <div class="tab-container">
          <nav class="tab-list">
            @for (tab of tabs(); track tab.id) {
              <button
                (click)="setActiveTab(tab.id)"
                class="tab-button"
                [class.active]="activeTab() === tab.id"
              >
                <div class="flex items-center space-x-2">
                  <lucide-icon [img]="tab.icon" [size]="16" />
                  <span>{{ tab.label }}</span>
                  @if (tab.count !== undefined) {
                    <span class="bg-neutral-100 text-neutral-600 px-2 py-1 rounded-full text-xs">
                      {{ tab.count }}
                    </span>
                  }
                </div>
              </button>
            }
          </nav>
        </div>
      </div>

      <!-- Filters using design system -->
      @if (activeTab() !== 'overview') {
        <div class="filter-bar">
          <div class="filter-controls">
            <!-- Search -->
            <div class="flex-1 relative">
              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <lucide-icon [img]="SearchIcon" [size]="16" class="text-neutral-400" />
              </div>
              <input
                type="text"
                placeholder="Search applications..."
                [value]="searchQuery()"
                (input)="onSearchChange($event)"
                class="block w-full pl-10 pr-3 py-2 border border-neutral-300 rounded-md placeholder-neutral-400 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 sm:text-sm"
              />
            </div>

            <!-- Status Filter -->
            <select
              [value]="statusFilter()"
              (change)="onStatusFilterChange($event)"
              class="px-3 py-2 border border-neutral-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 sm:text-sm"
            >
              <option value="">All Status</option>
              <option value="submitted">Submitted</option>
              <option value="under_review">Under Review</option>
              <option value="approved">Approved</option>
              <option value="rejected">Rejected</option>
            </select>

            <!-- Stage Filter -->
            <select
              [value]="stageFilter()"
              (change)="onStageFilterChange($event)"
              class="px-3 py-2 border border-neutral-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 sm:text-sm"
            >
              <option value="">All Stages</option>
              <option value="initial_review">Initial Review</option>
              <option value="due_diligence">Due Diligence</option>
              <option value="investment_committee">Investment Committee</option>
              <option value="documentation">Documentation</option>
            </select>

            @if (hasActiveFilters()) {
              <ui-button variant="outline" (clicked)="clearFilters()">
                Clear Filters
              </ui-button>
            }
          </div>
        </div>
      }

      <!-- Loading State using design system -->
      @if (isLoading()) {
        <div class="card p-12 text-center">
          <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600 mx-auto mb-4"></div>
          <p class="text-neutral-600">Loading applications...</p>
        </div>
      }

      <!-- Tab Content -->
      @if (!isLoading()) {
        <!-- Overview Tab -->
        @if (activeTab() === 'overview') {
          <div class="space-y-6">
            <!-- Recent Activity using design system -->
            <div class="section-card">
              <div class="section-header">
                <h3 class="section-title">Recent Activity</h3>
              </div>
              <div class="p-6">
                @if (recentApplications().length > 0) {
                  <div class="space-y-4">
                    @for (app of recentApplications(); track app.id) {
                      <div class="flex items-center space-x-4 p-3 bg-neutral-50 rounded-lg">
                        <div class="w-10 h-10 bg-gradient-to-br from-primary-100 to-primary-200 rounded-lg flex items-center justify-center">
                          <span class="text-primary-700 font-bold text-sm">{{ getInitials(app.applicant?.firstName, app.applicant?.lastName) }}</span>
                        </div>
                        <div class="flex-1">
                          <p class="font-medium text-neutral-900">{{ app.title }}</p>
                          <div class="flex items-center space-x-2 text-sm text-neutral-600">
                            <span>{{ app.applicant?.firstName }} {{ app.applicant?.lastName }}</span>
                            <span>â€¢</span>
                            <span>{{ formatDate(app.updatedAt) }}</span>
                          </div>
                        </div>
                        <span class="status-badge" [class]="'status-' + app.status.replace('_', '-')">
                          {{ getStatusText(app.status) }}
                        </span>
                      </div>
                    }
                  </div>
                } @else {
                  <div class="empty-state">
                    <div class="empty-icon">
                      <lucide-icon [img]="FileTextIcon" [size]="32" class="text-neutral-400" />
                    </div>
                    <h3 class="empty-title">No recent activity</h3>
                    <p class="empty-description">Activity will appear here as applications are submitted and reviewed.</p>
                  </div>
                }
              </div>
            </div>

       </div>
        }

        <!-- Applications List using design system -->
        @if (activeTab() !== 'overview') {
          <div class="space-y-4">
            @if (displayedApplications().length > 0) {
              @for (application of displayedApplications(); track application.id) {
                <div class="card hover:shadow-card-hover transition-shadow">
                  <div class="p-6">
                    <div class="flex items-start justify-between">
                      <div class="flex-1">
                        <div class="flex items-center space-x-3 mb-2">
                          <h3 class="text-lg font-medium text-neutral-900">{{ application.title }}</h3>
                          <span class="status-badge" [class]="'status-' + application.status.replace('_', '-')">
                            {{ getStatusText(application.status) }}
                          </span>
                          <span class="status-badge status-draft">
                            {{ formatStage(application.stage) }}
                          </span>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                          <div>
                            <p class="text-sm font-medium text-neutral-700">Applicant</p>
                            <p class="text-sm text-neutral-900">{{ application.applicant?.firstName }} {{ application.applicant?.lastName }}</p>
                          </div>

                          <div>
                            <p class="text-sm font-medium text-neutral-700">Submitted</p>
                            <p class="text-sm text-neutral-900">{{ formatDate(application.submittedAt || application.createdAt) }}</p>
                          </div>

                          <div>
                            <p class="text-sm font-medium text-neutral-700">Last Updated</p>
                            <p class="text-sm text-neutral-900">{{ formatDate(application.updatedAt) }}</p>
                          </div>
                        </div>

                        @if (application.description) {
                          <p class="text-sm text-neutral-600 mb-4">{{ application.description }}</p>
                        }

                        @if (application.reviewNotes.length > 0) {
                          <div class="bg-neutral-50 rounded-lg p-3 mb-4">
                            <p class="text-xs font-medium text-neutral-700 mb-1">Latest Review Note</p>
                            <p class="text-xs text-neutral-600">{{ application.reviewNotes[application.reviewNotes.length - 1].note }}</p>
                          </div>
                        }
                      </div>

                      <!-- Actions -->
                      <div class="flex flex-col space-y-2 ml-6">
                        <ui-button variant="primary" (clicked)="viewApplication(application.id)">
                          <lucide-icon [img]="EyeIcon" [size]="16" class="mr-1" />
                          View Details
                        </ui-button>

                        <!-- <ui-button variant="outline" (clicked)="openAIAssistant(application)">
                          <lucide-icon [img]="BotIcon" [size]="16" class="mr-1" />
                          AI Analysis
                        </ui-button>

                        @if (application.status === 'submitted' || application.status === 'under_review') {
                          <div class="flex space-x-1">
                            <ui-button variant="outline" size="sm" (clicked)="updateApplicationStatus(application.id, 'approved')">
                              <lucide-icon [img]="CheckCircleIcon" [size]="14" />
                            </ui-button>
                            <ui-button variant="outline" size="sm" (clicked)="updateApplicationStatus(application.id, 'rejected')">
                              <lucide-icon [img]="XCircleIcon" [size]="14" />
                            </ui-button>
                            <ui-button variant="outline" size="sm" (clicked)="requestMoreInfo(application)">
                              <lucide-icon [img]="MessageSquareIcon" [size]="14" />
                            </ui-button>
                          </div>
                        } -->
                      </div>
                    </div>
                  </div>
                </div>
              }
            } @else {
              <!-- Empty state using design system -->
              <div class="empty-state">
                <div class="empty-icon">
                  <lucide-icon [img]="FileTextIcon" [size]="32" class="text-neutral-400" />
                </div>
                <h3 class="empty-title">No applications found</h3>
                <p class="empty-description">{{ getEmptyStateMessage() }}</p>
              </div>
            }
          </div>
        }
      }

      <!-- AI Assistant Modal -->
      @if (showAIModal()) {
        <app-ai-assistant-modal
          [application]="selectedApplicationForAI()"
          [isOpen]="showAIModal()"
          (closeRequested)="closeAIModal()"
        />
      }
    </main>
  </div>
</div>