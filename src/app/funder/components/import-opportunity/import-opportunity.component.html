  <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden">
        <!-- Header -->
        <div class="flex items-center justify-between p-6 border-b border-gray-200">
          <div>
            <h2 class="text-xl font-semibold text-gray-900">Import Funding Opportunities</h2>
            <p class="text-sm text-gray-600 mt-1">Upload CSV or Excel files to bulk create opportunities</p>
          </div>
          <button 
            (click)="closeModal()"
            class="p-2 hover:bg-gray-100 rounded-lg transition-colors"
          >
            <lucide-angular [img]="XIcon" [size]="20" class="text-gray-500"></lucide-angular>
          </button>
        </div>

        <!-- Progress Steps -->
        <div class="px-6 py-4 bg-gray-50 border-b border-gray-200">
          <div class="flex items-center space-x-4">
            @for (step of steps; track step.id; let i = $index) {
              <div class="flex items-center" [class.opacity-50]="!isStepActive(step.id) && !isStepCompleted(step.id)">
                <div 
                  class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium"
                  [class.bg-blue-500]="isStepActive(step.id)"
                  [class.text-white]="isStepActive(step.id)"
                  [class.bg-green-500]="isStepCompleted(step.id)"
                  [class.text-white]="isStepCompleted(step.id)"
                  [class.bg-gray-200]="!isStepActive(step.id) && !isStepCompleted(step.id)"
                  [class.text-gray-600]="!isStepActive(step.id) && !isStepCompleted(step.id)"
                >
                  @if (isStepCompleted(step.id)) {
                    <lucide-angular [img]="CheckIcon" [size]="16"></lucide-angular>
                  } @else {
                    {{ i + 1 }}
                  }
                </div>
                <span class="ml-2 text-sm font-medium" [class.text-blue-600]="isStepActive(step.id)">
                  {{ step.title }}
                </span>
                @if (i < steps.length - 1) {
                  <lucide-angular [img]="ArrowRightIcon" [size]="16" class="ml-4 text-gray-400"></lucide-angular>
                }
              </div>
            }
          </div>
        </div>

        <!-- Content -->
        <div class="flex-1 overflow-y-auto" style="max-height: calc(90vh - 200px);">
          
          <!-- Step 1: File Upload -->
          @if (currentStep() === 'upload') {
            <div class="p-6">
              <!-- Sample Template Download -->
              <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                <div class="flex items-start space-x-3">
                  <lucide-angular [img]="DownloadIcon" [size]="20" class="text-blue-600 mt-0.5"></lucide-angular>
                  <div>
                    <h4 class="text-sm font-medium text-blue-900">Download Template</h4>
                    <p class="text-sm text-blue-700 mt-1">
                      Get started with our pre-formatted template to ensure proper data structure.
                    </p>
                    <div class="flex space-x-2 mt-2">
                      <button 
                        (click)="downloadTemplate('csv')"
                        class="inline-flex items-center px-3 py-1.5 bg-blue-600 text-white text-xs font-medium rounded hover:bg-blue-700 transition-colors"
                      >
                        <lucide-angular [img]="FileTextIcon" [size]="14" class="mr-1"></lucide-angular>
                        CSV Template
                      </button>
                      <button 
                        (click)="downloadTemplate('xlsx')"
                        class="inline-flex items-center px-3 py-1.5 bg-green-600 text-white text-xs font-medium rounded hover:bg-green-700 transition-colors"
                      >
                        <lucide-angular [img]="FileTextIcon" [size]="14" class="mr-1"></lucide-angular>
                        Excel Template
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- File Upload Area -->
              <div 
                class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-gray-400 transition-colors"
                [class.border-blue-500]="isDragging()"
                [class.bg-blue-50]="isDragging()"
                (dragover)="onDragOver($event)"
                (dragleave)="onDragLeave($event)"
                (drop)="onDrop($event)"
              >
                @if (!uploadedFile()) {
                  <lucide-angular [img]="UploadIcon" [size]="48" class="mx-auto text-gray-400 mb-4"></lucide-angular>
                  <h3 class="text-lg font-medium text-gray-900 mb-2">Upload your file</h3>
                  <p class="text-gray-600 mb-4">Drag and drop your CSV or Excel file here, or click to browse</p>
                  <input 
                    type="file" 
                    #fileInput 
                    (change)="onFileSelected($event)"
                    accept=".csv,.xlsx,.xls"
                    class="hidden"
                  >
                  <button 
                    (click)="fileInput.click()"
                    class="inline-flex items-center px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 transition-colors"
                  >
                    <lucide-angular [img]="UploadIcon" [size]="16" class="mr-2"></lucide-angular>
                    Choose File
                  </button>
                  <p class="text-xs text-gray-500 mt-2">Supports CSV, XLS, XLSX files up to 10MB</p>
                } @else {
                  <div class="flex items-center justify-center space-x-4">
                    <div class="flex items-center space-x-2">
                      <lucide-angular [img]="FileTextIcon" [size]="20" class="text-green-600"></lucide-angular>
                      <span class="font-medium text-gray-900">{{ uploadedFile()!.name }}</span>
                      <span class="text-sm text-gray-500">({{ formatFileSize(uploadedFile()!.size) }})</span>
                    </div>
                    <button 
                      (click)="removeFile()"
                      class="p-1 hover:bg-gray-100 rounded"
                    >
                      <lucide-angular [img]="XIcon" [size]="16" class="text-gray-500"></lucide-angular>
                    </button>
                  </div>
                  @if (parseProgress() < 100) {
                    <div class="mt-4">
                      <div class="bg-gray-200 rounded-full h-2">
                        <div 
                          class="bg-blue-600 h-2 rounded-full transition-all duration-300"
                          [style.width.%]="parseProgress()"
                        ></div>
                      </div>
                      <p class="text-sm text-gray-600 mt-2">Parsing file... {{ parseProgress() }}%</p>
                    </div>
                  }
                }
              </div>

              @if (parseError()) {
                <div class="mt-4 p-4 bg-red-50 border border-red-200 rounded-lg">
                  <div class="flex">
                    <lucide-angular [img]="AlertCircleIcon" [size]="20" class="text-red-500 mr-3 mt-0.5"></lucide-angular>
                    <div>
                      <h4 class="text-sm font-medium text-red-800">Parse Error</h4>
                      <p class="text-sm text-red-700 mt-1">{{ parseError() }}</p>
                    </div>
                  </div>
                </div>
              }
            </div>
          }

          <!-- Step 2: Field Mapping -->
          @if (currentStep() === 'mapping') {
            <div class="p-6">
              <div class="mb-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-2">Map Your Fields</h3>
                <p class="text-gray-600">Match your file columns to the opportunity fields</p>
              </div>

              <div class="space-y-4">
                @for (mapping of fieldMappings(); track mapping.targetField) {
                  <div class="grid grid-cols-1 md:grid-cols-3 gap-4 p-4 border border-gray-200 rounded-lg">
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1">
                        {{ getFieldDisplayName(mapping.targetField) }}
                        @if (mapping.required) {
                          <span class="text-red-500">*</span>
                        }
                      </label>
                      <p class="text-xs text-gray-500">{{ getFieldDescription(mapping.targetField) }}</p>
                    </div>
                    
                    <div>
                      <select 
                        [(ngModel)]="mapping.sourceField"
                        class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                      >
                        <option value="">-- Select Column --</option>
                        @for (col of detectedColumns(); track col) {
                          <option [value]="col">{{ col }}</option>
                        }
                      </select>
                    </div>
                    
                    <div>
                      @if (mapping.sourceField && sampleData().length > 0) {
                        <div class="text-xs">
                          <span class="text-gray-500">Sample:</span>
                          <span class="font-mono bg-gray-100 px-2 py-1 rounded ml-1">
                            {{ getSampleValue(mapping.sourceField) }}
                          </span>
                        </div>
                      }
                    </div>
                  </div>
                }
              </div>

              <div class="mt-6 p-4 bg-gray-50 rounded-lg">
                <h4 class="text-sm font-medium text-gray-900 mb-2">Auto-detected mappings</h4>
                <button 
                  (click)="autoMapFields()"
                  class="inline-flex items-center px-3 py-1.5 bg-blue-600 text-white text-sm font-medium rounded hover:bg-blue-700 transition-colors"
                >
                  <lucide-angular [img]="MapPinIcon" [size]="14" class="mr-1"></lucide-angular>
                  Auto-map fields
                </button>
                <p class="text-xs text-gray-600 mt-1">Automatically match columns based on common naming patterns</p>
              </div>
            </div>
          }

          <!-- Step 3: Preview & Validate -->
          @if (currentStep() === 'preview') {
            <div class="p-6">
              <div class="mb-6 flex items-center justify-between">
                <div>
                  <h3 class="text-lg font-semibold text-gray-900">Preview & Validate</h3>
                  <p class="text-gray-600">Review the data before importing</p>
                </div>
                <button 
                  (click)="validateData()"
                  class="inline-flex items-center px-3 py-1.5 bg-blue-600 text-white text-sm font-medium rounded hover:bg-blue-700 transition-colors"
                >
                  <lucide-angular [img]="CheckIcon" [size]="14" class="mr-1"></lucide-angular>
                  Validate Data
                </button>
              </div>

              <!-- Validation Summary -->
              @if (validationErrors().length > 0) {
                <div class="mb-6 p-4 border border-yellow-200 bg-yellow-50 rounded-lg">
                  <div class="flex items-start space-x-3">
                    <lucide-angular [img]="AlertCircleIcon" [size]="20" class="text-yellow-600 mt-0.5"></lucide-angular>
                    <div>
                      <h4 class="text-sm font-medium text-yellow-800">Validation Issues Found</h4>
                      <p class="text-sm text-yellow-700 mt-1">
                        {{ getErrorSummary() }}
                      </p>
                    </div>
                  </div>
                </div>
              }

              <!-- Data Preview Table -->
              <div class="border border-gray-200 rounded-lg overflow-hidden">
                <div class="bg-gray-50 px-4 py-2 border-b border-gray-200">
                  <h4 class="text-sm font-medium text-gray-900">
                    Data Preview ({{ transformedData().length }} rows)
                  </h4>
                </div>
                <div class="overflow-x-auto">
                  <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                      <tr>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Row</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Title</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Funding Type</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Offer Amount</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                      </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                      @for (row of getPreviewRows(); track $index; let i = $index) {
                        <tr [class.bg-red-50]="hasRowErrors(i)">
                          <td class="px-4 py-2 text-sm text-gray-900">{{ i + 1 }}</td>
                          <td class="px-4 py-2 text-sm text-gray-900">{{ row.title || '-' }}</td>
                          <td class="px-4 py-2 text-sm text-gray-900">{{ row.fundingType || '-' }}</td>
                          <td class="px-4 py-2 text-sm text-gray-900">{{ formatCurrency(row.offerAmount) }}</td>
                          <td class="px-4 py-2 text-sm">
                            @if (hasRowErrors(i)) {
                              <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                <lucide-angular [img]="AlertCircleIcon" [size]="12" class="mr-1"></lucide-angular>
                                Errors
                              </span>
                            } @else {
                              <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                <lucide-angular [img]="CheckIcon" [size]="12" class="mr-1"></lucide-angular>
                                Valid
                              </span>
                            }
                          </td>
                        </tr>
                      }
                    </tbody>
                  </table>
                </div>
              </div>

              <!-- Error Details -->
              @if (validationErrors().length > 0) {
                <div class="mt-6">
                  <h4 class="text-sm font-medium text-gray-900 mb-2">Validation Errors</h4>
                  <div class="space-y-2 max-h-64 overflow-y-auto">
                    @for (error of validationErrors(); track $index) {
                      <div class="flex items-start space-x-2 p-2 bg-red-50 border border-red-200 rounded text-sm">
                        <lucide-angular [img]="AlertCircleIcon" [size]="14" class="text-red-500 mt-0.5"></lucide-angular>
                        <div>
                          <span class="font-medium">Row {{ error.row + 1 }}, {{ error.field }}:</span>
                          <span class="text-red-700">{{ error.message }}</span>
                          @if (error.value !== undefined) {
                            <span class="text-gray-600">(Value: "{{ error.value }}")</span>
                          }
                        </div>
                      </div>
                    }
                  </div>
                </div>
              }
            </div>
          }

          <!-- Step 4: Import Results -->
          @if (currentStep() === 'results') {
            <div class="p-6">
              @if (importResult()) {
                <div class="text-center">
                  @if (importResult()!.success) {
                    <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4">
                      <lucide-angular [img]="CheckIcon" [size]="24" class="text-green-600"></lucide-angular>
                    </div>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">Import Successful!</h3>
                    <p class="text-gray-600 mb-4">
                      Successfully imported {{ importResult()!.imported }} funding opportunities.
                    </p>
                  } @else {
                    <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                      <lucide-angular [img]="AlertCircleIcon" [size]="24" class="text-red-600"></lucide-angular>
                    </div>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">Import Failed</h3>
                    <p class="text-gray-600 mb-4">
                      There were errors during the import process.
                    </p>
                  }

                  @if (importResult()!.errors.length > 0) {
                    <div class="text-left mt-6">
                      <h4 class="text-sm font-medium text-gray-900 mb-2">Import Errors</h4>
                      <div class="space-y-1 max-h-32 overflow-y-auto">
                        @for (error of importResult()!.errors; track $index) {
                          <div class="text-sm text-red-600">
                            Row {{ error.row + 1 }}: {{ error.message }}
                          </div>
                        }
                      </div>
                    </div>
                  }
                </div>
              }
            </div>
          }
        </div>

        <!-- Footer Actions -->
        <div class="flex items-center justify-between p-6 border-t border-gray-200 bg-gray-50">
          <button 
            (click)="previousStep()"
            [disabled]="currentStep() === 'upload' || isProcessing()"
            class="inline-flex items-center px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            <lucide-angular [img]="ArrowLeftIcon" [size]="16" class="mr-2"></lucide-angular>
            Previous
          </button>

          <div class="flex space-x-3">
            <button 
              (click)="closeModal()"
              class="inline-flex items-center px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50"
            >
              Cancel
            </button>
            
            @if (currentStep() === 'upload') {
              <button 
                (click)="nextStep()"
                [disabled]="!uploadedFile() || parseProgress() < 100"
                class="inline-flex items-center px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-md hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed"
              >
                Next: Map Fields
                <lucide-angular [img]="ArrowRightIcon" [size]="16" class="ml-2"></lucide-angular>
              </button>
            } @else if (currentStep() === 'mapping') {
              <button 
                (click)="nextStep()"
                [disabled]="!canProceedFromMapping()"
                class="inline-flex items-center px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-md hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed"
              >
                Next: Preview
                <lucide-angular [img]="ArrowRightIcon" [size]="16" class="ml-2"></lucide-angular>
              </button>
            } @else if (currentStep() === 'preview') {
              <button 
                (click)="importData()"
                [disabled]="!canImport() || isProcessing()"
                class="inline-flex items-center px-4 py-2 text-sm font-medium text-white bg-green-600 border border-transparent rounded-md hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed"
              >
                @if (isProcessing()) {
                  <div class="animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent mr-2"></div>
                  Importing...
                } @else {
                  <lucide-angular [img]="UploadIcon" [size]="16" class="mr-2"></lucide-angular>
                  Import {{ getValidRowCount() }} Opportunities
                }
              </button>
            } @else if (currentStep() === 'results') {
              <button 
                (click)="closeModal()"
                class="inline-flex items-center px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-md hover:bg-blue-700"
              >
                Done
              </button>
            }
          </div>
        </div>
      </div>
    </div>