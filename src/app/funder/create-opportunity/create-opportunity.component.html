<app-opportunity-action-modal></app-opportunity-action-modal>

<!-- SECTOR VALIDATION MODAL -->
@if (showSectorModal()) {
<app-sector-validation-modal
  (confirmed)="onSectorValidationComplete()"
></app-sector-validation-modal>
}

<!-- LOADING STATE -->
@if (organizationLoading() && !canProceed()) {
<div class="min-h-screen bg-slate-50 flex items-center justify-center">
  <div class="text-center">
    <div
      class="animate-spin w-12 h-12 border-4 border-teal-200 border-t-teal-600 rounded-full mx-auto mb-4"
    ></div>
    <h2 class="text-xl font-semibold text-slate-900 mb-2">
      Loading Organization Data
    </h2>
    <p class="text-slate-600">
      Setting up your opportunity creation workspace...
    </p>
  </div>
</div>
}

<!-- ORGANIZATION ERROR STATE -->
@else if (organizationError() && !organizationId()) {
<div
  class="min-h-screen bg-slate-50 flex items-center justify-center px-4 lg:px-8"
>
  <div class="max-w-md w-full text-center">
    <div
      class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4"
    >
      <lucide-angular
        [img]="AlertCircleIcon"
        [size]="24"
        class="text-red-600"
      ></lucide-angular>
    </div>
    <h2 class="text-xl font-semibold text-slate-900 mb-2">
      Organization Setup Required
    </h2>
    <p class="text-slate-600 mb-6">{{ organizationError() }}</p>
    <div class="space-y-3">
      <button
        (click)="goToOrganizationSetup()"
        class="w-full bg-teal-500 text-white px-6 py-2.5 rounded-xl font-medium hover:bg-teal-600 active:bg-teal-700 transition-colors duration-200"
      >
        Complete Organization Setup
      </button>
      <button
        (click)="retryLoadOrganization()"
        class="w-full bg-slate-100 text-slate-700 px-6 py-2.5 rounded-xl font-medium hover:bg-slate-200 active:bg-slate-300 transition-colors duration-200 flex items-center justify-center"
      >
        <lucide-angular
          [img]="RefreshCwIcon"
          [size]="16"
          class="mr-2"
        ></lucide-angular>
        Retry Loading
      </button>
    </div>
  </div>
</div>
}

<!-- MAIN PAGE -->
@else if (!showSectorModal()) {
<div class="min-h-screen bg-slate-50 flex flex-col">
  <!-- TOAST NOTIFICATIONS (Top-right, fixed) -->
  <div class="fixed top-4 right-4 z-50 space-y-2 pointer-events-none">
    @if (showDatabaseSaveStatus()) {
    <div
      class="flex items-center gap-2 px-4 py-3 bg-white rounded-xl border border-slate-200 shadow-sm pointer-events-auto animate-fade-in"
    >
      <lucide-angular
        [img]="CheckIcon"
        [size]="16"
        class="text-green-600 flex-shrink-0"
      ></lucide-angular>
      <span class="text-sm font-medium text-slate-900">{{
        getLastSavedText()
      }}</span>
    </div>
    } @if (showLocalSaveStatus()) {
    <div
      class="flex items-center gap-2 px-4 py-3 bg-white rounded-xl border border-slate-200 shadow-sm pointer-events-auto animate-fade-in"
    >
      <lucide-angular
        [img]="ClockIcon"
        [size]="16"
        class="text-blue-600 flex-shrink-0"
      ></lucide-angular>
      <span class="text-sm font-medium text-slate-900">{{
        getLocalSaveText()
      }}</span>
    </div>
    } @if (showUnsavedIndicator()) {
    <div
      class="flex items-center gap-2 px-4 py-3 bg-white rounded-xl border border-amber-200/50 shadow-sm pointer-events-auto animate-fade-in"
    >
      <lucide-angular
        [img]="AlertCircleIcon"
        [size]="16"
        class="text-amber-600 flex-shrink-0"
      ></lucide-angular>
      <span class="text-sm font-medium text-slate-900">Unsaved changes</span>
    </div>
    }
  </div>

  <!-- PAGE HEADER -->
  <div class="border-b border-slate-200 bg-white sticky top-0 z-40">
    <div class="px-4 lg:px-8 py-4">
      <!-- Single-line header with navigation, title, badge, and actions -->
      <div
        class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4"
      >
        <!-- LEFT: Back button + Title + Badge -->
        <div class="flex items-center gap-3 min-w-0">
          <button
            class="flex-shrink-0 text-slate-600 hover:text-slate-900 transition-colors duration-200 group"
            (click)="goBack()"
            title="Go back"
          >
            <lucide-angular
              [img]="ArrowLeftIcon"
              [size]="20"
              class="group-hover:-translate-x-0.5 transition-transform"
            ></lucide-angular>
          </button>

          <div class="min-w-0 flex-1">
            <div class="flex items-center gap-2 flex-wrap">
              <h1 class="text-xl lg:text-2xl font-bold text-slate-900 truncate">
                {{ getPageTitle() }}
              </h1>
              @if (isEditMode()) {
              <span
                class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold bg-blue-50 text-blue-700 border border-blue-200/50 flex-shrink-0"
              >
                Editing
              </span>
              } @else {
              <span
                class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold bg-green-50 text-green-700 border border-green-200/50 flex-shrink-0"
              >
                Draft
              </span>
              }
            </div>
            <p class="text-xs lg:text-sm text-slate-600 mt-1 truncate">
              {{ getPageSubtitle() }}
            </p>
          </div>
        </div>

        <!-- RIGHT: Preview + Help (hide on mobile) -->
        <div class="flex items-center gap-2 flex-shrink-0">
          <button
            class="hidden sm:inline-flex items-center px-4 py-2 text-sm font-medium text-slate-600 hover:bg-slate-100 active:bg-slate-200 rounded-xl transition-colors duration-200"
            title="Preview opportunity"
          >
            <lucide-angular
              [img]="EyeIcon"
              [size]="16"
              class="mr-1.5"
            ></lucide-angular>
            Preview
          </button>
          <button
            class="hidden sm:inline-flex items-center px-4 py-2 text-sm font-medium text-slate-600 hover:bg-slate-100 active:bg-slate-200 rounded-xl transition-colors duration-200"
            title="Get help"
          >
            <lucide-angular
              [img]="HelpCircleIcon"
              [size]="16"
              class="mr-1.5"
            ></lucide-angular>
            Help
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ERROR MESSAGES -->
  @if (organizationError() || publishError()) {
  <div class="px-4 lg:px-8 py-4 space-y-3">
    @if (organizationError()) {
    <div class="bg-red-50 border border-red-200/50 rounded-xl p-4 flex gap-3">
      <lucide-angular
        [img]="AlertCircleIcon"
        [size]="20"
        class="text-red-600 flex-shrink-0 mt-0.5"
      ></lucide-angular>
      <div class="flex-1 min-w-0">
        <h3 class="text-sm font-semibold text-red-900">
          Organization Setup Required
        </h3>
        <p class="text-sm text-red-700 mt-1">{{ organizationError() }}</p>
        <div class="flex gap-2 mt-3">
          <button
            (click)="goToOrganizationSetup()"
            class="px-3 py-1.5 bg-red-100 text-red-700 text-xs font-medium rounded-lg hover:bg-red-200 transition-colors duration-200"
          >
            Complete Setup
          </button>
          <button
            (click)="clearErrors()"
            class="px-3 py-1.5 bg-white text-red-700 text-xs font-medium rounded-lg hover:bg-red-50 transition-colors duration-200 border border-red-200/50"
          >
            Dismiss
          </button>
        </div>
      </div>
    </div>
    } @if (publishError()) {
    <div class="bg-red-50 border border-red-200/50 rounded-xl p-4 flex gap-3">
      <lucide-angular
        [img]="AlertCircleIcon"
        [size]="20"
        class="text-red-600 flex-shrink-0 mt-0.5"
      ></lucide-angular>
      <div class="flex-1 min-w-0">
        <h3 class="text-sm font-semibold text-red-900">Publishing Failed</h3>
        <p class="text-sm text-red-700 mt-1">{{ publishError() }}</p>
        <button
          (click)="clearErrors()"
          class="mt-3 px-3 py-1.5 bg-red-100 text-red-700 text-xs font-medium rounded-lg hover:bg-red-200 transition-colors duration-200"
        >
          Dismiss
        </button>
      </div>
    </div>
    }
  </div>
  }

  <!-- MAIN CONTENT - Flex 1 to push actions down -->
  <div class="flex-1 px-4 lg:px-8 py-6 overflow-y-auto">
    <div class="mx-auto">
      <!-- RESPONSIVE GRID LAYOUT -->
      <div class="create-opportunity-grid">
        <!-- LEFT SIDEBAR -->
        <div class="sticky-sidebar">
          <app-opportunity-steps-navigation></app-opportunity-steps-navigation>
        </div>

        <!-- CENTER: FORM CARD -->
        <div class="min-w-0">
          <div
            class="bg-white rounded-2xl border border-slate-200 overflow-hidden"
          >
            <!-- FORM HEADER -->
            <div
              class="px-6 py-4 border-b border-slate-200 bg-slate-50/50 flex items-center gap-4"
            >
              <div
                class="w-10 h-10 rounded-lg bg-teal-100 flex items-center justify-center flex-shrink-0"
              >
                <lucide-angular
                  [img]="getCurrentStepIcon()"
                  [size]="20"
                  class="text-teal-600"
                ></lucide-angular>
              </div>
              <div class="min-w-0">
                <h2 class="text-base font-semibold text-slate-900">
                  {{ getCurrentStepTitle() }}
                </h2>
                <p class="text-xs text-slate-600 mt-0.5">
                  {{ getCurrentStepSubtitle() }}
                </p>
              </div>
            </div>

            <!-- STEP VALIDATION ERRORS -->
            @if (hasCurrentStepErrors()) {
            <div
              class="px-6 py-4 bg-red-50 border-b border-red-200/50 flex gap-3"
            >
              <lucide-angular
                [img]="AlertCircleIcon"
                [size]="20"
                class="text-red-600 flex-shrink-0 mt-0.5"
              ></lucide-angular>
              <div class="flex-1 min-w-0">
                <h4 class="text-sm font-semibold text-red-900">
                  Please fix the following:
                </h4>
                <ul class="mt-2 text-sm text-red-700 space-y-1">
                  @for (error of currentStepErrors(); track error.field) {
                  <li class="flex items-center gap-2">
                    <span
                      class="w-1.5 h-1.5 bg-red-400 rounded-full flex-shrink-0"
                    ></span>
                    {{ error.message }}
                  </li>
                  }
                </ul>
              </div>
            </div>
            }

            <!-- FORM CONTENT -->
            <div class="px-6 py-6 space-y-8" [@stepTransition]>
              @if (currentStep() === 'basic') {
              <div class="space-y-6">
                <app-opportunity-basics></app-opportunity-basics>
              </div>
              } @if (currentStep() === 'terms') {
              <app-funding-structure></app-funding-structure>
              } @if (currentStep() === 'eligibility') {
              <app-eligibility-filters></app-eligibility-filters>
              } @if (currentStep() === 'settings') {
              <app-application-settings></app-application-settings>

              } @if (currentStep() === 'review') {
              <div class="space-y-6">
                @if (validationErrors().length > 0) {
                <div
                  class="bg-amber-50 border border-amber-200/50 rounded-xl p-4 flex gap-3"
                >
                  <lucide-angular
                    [img]="AlertCircleIcon"
                    [size]="20"
                    class="text-amber-600 flex-shrink-0 mt-0.5"
                  ></lucide-angular>
                  <div class="flex-1 min-w-0">
                    <h4 class="text-sm font-semibold text-amber-900">
                      Review Required
                    </h4>
                    <ul class="mt-2 text-sm text-amber-700 space-y-1">
                      @for (error of validationErrors(); track error.field) {
                      <li class="flex items-center gap-2">
                        <span
                          class="w-1.5 h-1.5 bg-amber-400 rounded-full flex-shrink-0"
                        ></span>
                        {{ error.message }}
                      </li>
                      }
                    </ul>
                  </div>
                </div>
                }

                <!-- SUMMARY SECTION -->
                <div
                  class="bg-slate-50 rounded-xl p-6 border border-slate-200/50"
                >
                  <h4 class="font-semibold text-slate-900 mb-4">
                    Opportunity Summary
                  </h4>
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                    <div>
                      <span class="text-slate-600">Title</span>
                      <div class="font-medium text-slate-900 mt-1">
                        {{ formData().title || "Not specified" }}
                      </div>
                    </div>
                    <div>
                      <span class="text-slate-600">Funding Type</span>
                      <div class="font-medium text-slate-900 mt-1 capitalize">
                        {{ formData().fundingType || "Not specified" }}
                      </div>
                    </div>
                    <div>
                      <span class="text-slate-600">Typical Investment</span>
                      <div class="font-medium text-slate-900 mt-1">
                        {{ formData().currency }}
                        {{ getFormattedAmount("typicalInvestment") }}
                      </div>
                    </div>
                    <div>
                      <span class="text-slate-600">Offer Amount</span>
                      <div class="font-medium text-slate-900 mt-1">
                        {{ formData().currency }}
                        {{ getFormattedAmount("offerAmount") }}
                      </div>
                    </div>
                  </div>
                </div>

                <!-- READY STATE -->
                <div
                  class="bg-green-50 border border-green-200/50 rounded-xl p-4 flex gap-3"
                >
                  <lucide-angular
                    [img]="CheckIcon"
                    [size]="20"
                    class="text-green-600 flex-shrink-0 mt-0.5"
                  ></lucide-angular>
                  <div class="flex-1 min-w-0">
                    <h4 class="text-sm font-semibold text-green-900">
                      Ready to Publish
                    </h4>
                    <p class="text-sm text-green-700 mt-1">
                      Once published, qualified SMEs can view and apply. You can
                      edit or pause anytime.
                    </p>
                  </div>
                </div>
              </div>
              }
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- FORM ACTIONS (standalone component) -->
  <app-opportunity-form-actions
    [currentStep]="currentStep()"
    [isFirstStep]="isFirstStep.bind(this)"
    [isReviewStep]="isReviewStep.bind(this)"
    [isSaving]="isSaving()"
    [isPublishing]="isPublishing()"
    [canContinue]="canContinue()"
    [canPublish]="canPublish()"
    [isEditMode]="isEditMode()"
    [isCreateMode]="isCreateMode()"
    [organizationError]="!!organizationError()"
    [saveButtonText]="getSaveButtonText()"
    (next)="nextStep()"
    (previous)="previousStep()"
    (publish)="publishOpportunity()"
    (save)="saveDraft()"
    (cancel)="goBack()"
    (clear)="clearDraft()"
  ></app-opportunity-form-actions>
</div>
}
