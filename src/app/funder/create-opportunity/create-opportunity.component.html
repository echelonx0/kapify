<!-- Updated create-opportunity.component.html - Using Functional Components -->

@if (organizationLoading()) {
  <div class="min-h-screen bg-neutral-50 flex items-center justify-center">
    <div class="text-center">
      <div class="animate-spin w-12 h-12 border-4 border-primary-200 border-t-primary-600 rounded-full mx-auto mb-4"></div>
      <h2 class="text-xl font-semibold text-neutral-900 mb-2">Loading Organization Data</h2>
      <p class="text-neutral-600">Please wait while we set up your opportunity creation...</p>
    </div>
  </div>
}

<!-- ORGANIZATION ERROR STATE -->
@else if (organizationError() && !organizationId()) {
  <div class="min-h-screen bg-neutral-50 flex items-center justify-center px-4">
    <div class="max-w-md w-full text-center">
      <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
        <lucide-icon [img]="AlertCircleIcon" [size]="24" class="text-red-600" />
      </div>
      
      <h2 class="text-xl font-semibold text-neutral-900 mb-2">Organization Setup Required</h2>
      <p class="text-neutral-600 mb-6">{{ organizationError() }}</p>
      
      <div class="space-y-3">
        <button 
          (click)="goToOrganizationSetup()"
          class="w-full bg-primary-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-primary-700 transition-colors"
        >
          Complete Organization Setup
        </button>
        
        <button 
          (click)="retryLoadOrganization()"
          class="w-full border border-neutral-300 text-neutral-700 px-6 py-3 rounded-lg font-medium hover:bg-neutral-50 transition-colors"
        >
          <lucide-icon [img]="RefreshCwIcon" [size]="16" class="mr-2" />
          Retry Loading
        </button>
      </div>
    </div>
  </div>
}

@else if (canProceed()) {

<div class="mx-auto p-6">
  <!-- Header -->
  <div class="mb-8">
    <div class="flex items-center justify-between mb-6">
      <div class="flex items-center space-x-3">
        <button 
          class="flex items-center text-gray-600 hover:text-gray-900 transition-colors group"
          (click)="goBack()"
        >
          <lucide-angular [img]="ArrowLeftIcon" [size]="16" class="mr-2 group-hover:-translate-x-1 transition-transform"></lucide-angular>
          @if (isEditMode()) {
            Back 
          } @else {
            Go back
          }
        </button>
      </div>
      <div class="flex items-center space-x-3">
        <!-- Save Status Indicators -->
        @if (showDatabaseSaveStatus()) {
          <div class="flex items-center text-sm text-green-600">
            <lucide-angular [img]="CheckIcon" [size]="14" class="mr-1"></lucide-angular>
            {{ getLastSavedText() }}
          </div>
        }
        
        @if (showLocalSaveStatus()) {
          <div class="flex items-center text-sm text-blue-600">
            <lucide-angular [img]="ClockIcon" [size]="14" class="mr-1"></lucide-angular>
            {{ getLocalSaveText() }}
          </div>
        }
        
        @if (showUnsavedIndicator()) {
          <div class="flex items-center text-sm text-orange-600">
            <lucide-angular [img]="AlertCircleIcon" [size]="14" class="mr-1"></lucide-angular>
            Unsaved changes
          </div>
        }

        <button class="px-4 py-2 text-sm text-gray-600 hover:text-gray-900 transition-colors">
          <lucide-angular [img]="EyeIcon" [size]="16" class="mr-2 inline"></lucide-angular>
          Preview
        </button>
        <button class="px-4 py-2 text-sm text-gray-600 hover:text-gray-900 transition-colors">
          <lucide-angular [img]="HelpCircleIcon" [size]="16" class="mr-2 inline"></lucide-angular>
          Help
        </button>
      </div>
    </div>
    
    <div>
      <div class="flex items-center gap-3 mb-2">
        <h1 class="text-3xl font-bold text-gray-900">{{ getPageTitle() }}</h1>
        @if (isEditMode()) {
          <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
            Editing
          </span>
        } @else {
          <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
            New Draft
          </span>
        }
      </div>
      <p class="text-gray-600">{{ getPageSubtitle() }}</p>
    </div>
  </div>

  <!-- ERROR MESSAGES SECTION -->
  <div class="space-y-4 mb-6">
    <!-- Organization Error -->
    @if (organizationError()) {
      <div class="bg-red-50 border border-red-200 rounded-lg p-4">
        <div class="flex">
          <div class="flex-shrink-0">
            <lucide-angular [img]="AlertCircleIcon" [size]="20" class="text-red-500"></lucide-angular>
          </div>
          <div class="ml-3">
            <h3 class="text-sm font-medium text-red-800">Organization Setup Required</h3>
            <div class="mt-2 text-sm text-red-700">
              <p>{{ organizationError() }}</p>
            </div>
            <div class="mt-4">
              <div class="flex space-x-3">
                <button 
                  type="button"
                  class="bg-red-100 px-3 py-2 rounded-md text-sm font-medium text-red-800 hover:bg-red-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500"
                  (click)="goToOrganizationSetup()"
                >
                  Complete Organization Setup
                </button>
                <button 
                  type="button"
                  class="bg-white px-3 py-2 rounded-md text-sm font-medium text-red-800 hover:bg-red-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500"
                  (click)="organizationError.set(null)"
                >
                  Dismiss
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    }

    <!-- Publish Error -->
    @if (publishError()) {
      <div class="bg-red-50 border border-red-200 rounded-lg p-4">
        <div class="flex">
          <div class="flex-shrink-0">
            <lucide-angular [img]="AlertCircleIcon" [size]="20" class="text-red-500"></lucide-angular>
          </div>
          <div class="ml-3">
            <h3 class="text-sm font-medium text-red-800">Publishing Failed</h3>
            <div class="mt-2 text-sm text-red-700">
              <p>{{ publishError() }}</p>
            </div>
            <div class="mt-4">
              <div class="flex space-x-3">
                <button 
                  type="button"
                  class="bg-red-100 px-3 py-2 rounded-md text-sm font-medium text-red-800 hover:bg-red-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500"
                  (click)="publishError.set(null)"
                >
                  Dismiss
                </button>
                @if (organizationError()) {
                  <button 
                    type="button"
                    class="bg-white px-3 py-2 rounded-md text-sm font-medium text-red-800 hover:bg-red-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500"
                    (click)="goToOrganizationSetup()"
                  >
                    Fix Organization Setup
                  </button>
                }
              </div>
            </div>
          </div>
        </div>
      </div>
    }
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
    <!-- Left Sidebar - Steps Navigation -->
    <div class="lg:col-span-1">
      <div class="bg-white rounded-xl border border-gray-200 shadow-sm p-6 sticky top-6">
        <h3 class="font-semibold text-gray-900 mb-4">Progress</h3>
        <div class="space-y-1">
          @for (step of steps; track step.id; let i = $index) {
            <div 
              class="flex items-center space-x-3 p-3 rounded-lg cursor-pointer transition-colors"
              [class]="getStepCardClasses(step.id)"
              (click)="goToStep(step.id)"
              [class.opacity-50]="organizationError() && step.id === 'review'"
              [class.cursor-not-allowed]="organizationError() && step.id === 'review'"
            >
              <div [class]="getStepIconClasses(step.id)">
                @if (isStepCompleted(step.id)) {
                  <lucide-angular [img]="CheckIcon" [size]="16" class="text-white"></lucide-angular>
                } @else if (organizationError() && step.id === 'review') {
                  <lucide-angular [img]="AlertCircleIcon" [size]="16" class="text-red-500"></lucide-angular>
                } @else {
                  <span class="text-xs font-semibold">{{ i + 1 }}</span>
                }
              </div>
              <div class="flex-1 min-w-0">
                <p [class]="getStepTitleClasses(step.id)">{{ step.title }}</p>
                <p [class]="getStepDescriptionClasses(step.id)">{{ step.description }}</p>
                @if (organizationError() && step.id === 'review') {
                  <p class="text-xs text-red-500 mt-1">Setup required</p>
                }
              </div>
            </div>
          }
        </div>

        <!-- Progress Bar -->
        <div class="mt-6">
          <div class="flex justify-between text-xs text-gray-600 mb-2">
            <span>Progress</span>
            <span>{{ getCurrentStepIndex() + 1 }} of {{ steps.length }}</span>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-2">
            <div 
              class="h-2 rounded-full transition-all duration-300"
              [class.bg-primary-500]="!organizationError()"
              [class.bg-red-400]="organizationError()"
              [style.width.%]="progressPercentage()"
            ></div>
          </div>
          @if (organizationError()) {
            <p class="text-xs text-red-600 mt-2">Organization setup required to complete</p>
          }
        </div>
      </div>
    </div>

    <!-- Main Content Area -->
    <div class="lg:col-span-3">
      <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
        <!-- Form Header -->
        <div class="p-6 border-b border-gray-200"
             [class.bg-gradient-to-r]="!organizationError()"
             [class.from-primary-50]="!organizationError()"
             [class.to-indigo-50]="!organizationError()"
             [class.bg-red-50]="organizationError()">
          <div class="flex items-center space-x-4">
            <div class="w-12 h-12 rounded-xl flex items-center justify-center"
                 [class.bg-primary-100]="!organizationError()"
                 [class.bg-red-100]="organizationError()">
              @if (organizationError() && currentStep() === 'review') {
                <lucide-angular [img]="AlertCircleIcon" [size]="24" class="text-red-600"></lucide-angular>
              } @else {
                <lucide-angular [img]="getCurrentStepIcon()" [size]="24" 
                               [class.text-primary-600]="!organizationError()"
                               [class.text-red-600]="organizationError()"></lucide-angular>
              }
            </div>
            <div>
              <h2 class="text-xl font-semibold text-gray-900">{{ getCurrentStepTitle() }}</h2>
              <p class="text-sm text-gray-600 mt-1">{{ getCurrentStepSubtitle() }}</p>
              @if (organizationError() && currentStep() === 'review') {
                <p class="text-sm text-red-600 mt-1">
                  <lucide-angular [img]="AlertCircleIcon" [size]="14" class="inline mr-1"></lucide-angular>
                  Cannot publish without organization setup
                </p>
              }
            </div>
          </div>
        </div>

        <!-- Current Step Validation Errors -->
        @if (hasCurrentStepErrors()) {
          <div class="p-4 bg-red-50 border-b border-red-200">
            <div class="flex">
              <lucide-angular [img]="AlertCircleIcon" [size]="20" class="text-red-500 mt-0.5 mr-3"></lucide-angular>
              <div>
                <h4 class="text-sm font-medium text-red-800">Please fix the following issues:</h4>
                <ul class="mt-2 text-sm text-red-700 space-y-1">
                  @for (error of currentStepErrors(); track error.field) {
                    <li class="flex items-center">
                      <span class="w-1.5 h-1.5 bg-red-400 rounded-full mr-2"></span>
                      {{ error.message }}
                    </li>
                  }
                </ul>
              </div>
            </div>
          </div>
        }

        <!-- Form Content - NOW USING FUNCTIONAL COMPONENTS -->
        <div class="p-6 space-y-8" [@stepTransition]>

          <!-- Step: Basic Info -->
          @if (currentStep() === 'basic') {
            <div class="space-y-6">
              <app-opportunity-basics></app-opportunity-basics>
              <app-media-branding></app-media-branding>
            </div>
          }

          <!-- Step: Investment Terms -->
          @if (currentStep() === 'terms') {
            <app-funding-structure></app-funding-structure>
          }

          <!-- Step: Eligibility Criteria -->
          @if (currentStep() === 'eligibility') {
            <app-eligibility-filters></app-eligibility-filters>
          }

          <!-- Step: Settings -->
          @if (currentStep() === 'settings') {
            <app-application-settings></app-application-settings>
          }

          <!-- Step: Review -->
          @if (currentStep() === 'review') {
            <div class="space-y-6">
              <!-- Validation Summary -->
              @if (validationErrors().length > 0) {
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                  <div class="flex">
                    <lucide-angular [img]="AlertCircleIcon" [size]="20" class="text-yellow-500 mr-3 mt-0.5"></lucide-angular>
                    <div>
                      <h4 class="text-sm font-medium text-yellow-800 mb-2">Review Required</h4>
                      <p class="text-sm text-yellow-700 mb-3">Please review the following items before publishing:</p>
                      <ul class="text-sm text-yellow-700 space-y-1">
                        @for (error of validationErrors(); track error.field) {
                          <li class="flex items-center">
                            <span class="w-1.5 h-1.5 bg-yellow-400 rounded-full mr-2"></span>
                            {{ error.message }}
                          </li>
                        }
                      </ul>
                    </div>
                  </div>
                </div>
              }

              <div class="bg-gray-50 rounded-xl p-6">
                <h4 class="font-medium text-gray-900 mb-4">Opportunity Summary</h4>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                  <div>
                    <span class="text-gray-500">Title:</span>
                    <div class="font-medium">{{ formData().title || 'Not specified' }}</div>
                  </div>
                  <div>
                    <span class="text-gray-500">Funding Type:</span>
                    <div class="font-medium capitalize">{{ formData().fundingType || 'Not specified' }}</div>
                  </div>
                  <div>
                    <span class="text-gray-500">Total Available:</span>
                    <div class="font-medium">{{ formData().currency }} {{ getFormattedAmount('totalAvailable') }}</div>
                  </div>
                  <div>
                    <span class="text-gray-500">Typical Investment:</span>
                    <div class="font-medium">{{ formData().currency }} {{ getFormattedAmount('offerAmount') }}</div>
                  </div>
                  <div>
                    <span class="text-gray-500">Decision Timeframe:</span>
                    <div class="font-medium">{{ formData().decisionTimeframe || 'Not specified' }} days</div>
                  </div>
                  <div>
                    <span class="text-gray-500">Visibility:</span>
                    <div class="font-medium">{{ formData().isPublic ? 'Public' : 'Private' }}</div>
                  </div>
                </div>

                @if (formData().description) {
                  <div class="mt-4">
                    <span class="text-gray-500 text-sm">Description:</span>
                    <div class="mt-1 text-sm">{{ formData().description }}</div>
                  </div>
                }

                @if (formData().targetIndustries.length > 0) {
                  <div class="mt-4">
                    <span class="text-gray-500 text-sm">Target Industries:</span>
                    <div class="mt-1 text-sm">{{ formData().targetIndustries.join(', ') }}</div>
                  </div>
                }

                @if (formData().businessStages.length > 0) {
                  <div class="mt-4">
                    <span class="text-gray-500 text-sm">Business Stages:</span>
                    <div class="mt-1 text-sm">{{ formData().businessStages.join(', ') }}</div>
                  </div>
                }

                @if (hasMediaContent()) {
                  <div class="mt-4">
                    <span class="text-gray-500 text-sm">Media & Branding:</span>
                    <div class="mt-1 space-y-1 text-sm">
                      @if (formData().fundingOpportunityImageUrl) {
                        <div>• Opportunity image attached</div>
                      }
                      @if (formData().fundingOpportunityVideoUrl) {
                        <div>• Opportunity video attached</div>
                      }
                      @if (formData().funderOrganizationName) {
                        <div>• Organization: {{ formData().funderOrganizationName }}</div>
                      }
                      @if (formData().funderOrganizationLogoUrl) {
                        <div>• Organization logo attached</div>
                      }
                    </div>
                  </div>
                }
              </div>

              <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                <div class="flex">
                  <lucide-angular [img]="CheckIcon" [size]="20" class="text-green-500 mr-3 mt-0.5"></lucide-angular>
                  <div>
                    <h4 class="text-sm font-medium text-green-800">Ready to Publish</h4>
                    <p class="mt-1 text-sm text-green-700">
                      Once published, qualified SMEs will be able to view and apply for this opportunity.
                      You can edit or pause the opportunity at any time.
                    </p>
                  </div>
                </div>
              </div>
            </div>
          }
        </div>

        <!-- Form Actions -->
        <div class="px-6 py-4 bg-gray-50 border-t border-gray-200 flex items-center justify-between">
          <div class="flex items-center space-x-3">
            <button 
              class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-all"
              [disabled]="currentStep() === 'basic'"
              (click)="previousStep()"
            >
              <lucide-angular [img]="ArrowLeftIcon" [size]="16" class="mr-2 inline"></lucide-angular>
              Previous
            </button>
            
            <button 
              class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-all"
              (click)="goBack()"
            >
              Cancel
            </button>

            @if (isCreateMode()) {
              <button 
                class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-all"
                (click)="clearDraft()"
                title="Clear form and start over"
              >
                Clear Form
              </button>
            }
          </div>

          <div class="flex items-center space-x-3">
            <button 
              class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-all"
              (click)="saveDraft()"
              [disabled]="isSaving() || organizationError()"
              [title]="organizationError() ? 'Organization setup required' : ''"
            >
              <lucide-angular [img]="SaveIcon" [size]="16" class="mr-2 inline"></lucide-angular>
              @if (isSaving()) {
                Saving...
              } @else {
                {{ getSaveButtonText() }}
              }
            </button>

            @if (currentStep() === 'review') {
              @if (organizationError()) {
                <div class="flex flex-col items-end">
                  <button 
                    class="px-6 py-2 bg-gray-300 border border-transparent rounded-lg text-sm font-medium text-gray-500 cursor-not-allowed flex items-center"
                    disabled
                    title="Organization setup required before publishing"
                  >
                    <lucide-angular [img]="AlertCircleIcon" [size]="16" class="mr-2"></lucide-angular>
                    Setup Required
                  </button>
                  <p class="text-xs text-red-600 mt-1">Complete organization setup first</p>
                </div>
              } @else {
                <button 
                  class="px-6 py-2 bg-primary-600 border border-transparent rounded-lg text-sm font-medium text-white hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 flex items-center transition-all"
                  (click)="publishOpportunity()"
                  [disabled]="!canPublish() || isPublishing()"
                >
                  @if (isPublishing()) {
                    <lucide-angular [img]="RefreshCwIcon" [size]="16" class="mr-2 animate-spin"></lucide-angular>
                    @if (isEditMode()) {
                      Saving Changes...
                    } @else {
                      Publishing...
                    }
                  } @else {
                    @if (isEditMode()) {
                      <lucide-angular [img]="SaveIcon" [size]="16" class="mr-2"></lucide-angular>
                      Save Changes
                    } @else {
                      <lucide-angular [img]="CheckIcon" [size]="16" class="mr-2"></lucide-angular>
                      Publish Opportunity
                    }
                  }
                </button>
              }
            } @else {
              <button 
                class="px-6 py-2 bg-primary-600 border border-transparent rounded-lg text-sm font-medium text-white hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 flex items-center transition-all"
                (click)="nextStep()"
                [disabled]="!canContinue()"
              >
                Continue
                <lucide-angular [img]="ArrowRightIcon" [size]="16" class="ml-2"></lucide-angular>
              </button>
            }
          </div>
        </div>
      </div>
    </div>

    <!-- Right Sidebar - AI Assistant -->
    <div class="lg:col-span-1">
      <app-ai-assistant 
        [currentStep]="currentStep()"
        [formData]="formData()"
        [completionPercentage]="getCompletionPercentage()"
      ></app-ai-assistant>
    </div>
  </div>
</div>

}
<!-- 
for the Sectors please use the data below 

Primary Agriculture – Cultivation of crops and farming of livestock for raw food and materials.

Secondary Agriculture (Agro-Processing) – Processing agricultural products into food, beverages, textiles, and other goods.

Mining and Quarrying – Extraction of minerals, metals, and natural resources from the earth.

Manufacturing – Production of goods by turning raw materials into finished products.

Construction – Building infrastructure such as homes, roads, bridges, and facilities.

Energy and Utilities – Production and supply of electricity, gas, and related energy services.

Water Supply and Waste Management – Provision of clean water, sanitation, and waste disposal.

Wholesale and Retail Trade – Buying goods in bulk for resale or selling directly to consumers.

Transport and Logistics – Movement of goods and people by road, rail, air, or sea.

Tourism and Hospitality – Services for travellers including accommodation, food, and leisure.

Information and Communication Technology (ICT) – Technology services like software, telecoms, and IT support.

Financial Services and Insurance – Banking, investment, credit, and insurance products.

Real Estate and Property – Buying, selling, and managing land, housing, and commercial properties.

Professional, Scientific, and Technical Services – Expert services such as consulting, research, and legal advice.

Education and Training – Learning institutions and skills development services.

Healthcare and Social Services – Medical care, wellness, and community support services.

Arts, Culture, and Entertainment – Creative industries like media, film, music, and cultural activities.

Public Administration and Defence – Government services, policy implementation, and defence.

Non-Profit and Community Services – Organisations focused on social, environmental, and community needs. -->