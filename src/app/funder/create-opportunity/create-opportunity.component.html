<!-- create-opportunity.component.html -->

<!-- SECTOR VALIDATION MODAL -->
@if (showSectorModal()) {
  <app-sector-validation-modal (confirmed)="onSectorValidationComplete()"></app-sector-validation-modal>
}

<!-- ORGANIZATION LOADING STATE -->
@if (organizationLoading()) {
  <div class="min-h-screen bg-neutral-50 flex items-center justify-center">
    <div class="text-center">
      <div class="animate-spin w-12 h-12 border-4 border-primary-200 border-t-primary-600 rounded-full mx-auto mb-4"></div>
      <h2 class="text-xl font-semibold text-neutral-900 mb-2">Loading Organization Data</h2>
      <p class="text-neutral-600">Setting up your opportunity creation workspace...</p>
    </div>
  </div>
}

<!-- ORGANIZATION ERROR STATE -->
@else if (organizationError() && !organizationId()) {
  <div class="min-h-screen bg-neutral-50 flex items-center justify-center px-4">
    <div class="max-w-md w-full text-center">
      <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
        <lucide-icon [img]="AlertCircleIcon" [size]="24" class="text-red-600" />
      </div>
      
      <h2 class="text-xl font-semibold text-neutral-900 mb-2">Organization Setup Required</h2>
      <p class="text-neutral-600 mb-6">{{ organizationError() }}</p>
      
      <div class="space-y-3">
        <button 
          (click)="goToOrganizationSetup()"
          class="w-full bg-primary-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-primary-700 transition-colors"
        >
          Complete Organization Setup
        </button>
        
        <button 
          (click)="retryLoadOrganization()"
          class="w-full border border-neutral-300 text-neutral-700 px-6 py-3 rounded-lg font-medium hover:bg-neutral-50 transition-colors"
        >
          <lucide-icon [img]="RefreshCwIcon" [size]="16" class="mr-2" />
          Retry Loading
        </button>
      </div>
    </div>
  </div>
}

<!-- MAIN FORM (Only show after sector validation and org loading) -->
@else if (canProceed() && !showSectorModal()) {

<div class="mx-auto p-6">
  <!-- Header -->
  <div class="mb-8">
    <div class="flex items-center justify-between mb-6">
      <div class="flex items-center space-x-3">
        <button 
          class="flex items-center text-gray-600 hover:text-gray-900 transition-colors group"
          (click)="goBack()"
        >
          <lucide-angular [img]="ArrowLeftIcon" [size]="16" class="mr-2 group-hover:-translate-x-1 transition-transform"></lucide-angular>
          @if (isEditMode()) {
            Back 
          } @else {
            Go back
          }
        </button>
      </div>
      
      <div class="flex items-center space-x-3">
        <!-- Save Status Indicators -->
        @if (showDatabaseSaveStatus()) {
          <div class="flex items-center text-sm text-green-600">
            <lucide-angular [img]="CheckIcon" [size]="14" class="mr-1"></lucide-angular>
            {{ getLastSavedText() }}
          </div>
        }
        
        @if (showLocalSaveStatus()) {
          <div class="flex items-center text-sm text-blue-600">
            <lucide-angular [img]="ClockIcon" [size]="14" class="mr-1"></lucide-angular>
            {{ getLocalSaveText() }}
          </div>
        }
        
        @if (showUnsavedIndicator()) {
          <div class="flex items-center text-sm text-orange-600">
            <lucide-angular [img]="AlertCircleIcon" [size]="14" class="mr-1"></lucide-angular>
            Unsaved changes
          </div>
        }

        <button class="px-4 py-2 text-sm text-gray-600 hover:text-gray-900 transition-colors">
          <lucide-angular [img]="EyeIcon" [size]="16" class="mr-2 inline"></lucide-angular>
          Preview
        </button>
        <button class="px-4 py-2 text-sm text-gray-600 hover:text-gray-900 transition-colors">
          <lucide-angular [img]="HelpCircleIcon" [size]="16" class="mr-2 inline"></lucide-angular>
          Help
        </button>
      </div>
    </div>
    
    <div>
      <div class="flex items-center gap-3 mb-2">
        <h1 class="text-3xl font-bold text-gray-900">{{ getPageTitle() }}</h1>
        @if (isEditMode()) {
          <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
            Editing
          </span>
        } @else {
          <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
            New Draft
          </span>
        }
      </div>
      <p class="text-gray-600">{{ getPageSubtitle() }}</p>
    </div>
  </div>

  <!-- ERROR MESSAGES SECTION -->
  @if (organizationError() || publishError()) {
    <div class="space-y-4 mb-6">
      @if (organizationError()) {
        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
          <div class="flex">
            <div class="flex-shrink-0">
              <lucide-angular [img]="AlertCircleIcon" [size]="20" class="text-red-500"></lucide-angular>
            </div>
            <div class="ml-3">
              <h3 class="text-sm font-medium text-red-800">Organization Setup Required</h3>
              <div class="mt-2 text-sm text-red-700">
                <p>{{ organizationError() }}</p>
              </div>
              <div class="mt-4 flex space-x-3">
                <button 
                  type="button"
                  class="bg-red-100 px-3 py-2 rounded-md text-sm font-medium text-red-800 hover:bg-red-200"
                  (click)="goToOrganizationSetup()"
                >
                  Complete Setup
                </button>
                <button 
                  type="button"
                  class="bg-white px-3 py-2 rounded-md text-sm font-medium text-red-800 hover:bg-red-50"
                  (click)="organizationError.set(null)"
                >
                  Dismiss
                </button>
              </div>
            </div>
          </div>
        </div>
      }

      @if (publishError()) {
        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
          <div class="flex">
            <div class="flex-shrink-0">
              <lucide-angular [img]="AlertCircleIcon" [size]="20" class="text-red-500"></lucide-angular>
            </div>
            <div class="ml-3">
              <h3 class="text-sm font-medium text-red-800">Publishing Failed</h3>
              <div class="mt-2 text-sm text-red-700">
                <p>{{ publishError() }}</p>
              </div>
              <div class="mt-4">
                <button 
                  type="button"
                  class="bg-red-100 px-3 py-2 rounded-md text-sm font-medium text-red-800 hover:bg-red-200"
                  (click)="publishError.set(null)"
                >
                  Dismiss
                </button>
              </div>
            </div>
          </div>
        </div>
      }
    </div>
  }

  <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
    <!-- Left Sidebar - EXTRACTED COMPONENT -->
    <div class="lg:col-span-1">
      <app-opportunity-steps-navigation></app-opportunity-steps-navigation>
    </div>

    <!-- Main Content Area -->
    <div class="lg:col-span-3">
      <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
        <!-- Form Header -->
        <div class="p-6 border-b border-gray-200 bg-gradient-to-r from-primary-50 to-indigo-50">
          <div class="flex items-center space-x-4">
            <div class="w-12 h-12 rounded-xl bg-primary-100 flex items-center justify-center">
              <lucide-angular [img]="getCurrentStepIcon()" [size]="24" class="text-primary-600"></lucide-angular>
            </div>
            <div>
              <h2 class="text-xl font-semibold text-gray-900">{{ getCurrentStepTitle() }}</h2>
              <p class="text-sm text-gray-600 mt-1">{{ getCurrentStepSubtitle() }}</p>
            </div>
          </div>
        </div>

        <!-- Current Step Validation Errors -->
        @if (hasCurrentStepErrors()) {
          <div class="p-4 bg-red-50 border-b border-red-200">
            <div class="flex">
              <lucide-angular [img]="AlertCircleIcon" [size]="20" class="text-red-500 mt-0.5 mr-3"></lucide-angular>
              <div>
                <h4 class="text-sm font-medium text-red-800">Please fix the following:</h4>
                <ul class="mt-2 text-sm text-red-700 space-y-1">
                  @for (error of currentStepErrors(); track error.field) {
                    <li class="flex items-center">
                      <span class="w-1.5 h-1.5 bg-red-400 rounded-full mr-2"></span>
                      {{ error.message }}
                    </li>
                  }
                </ul>
              </div>
            </div>
          </div>
        }

        <!-- Form Content -->
        <div class="p-6 space-y-8" [@stepTransition]>
          @if (currentStep() === 'basic') {
            <div class="space-y-6">
              <app-opportunity-basics></app-opportunity-basics>
              <app-media-branding></app-media-branding>
            </div>
          }

          @if (currentStep() === 'terms') {
            <app-funding-structure></app-funding-structure>
          }

          @if (currentStep() === 'eligibility') {
            <app-eligibility-filters></app-eligibility-filters>
          }

          @if (currentStep() === 'settings') {
            <app-application-settings></app-application-settings>
          }

          @if (currentStep() === 'review') {
            <div class="space-y-6">
              @if (validationErrors().length > 0) {
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                  <div class="flex">
                    <lucide-angular [img]="AlertCircleIcon" [size]="20" class="text-yellow-500 mr-3 mt-0.5"></lucide-angular>
                    <div>
                      <h4 class="text-sm font-medium text-yellow-800 mb-2">Review Required</h4>
                      <ul class="text-sm text-yellow-700 space-y-1">
                        @for (error of validationErrors(); track error.field) {
                          <li class="flex items-center">
                            <span class="w-1.5 h-1.5 bg-yellow-400 rounded-full mr-2"></span>
                            {{ error.message }}
                          </li>
                        }
                      </ul>
                    </div>
                  </div>
                </div>
              }

              <div class="bg-gray-50 rounded-xl p-6">
                <h4 class="font-medium text-gray-900 mb-4">Opportunity Summary</h4>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                  <div>
                    <span class="text-gray-500">Title:</span>
                    <div class="font-medium">{{ formData().title || 'Not specified' }}</div>
                  </div>
                  <div>
                    <span class="text-gray-500">Funding Type:</span>
                    <div class="font-medium capitalize">{{ formData().fundingType || 'Not specified' }}</div>
                  </div>
                  <div>
                    <span class="text-gray-500">Total Available:</span>
                    <div class="font-medium">{{ formData().currency }} {{ getFormattedAmount('totalAvailable') }}</div>
                  </div>
                  <div>
                    <span class="text-gray-500">Typical Investment:</span>
                    <div class="font-medium">{{ formData().currency }} {{ getFormattedAmount('offerAmount') }}</div>
                  </div>
                </div>
              </div>

              <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                <div class="flex">
                  <lucide-angular [img]="CheckIcon" [size]="20" class="text-green-500 mr-3 mt-0.5"></lucide-angular>
                  <div>
                    <h4 class="text-sm font-medium text-green-800">Ready to Publish</h4>
                    <p class="mt-1 text-sm text-green-700">
                      Once published, qualified SMEs can view and apply. You can edit or pause anytime.
                    </p>
                  </div>
                </div>
              </div>
            </div>
          }
        </div>

        <!-- Form Actions -->
        <div class="px-6 py-4 bg-gray-50 border-t border-gray-200 flex items-center justify-between">
          <div class="flex items-center space-x-3">
            <button 
              class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 transition-all"
              [disabled]="currentStep() === 'basic'"
              (click)="previousStep()"
            >
              <lucide-angular [img]="ArrowLeftIcon" [size]="16" class="mr-2 inline"></lucide-angular>
              Previous
            </button>
            
            <button 
              class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 transition-all"
              (click)="goBack()"
            >
              Cancel
            </button>

            @if (isCreateMode()) {
              <button 
                class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 transition-all"
                (click)="clearDraft()"
                title="Clear form and start over"
              >
                Clear Form
              </button>
            }
          </div>

          <div class="flex items-center space-x-3">
            <button 
              class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 transition-all"
              (click)="saveDraft()"
              [disabled]="isSaving() || organizationError()"
            >
              <lucide-angular [img]="SaveIcon" [size]="16" class="mr-2 inline"></lucide-angular>
              {{ isSaving() ? 'Saving...' : getSaveButtonText() }}
            </button>

            @if (currentStep() === 'review') {
              <button 
                class="px-6 py-2 bg-primary-600 border border-transparent rounded-lg text-sm font-medium text-white hover:bg-primary-700 transition-all flex items-center"
                (click)="publishOpportunity()"
                [disabled]="!canPublish() || isPublishing()"
              >
                @if (isPublishing()) {
                  <lucide-angular [img]="RefreshCwIcon" [size]="16" class="mr-2 animate-spin"></lucide-angular>
                  {{ isEditMode() ? 'Saving Changes...' : 'Publishing...' }}
                } @else {
                  <lucide-angular [img]="CheckIcon" [size]="16" class="mr-2"></lucide-angular>
                  {{ isEditMode() ? 'Save Changes' : 'Publish Opportunity' }}
                }
              </button>
            } @else {
              <button 
                class="px-6 py-2 bg-primary-600 border border-transparent rounded-lg text-sm font-medium text-white hover:bg-primary-700 transition-all flex items-center"
                (click)="nextStep()"
                [disabled]="!canContinue()"
              >
                Continue
                <lucide-angular [img]="ArrowRightIcon" [size]="16" class="ml-2"></lucide-angular>
              </button>
            }
          </div>
        </div>
      </div>
    </div>

    <!-- Right Sidebar - Placeholder for future AI Assistant -->
    <div class="lg:col-span-1">
      <!-- Future: AI Assistant Component -->
    </div>
  </div>
</div>

}