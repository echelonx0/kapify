<!-- src/app/funder/components/application-detail/application-detail.component.html - REFACTORED -->

<!-- Application Header Component -->
@if (application()) {

  <div class="sticky top-0 z-10 bg-neutral-50 border-b border-gray-200">
  
    
 

  <app-application-header
    [application]="application()!"
    [profileLoading]="profileLoading()"
    [profileError]="profileError()"
    [hasCompleteData]="hasCompleteDataForAnalysis()"
    (back)="goBack()"
    (manageStatus)="openStatusModal()">
  </app-application-header>
   </div>
}

<div class="max-w-7xl mx-auto px-6 py-6">
  
  <!-- CRITICAL ERROR STATE -->
  @if (error()) {
    <div class="flex items-center justify-center min-h-96">
      <div class="card max-w-md w-full">
        <div class="p-8 text-center">
          <lucide-icon [img]="AlertCircleIcon" [size]="48" class="text-red-500 mx-auto mb-4"></lucide-icon>
          <h2 class="text-xl font-semibold text-gray-900 mb-2">Unable to Load Application</h2>
          <p class="text-gray-600 mb-6">{{ error() }}</p>
          <button 
            (click)="goBack()"
            class="w-full bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-lg font-medium"
          >
            Return to Applications
          </button>
        </div>
      </div>
    </div>
  } @else if (isLoading()) {
    
    <!-- LOADING STATE -->
    <div class="flex items-center justify-center min-h-96">
      <div class="text-center">
        <lucide-icon [img]="Loader2Icon" [size]="48" class="animate-spin text-primary-600 mx-auto mb-4"></lucide-icon>
        <h2 class="text-xl font-semibold text-gray-900 mb-2">Loading Application</h2>
        <p class="text-gray-600">Fetching application and profile data...</p>
      </div>
    </div>
    
  } @else {
    
    <!-- MAIN CONTENT -->
    
    <!-- PROFILE ERROR WARNING -->
    @if (profileError()) {
      <div class="card border-orange-200 bg-orange-50 mb-6">
        <div class="p-4">
          <div class="flex items-start space-x-3">
            <lucide-icon [img]="AlertCircleIcon" [size]="20" class="text-orange-600 mt-0.5"></lucide-icon>
            <div class="flex-1">
              <h3 class="text-sm font-medium text-orange-800">Profile Data Unavailable</h3>
              <p class="text-sm text-orange-700 mt-1">{{ profileError() }}</p>
              <p class="text-xs text-orange-600 mt-2">
                AI analysis will be limited without complete profile data.
              </p>
            </div>
            <button 
              (click)="retryProfileLoading()"
              [disabled]="profileLoading()"
              class="text-orange-600 hover:text-orange-800 text-sm font-medium disabled:opacity-50"
            >
              @if (profileLoading()) {
                <lucide-icon [img]="Loader2Icon" [size]="14" class="animate-spin"></lucide-icon>
              } @else {
                Retry
              }
            </button>
          </div>
        </div>
      </div>
    }

    <div class="grid grid-cols-12 gap-6">
      
      <!-- Main Content Area -->
      <div class="col-span-8 space-y-6">
        
        <!-- AI-Powered Executive Summary -->
        <div class="gradient-border">
          @if (hasCompleteDataForAnalysis()) {
            <app-ai-executive-summary 
              [application]="application()!" 
              [opportunity]="opportunity()!">
            </app-ai-executive-summary>
          } @else if (profileLoading()) {
            <div class="gradient-content">
              <div class="flex items-center justify-center py-8">
                <lucide-icon [img]="Loader2Icon" [size]="24" class="animate-spin text-purple-600 mr-2"></lucide-icon>
                <span class="text-gray-600">Preparing AI analysis...</span>
              </div>
            </div>
          } @else {
            <div class="gradient-content">
              <div class="flex items-center justify-center py-8 text-orange-600">
                <lucide-icon [img]="AlertCircleIcon" [size]="20" class="mr-2"></lucide-icon>
                <span>AI analysis unavailable without complete profile data</span>
              </div>
            </div>
          }
        </div>

        <!-- Enhanced Application Details -->  
        <div class="card">
          <div class="p-6">
            <div class="flex items-center justify-between mb-6">
              <h2 class="text-lg font-semibold text-gray-900">Application Details</h2>
            </div>

            <app-application-metrics
              [application]="application()!"
              [opportunity]="opportunity()!">
            </app-application-metrics>
          </div>
        </div>

        <!-- Applicant Profile with AI Insights -->
        <div class="card">
          @if (hasCompleteDataForAnalysis()) {
            <app-applicant-profile 
              [application]="application()!" 
              [applicant]="application()!.applicant">
            </app-applicant-profile>
          } @else if (profileLoading()) {
            <div class="p-6">
              <div class="flex items-center justify-center py-8">
                <lucide-icon [img]="Loader2Icon" [size]="24" class="animate-spin text-blue-600 mr-2"></lucide-icon>
                <span class="text-gray-600">Loading applicant profile...</span>
              </div>
            </div>
          } @else {
            <div class="p-6">
              <div class="flex items-center justify-center py-8 text-orange-600">
                <lucide-icon [img]="AlertCircleIcon" [size]="20" class="mr-2"></lucide-icon>
                <span>Applicant profile unavailable</span>
              </div>
            </div>
          }
        </div>

        <!-- Application Tabs -->
        <div class="mt-4">
          @if (application() && opportunity()) {
            <app-application-tabs
              [application]="application()!"
              [opportunity]="opportunity()!"
              (marketResearchRequested)="onMarketResearchRequested()">
            </app-application-tabs>
          }
        </div>
      </div>

      <!-- AI Assistant Column -->
      <div class="col-span-4">
        <div class="sticky top-24">
          @if (hasCompleteDataForAnalysis()) {
            <app-ai-assistant>
            </app-ai-assistant>
          } @else if (profileLoading()) {
            <div class="card">
              <div class="p-6 text-center">
                <lucide-icon [img]="Loader2Icon" [size]="32" class="animate-spin text-purple-600 mx-auto mb-4"></lucide-icon>
                <h3 class="font-medium text-gray-900 mb-2">Preparing AI Assistant</h3>
                <p class="text-sm text-gray-600">Loading profile data for comprehensive analysis...</p>
              </div>
            </div>
          } @else {
            <div class="card border-orange-200 bg-orange-50">
              <div class="p-6 text-center">
                <lucide-icon [img]="BotIcon" [size]="32" class="text-orange-600 mx-auto mb-4"></lucide-icon>
                <h3 class="font-medium text-orange-800 mb-2">AI Assistant Unavailable</h3>
                <p class="text-sm text-orange-700 mb-4">
                  Complete profile data is required for AI-powered analysis and recommendations.
                </p>
                @if (profileError()) {
                  <button 
                    (click)="retryProfileLoading()"
                    [disabled]="profileLoading()"
                    class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg text-sm font-medium disabled:opacity-50"
                  >
                    @if (profileLoading()) {
                      <lucide-icon [img]="Loader2Icon" [size]="14" class="animate-spin mr-2"></lucide-icon>
                    }
                    Retry Loading
                  </button>
                }
              </div>
            </div>
          }
        </div>
      </div> 
    </div>
  }
</div>

<!-- Status Management Modal -->
@if (application()) {
  <app-status-management-modal
    [application]="application()!"
    [isOpen]="showStatusModal()"
    (close)="closeStatusModal()"
    (actionCompleted)="onStatusActionCompleted()">
  </app-status-management-modal>
}