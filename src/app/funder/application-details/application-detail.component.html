<!-- src/app/funder/components/application-detail/application-detail.component.html -->

<header class="bg-white border-b border-gray-200 sticky top-0 z-40">
  <div class="max-w-7xl mx-auto px-6 py-4">
    <div class="flex items-center justify-between">
      <div class="flex items-center space-x-4">
        <button 
          (click)="goBack()"
          class="flex items-center space-x-2 text-gray-600 hover:text-gray-900 transition-colors"
        >
          <lucide-icon [img]="ArrowLeftIcon" [size]="16"></lucide-icon>
          <span class="font-medium">Back to Applications</span>
        </button>
        <div class="h-6 w-px bg-gray-300"></div>
        <div>
          @if (application()) {
     
            <div class="flex items-center space-x-4 mt-1">
              <span [class]="getStatusBadgeClass(application()!.status)">
                {{ getStatusText(application()!.status) }}
              </span>
              <span class="text-sm text-gray-500">
                {{ formatDate(application()!.submittedAt || application()!.createdAt) }}
              </span>
            </div>
          }
        </div>
      </div>
      
      <!-- AI-Powered Decision Actions -->
      <div class="flex items-center space-x-3">
        <!-- Profile Loading Status Indicator -->
        @if (profileLoading()) {
          <div class="flex items-center space-x-2 text-sm">
            <lucide-icon [img]="Loader2Icon" [size]="14" class="animate-spin text-blue-500"></lucide-icon>
            <span class="text-gray-600">Loading Profile...</span>
          </div>
        } @else if (profileError()) {
          <div class="flex items-center space-x-2 text-sm">
            <lucide-icon [img]="AlertCircleIcon" [size]="14" class="text-red-500"></lucide-icon>
            <span class="text-red-600">Profile Error</span>
          </div>
        } @else if (hasCompleteDataForAnalysis()) {
          <div class="flex items-center space-x-2 text-sm">
            <div class="w-2 h-2 bg-green-500 rounded-full"></div>
            <span class="text-gray-600">AI Analysis Ready</span>
          </div>
        }

        <!-- Action Buttons - Only show if we have complete data -->
        @if (hasCompleteDataForAnalysis() && canUpdateStatus()) {
          <button 
            (click)="openStatusModal('approved')"
            [disabled]="isUpdatingStatus()"
            class="decision-button bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium flex items-center space-x-2 disabled:opacity-50"
          >
            <lucide-icon [img]="CheckCircleIcon" [size]="16"></lucide-icon>
            <span>Approve</span>
          </button>
          <button 
            (click)="openStatusModal('rejected')"
            [disabled]="isUpdatingStatus()"
            class="decision-button bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-medium flex items-center space-x-2 disabled:opacity-50"
          >
            <lucide-icon [img]="XCircleIcon" [size]="16"></lucide-icon>
            <span>Reject</span>
          </button>
        }
      </div>
    </div>
  </div>
</header>

<div class="max-w-7xl mx-auto px-6 py-6">
  <!-- CRITICAL ERROR STATE - Blocks all functionality -->
  @if (error()) {
    <div class="flex items-center justify-center min-h-96">
      <div class="card max-w-md w-full">
        <div class="p-8 text-center">
          <lucide-icon [img]="AlertCircleIcon" [size]="48" class="text-red-500 mx-auto mb-4"></lucide-icon>
          <h2 class="text-xl font-semibold text-gray-900 mb-2">Unable to Load Application</h2>
          <p class="text-gray-600 mb-6">{{ error() }}</p>
          <button 
            (click)="goBack()"
            class="w-full bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-lg font-medium"
          >
            Return to Applications
          </button>
        </div>
      </div>
    </div>
  } @else if (isLoading()) {
    <!-- LOADING STATE -->
    <div class="flex items-center justify-center min-h-96">
      <div class="text-center">
        <lucide-icon [img]="Loader2Icon" [size]="48" class="animate-spin text-primary-600 mx-auto mb-4"></lucide-icon>
        <h2 class="text-xl font-semibold text-gray-900 mb-2">Loading Application</h2>
        <p class="text-gray-600">Fetching application and profile data...</p>
      </div>
    </div>
  } @else {
    <!-- MAIN CONTENT - Only shows when application is loaded -->
    
    <!-- PROFILE ERROR WARNING - Non-blocking but important -->
    @if (profileError()) {
      <div class="card border-orange-200 bg-orange-50 mb-6">
        <div class="p-4">
          <div class="flex items-start space-x-3">
            <lucide-icon [img]="AlertCircleIcon" [size]="20" class="text-orange-600 mt-0.5"></lucide-icon>
            <div class="flex-1">
              <h3 class="text-sm font-medium text-orange-800">Profile Data Unavailable</h3>
              <p class="text-sm text-orange-700 mt-1">{{ profileError() }}</p>
              <p class="text-xs text-orange-600 mt-2">
                AI analysis will be limited without complete profile data.
              </p>
            </div>
            <button 
              (click)="retryProfileLoading()"
              [disabled]="profileLoading()"
              class="text-orange-600 hover:text-orange-800 text-sm font-medium disabled:opacity-50"
            >
              @if (profileLoading()) {
                <lucide-icon [img]="Loader2Icon" [size]="14" class="animate-spin"></lucide-icon>
              } @else {
                Retry
              }
            </button>
          </div>
        </div>
      </div>
    }

    <div class="grid grid-cols-12 gap-6">
      
      <!-- Main Content Area -->
      <div class="col-span-8 space-y-6">
        
        <!-- AI-Powered Executive Summary -->
        <div class="gradient-border">
          @if (hasCompleteDataForAnalysis()) {
            <app-ai-executive-summary 
              [application]="application()!" 
              [opportunity]="opportunity()!">
            </app-ai-executive-summary>
          } @else if (profileLoading()) {
            <div class="gradient-content">
              <div class="flex items-center justify-center py-8">
                <lucide-icon [img]="Loader2Icon" [size]="24" class="animate-spin text-purple-600 mr-2"></lucide-icon>
                <span class="text-gray-600">Preparing AI analysis...</span>
              </div>
            </div>
          } @else {
            <div class="gradient-content">
              <div class="flex items-center justify-center py-8 text-orange-600">
                <lucide-icon [img]="AlertCircleIcon" [size]="20" class="mr-2"></lucide-icon>
                <span>AI analysis unavailable without complete profile data</span>
              </div>
            </div>
          }
        </div>

        <!-- Enhanced Application Details -->  
        <div class="card">
          <div class="p-6">
            <div class="flex items-center justify-between mb-6">
              <h2 class="text-lg font-semibold text-gray-900">Application Details</h2>
              @if (hasCompleteDataForAnalysis()) {
                <button class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                  Generate Summary Report
                </button>
              }
            </div>

            <div class="grid grid-cols-2 gap-8">
              <div class="space-y-6">
                <!-- Project Description -->
                <div>
                  <h3 class="text-sm font-medium text-gray-700 mb-2">Project Description</h3>
                  <p class="text-gray-900 leading-relaxed">
                    {{ application()!.description || 'No description provided' }}
                  </p>
                </div>

                <!-- Use of Funds - from form data -->
                @if (getUseOfFunds()) {
                  <div>
                    <h3 class="text-sm font-medium text-gray-700 mb-2">Use of Funds</h3>
                    <div class="bg-gray-50 rounded-lg p-4">
                      <p class="text-gray-900 leading-relaxed">{{ getUseOfFunds() }}</p>
                    </div>
                  </div>
                }

                <!-- Additional Form Data -->
                @if (hasFormData()) {
                  <div>
                    <h3 class="text-sm font-medium text-gray-700 mb-2">Additional Details</h3>
                    <div class="space-y-3">
                      @for (entry of getFormDataEntries(); track entry.key) {
                        @if (entry.value && entry.value !== '' && entry.key !== 'requestedAmount' && entry.key !== 'useOfFunds') {
                          <div class="bg-gray-50 rounded-lg p-3">
                            <div class="flex justify-between items-start">
                              <span class="text-gray-600 text-sm font-medium">{{ formatFieldName(entry.key) }}</span>
                              <span class="text-gray-900 text-sm max-w-xs text-right">{{ entry.value }}</span>
                            </div>
                          </div>
                        }
                      }
                    </div>
                  </div>
                }
              </div>

              <div class="space-y-6">
                <!-- Key Metrics from Real Data -->
                <div class="bg-gray-50 rounded-lg p-4">
                  <h3 class="font-medium text-gray-900 mb-3">Key Metrics</h3>
                  <div class="space-y-3">
                    @if (getRequestedAmount()) {
                      <div class="flex justify-between">
                        <span class="text-gray-600">Requested Amount</span>
                        <span class="font-bold text-gray-900">{{ formatCurrency(getRequestedAmount()!) }}</span>
                      </div>
                    }
                    
                    @if (getTimeline()) {
                      <div class="flex justify-between">
                        <span class="text-gray-600">Project Timeline</span>
                        <span class="font-medium text-gray-900">{{ getTimeline() }}</span>
                      </div>
                    }
                    
                    @if (opportunity()) {
                      <div class="flex justify-between">
                        <span class="text-gray-600">Funding Type</span>
                        <span class="font-medium text-gray-900">{{ opportunity()!.fundingType }}</span>
                      </div>
                      
                      <div class="flex justify-between">
                        <span class="text-gray-600">Max Available</span>
                        <span class="font-medium text-gray-900">{{ formatCurrency(opportunity()!.offerAmount) }}</span>
                      </div>
                      
                      @if (opportunity()!.currency) {
                        <div class="flex justify-between">
                          <span class="text-gray-600">Currency</span>
                          <span class="font-medium text-gray-900">{{ opportunity()!.currency }}</span>
                        </div>
                      }
                    }
                    
                    @if (application()!.applicant?.industry) {
                      <div class="flex justify-between">
                        <span class="text-gray-600">Industry</span>
                        <span class="font-medium text-gray-900">{{ application()!.applicant!.industry }}</span>
                      </div>
                    }
                  </div>
                </div>

                <!-- Application Timeline -->
                <div class="bg-gray-50 rounded-lg p-4">
                  <h3 class="font-medium text-gray-900 mb-3">Timeline</h3>
                  <div class="space-y-3">
                    <div class="flex justify-between">
                      <span class="text-gray-600">Created</span>
                      <span class="font-medium text-gray-900 text-sm">{{ formatDate(application()!.createdAt) }}</span>
                    </div>
                    
                    @if (application()!.submittedAt) {
                      <div class="flex justify-between">
                        <span class="text-gray-600">Submitted</span>
                        <span class="font-medium text-gray-900 text-sm">{{ formatDate(application()!.submittedAt) }}</span>
                      </div>
                    }
                    
                    @if (application()!.reviewStartedAt) {
                      <div class="flex justify-between">
                        <span class="text-gray-600">Review Started</span>
                        <span class="font-medium text-gray-900 text-sm">{{ formatDate(application()!.reviewStartedAt) }}</span>
                      </div>
                    }
                    
                    @if (application()!.decidedAt) {
                      <div class="flex justify-between">
                        <span class="text-gray-600">Decision</span>
                        <span class="font-medium text-gray-900 text-sm">{{ formatDate(application()!.decidedAt) }}</span>
                      </div>
                    }
                    
                    <div class="flex justify-between border-t pt-3">
                      <span class="text-gray-600">Last Updated</span>
                      <span class="font-medium text-gray-900 text-sm">{{ formatDate(application()!.updatedAt) }}</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Applicant Profile with AI Insights -->
        <div class="card">
          @if (hasCompleteDataForAnalysis()) {
            <app-applicant-profile 
              [application]="application()!" 
              [applicant]="application()!.applicant">
            </app-applicant-profile>
          } @else if (profileLoading()) {
            <div class="p-6">
              <div class="flex items-center justify-center py-8">
                <lucide-icon [img]="Loader2Icon" [size]="24" class="animate-spin text-blue-600 mr-2"></lucide-icon>
                <span class="text-gray-600">Loading applicant profile...</span>
              </div>
            </div>
          } @else {
            <div class="p-6">
              <div class="flex items-center justify-center py-8 text-orange-600">
                <lucide-icon [img]="AlertCircleIcon" [size]="20" class="mr-2"></lucide-icon>
                <span>Applicant profile unavailable</span>
              </div>
            </div>
          }
        </div>

        <!-- Application Tabs -->
        <div class="mt-4">
          @if (application() && opportunity()) {
            <app-application-tabs
              [application]="application()!"
              [opportunity]="opportunity()!"
              (marketResearchRequested)="onMarketResearchRequested()">
            </app-application-tabs>
          }
        </div>
      </div>

      <!-- AI Assistant Column -->
      <div class="col-span-4">
        <div class="sticky top-24">
          @if (hasCompleteDataForAnalysis()) {
            <app-ai-assistant>
            </app-ai-assistant>
          } @else if (profileLoading()) {
            <div class="card">
              <div class="p-6 text-center">
                <lucide-icon [img]="Loader2Icon" [size]="32" class="animate-spin text-purple-600 mx-auto mb-4"></lucide-icon>
                <h3 class="font-medium text-gray-900 mb-2">Preparing AI Assistant</h3>
                <p class="text-sm text-gray-600">Loading profile data for comprehensive analysis...</p>
              </div>
            </div>
          } @else {
            <div class="card border-orange-200 bg-orange-50">
              <div class="p-6 text-center">
                <lucide-icon [img]="BotIcon" [size]="32" class="text-orange-600 mx-auto mb-4"></lucide-icon>
                <h3 class="font-medium text-orange-800 mb-2">AI Assistant Unavailable</h3>
                <p class="text-sm text-orange-700 mb-4">
                  Complete profile data is required for AI-powered analysis and recommendations.
                </p>
                @if (profileError()) {
                  <button 
                    (click)="retryProfileLoading()"
                    [disabled]="profileLoading()"
                    class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg text-sm font-medium disabled:opacity-50"
                  >
                    @if (profileLoading()) {
                      <lucide-icon [img]="Loader2Icon" [size]="14" class="animate-spin mr-2"></lucide-icon>
                    }
                    Retry Loading
                  </button>
                }
              </div>
            </div>
          }
        </div>
      </div> 
    </div>
  }
</div>

<!-- Status Update Modal -->
@if (showStatusModal()) {
  <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
      <div class="p-6">
        <h3 class="text-lg font-medium text-gray-900 mb-4">
          {{ pendingStatus() === 'approved' ? 'Approve Application' : 'Reject Application' }}
        </h3>
        
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">
            Comment (optional)
          </label>
          <textarea
            [value]="statusComment()"
            (input)="onStatusCommentInput($event)"
            rows="3"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
            placeholder="Add a comment about your decision..."
          ></textarea>
        </div>
        
        <div class="flex justify-end space-x-3">
          <button
            (click)="closeStatusModal()"
            [disabled]="isUpdatingStatus()"
            class="px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg font-medium disabled:opacity-50"
          >
            Cancel
          </button>
          <button
            (click)="confirmStatusUpdate()"
            [disabled]="isUpdatingStatus()"
            [class]="pendingStatus() === 'approved' 
              ? 'px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium disabled:opacity-50'
              : 'px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium disabled:opacity-50'"
          >
            @if (isUpdatingStatus()) {
              <lucide-icon [img]="Loader2Icon" [size]="16" class="animate-spin mr-2"></lucide-icon>
            }
            {{ pendingStatus() === 'approved' ? 'Approve' : 'Reject' }}
          </button>
        </div>
      </div>
    </div>
  </div>
}